<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Akashic Loot Records</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0F172A">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/core-js-bundle@3.37.1/minified.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        :root {
            --loot-bg: #0F172A;
            --loot-gold: #F59E0B;
            --loot-purple: #8B5CF6;
            --loot-text: #F8FAFC;
        }
        body { background-color: var(--loot-bg); color: var(--loot-text); font-family: ui-serif, Georgia, Cambria, "Times New Roman", Times, serif; }
        
        .gold-gradient-text {
            background: linear-gradient(to bottom, #FCD34D, #F59E0B);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .loot-card {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid #475569;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        /* Floating Button Style */
        .floating-button { z-index: 90; position: fixed; bottom: 20px; right: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }

        /* Coin Spin Animation */
        @keyframes flip { 0% { transform: rotateY(0); } 100% { transform: rotateY(360deg); } }
        .animate-flip { animation: flip 2s infinite linear; }
        
        .rarity-common { color: #94a3b8; }
        .rarity-uncommon { color: #10b981; }
        .rarity-rare { color: #3b82f6; }
        .rarity-epic { color: #a855f7; }
        .rarity-legendary { color: #f59e0b; text-shadow: 0 0 10px rgba(245, 158, 11, 0.5); }
        
        input, select, textarea {
            background-color: #1e293b;
            border: 1px solid #475569;
            color: white;
            padding: 8px;
            border-radius: 6px;
            width: 100%;
            margin-bottom: 8px;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #8B5CF6;
        }
        
        /* Animation classes */
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- DROPDOWN MENU STYLES --- */
        .suite-item {
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        /* Tracker: Purple */
        .tracker-hover:hover { 
            border-left-color: #A855F7; 
            background: linear-gradient(90deg, rgba(168, 85, 247, 0.1), transparent);
            color: #d8b4fe;
        }
        .tracker-hover:hover svg { stroke: #A855F7; }

        /* Atlas: Light Blue (Cyan) */
        .map-hover:hover { 
            border-left-color: #22D3EE; 
            background: linear-gradient(90deg, rgba(34, 211, 238, 0.1), transparent);
            color: #67e8f9;
        }
        .map-hover:hover svg { stroke: #22D3EE; }

        /* Records: Red */
        .sheet-hover:hover { 
            border-left-color: #EF4444; 
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.1), transparent);
            color: #fca5a5;
        }
        .sheet-hover:hover svg { stroke: #EF4444; }

        /* Workshop: Green */
        .workshop-hover:hover { 
            border-left-color: #22C55E; 
            background: linear-gradient(90deg, rgba(34, 197, 94, 0.1), transparent);
            color: #86efac;
        }
        .workshop-hover:hover svg { stroke: #22C55E; }

        /* Loot: Gold */
        .loot-hover:hover { 
            border-left-color: #F59E0B; 
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.1), transparent);
            color: #fcd34d;
        }
        .loot-hover:hover svg { stroke: #F59E0B; }

        /* Campaign: Slate/Grey */
        .campaign-hover:hover { 
            border-left-color: #94A3B8; 
            background: linear-gradient(90deg, rgba(148, 163, 184, 0.1), transparent);
            color: #e2e8f0;
        }
        .campaign-hover:hover svg { stroke: #94A3B8; }

        /* Compendium: Indigo */
        .compendium-hover:hover { 
            border-left-color: #6366F1; 
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.1), transparent);
            color: #a5b4fc;
        }
        .compendium-hover:hover svg { stroke: #6366F1; }
    </style>
</head>
<body class="min-h-screen bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-900 via-slate-950 to-black">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- ICONS ---
        const Icon = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Coins = (props) => <Icon {...props}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7.71-2.82 2.82"/></Icon>;
        const Gem = (props) => <Icon {...props}><path d="M6 3h12l4 6-10 13L2 9Z"/><path d="M11 3 8 9l4 13 4-13-3-6"/><path d="M2 9h20"/></Icon>;
        const Scroll = (props) => <Icon {...props}><path d="M19 17V5a2 2 0 0 0-2-2H4"/><path d="M8 21h12a2 2 0 0 0 2-2v-2H10v2a2 2 0 1 1-4 0V5a2 2 0 1 0-4 0v3h4"/></Icon>;
        const Skull = (props) => <Icon {...props}><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="m12.5 17-.5-1-.5 1h1z"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/></Icon>;
        const RefreshCw = (props) => <Icon {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></Icon>;
        const ArrowLeft = (props) => <Icon {...props}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></Icon>;
        const Archive = (props) => <Icon {...props}><rect width="20" height="5" x="2" y="3" rx="1"/><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/><path d="M10 12h4"/></Icon>;
        const Sword = (props) => <Icon {...props}><path d="M12 2l2 4h-4l2-4z" /><path d="M12 6v7" /><path d="M8 13h8" /><path d="M12 13v6" /><path d="M10 21h4" /></Icon>;
        const Shield = (props) => <Icon {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /></Icon>;
        const Wand = (props) => <Icon {...props}><path d="M3 21l12-12l1.5 1.5l-12 12z" /><path d="M19 2l1 2 2 1-2 1-1 2-1-2-2-1 2-1z" /></Icon>;
        const FlaskConical = (props) => <Icon {...props}><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2" /><path d="M8.5 2h7" /><path d="M7 16h10" /></Icon>;
        const Trash2 = (props) => <Icon {...props}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></Icon>;
        const Hammer = (props) => <Icon {...props}><path d="M6 5h12v4h-12z" /><path d="M12 9v12" /><path d="M10 21h4" /></Icon>;
        const Plus = (props) => <Icon {...props}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>;
        const Settings = (props) => <Icon {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></Icon>;
        const Key = (props) => <Icon {...props}><path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" /></Icon>;
        const X = (props) => <Icon {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>;
        const Sparkles = (props) => <Icon {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.276 1.276L3 12l5.813 1.912a2 2 0 0 1 1.276-1.276L12 21l1.912-5.813a2 2 0 0 1 1.276-1.276L21 12l-5.813-1.912a2 2 0 0 1-1.276-1.276Z" /></Icon>;
        const CastleGate = (props) => (<Icon {...props}><path d="M19 21v-8a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v8"/><path d="M4 11V7"/><path d="M20 11V7"/><path d="M2 7h4v4H2z"/><path d="M18 7h4v4h-4z"/><path d="M4 7l2-4 2 4"/><path d="M18 7l2-4 2 4"/><path d="M10 21v-4a2 2 0 0 1 4 0v4"/></Icon>);
        const Home = (props) => <Icon {...props}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></Icon>; 
        const Info = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></Icon>;
        const Download = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></Icon>;
        const Upload = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></Icon>;
        const AlertTriangle = (props) => <Icon {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></Icon>;
        const Box = (props) => <Icon {...props}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></Icon>;
        const MapIcon = (props) => <Icon {...props}><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6" /><line x1="8" y1="2" x2="8" y2="18" /><line x1="16" y1="6" x2="16" y2="22" /></Icon>;
        // Added icons for Dropdown
        const ChevronDown = (props) => <Icon {...props}><path d="m6 9 6 6 6-6"/></Icon>;
        const Crosshair = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></Icon>;
        const User = (props) => <Icon {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></Icon>;
        const Flag = (props) => <Icon {...props}><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" x2="4" y1="22" y2="15"/></Icon>;
        const BookOpen = (props) => <Icon {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></Icon>;


        // --- LOOT TABLES ---
        const LOOT_TABLE = {
            low: [
                { name: "Pouch of Copper", type: "currency", val: "4d6 cp", rarity: "common", description: "A simple pouch containing loose change." },
                { name: "Agate Gem", type: "gem", val: "10 gp", rarity: "uncommon", description: "A translucent gemstone with banded colors." },
                { name: "Rusty Dagger", type: "weapon", val: "1 gp", rarity: "common", description: "Stats: 1d4 Piercing. Finesse, Light." },
                { name: "Healing Potion", type: "potion", val: "50 gp", rarity: "uncommon", description: "Restores 2d4 + 2 HP." },
                { name: "Leather Armor", type: "armor", val: "10 gp", rarity: "common", description: "AC: 11 + Dex Modifier." }
            ],
            med: [
                { name: "Sack of Silver", type: "currency", val: "2d8 sp", rarity: "common", description: "A heavy sack of silver coins." },
                { name: "Gold Ring", type: "art", val: "25 gp", rarity: "rare", description: "A simple but elegant gold ring." },
                { name: "Scroll of Magic Missile", type: "magic", val: "100 gp", rarity: "uncommon", description: "Single use spell scroll." },
                { name: "+1 Arrow", type: "weapon", val: "5 gp", rarity: "uncommon", description: "Stats: +1 to Attack/Damage rolls." },
                { name: "Chain Shirt", type: "armor", val: "50 gp", rarity: "uncommon", description: "AC: 13 + Dex Modifier (max 2)." },
                { name: "Wand of Secrets", type: "magic", val: "Uncommon", rarity: "uncommon", description: "3 charges. Detects secret doors." }
            ],
            high: [
                { name: "Chest of Gold", type: "currency", val: "4d10 gp", rarity: "uncommon", description: "A sturdy chest filled with gold." },
                { name: "Diamond", type: "gem", val: "300 gp", rarity: "epic", description: "A flawless clear gemstone." },
                { name: "Cloak of Protection", type: "magic", val: "500 gp", rarity: "rare", description: "+1 to AC and Saving Throws." },
                { name: "Vorpal Sword Fragment", type: "quest", val: "???", rarity: "legendary", description: "A shard of a legendary blade." },
                { name: "Plate Armor", type: "armor", val: "1500 gp", rarity: "rare", description: "AC: 18. Str 15 Req. Stealth Disadvantage." },
                { name: "Supreme Healing Potion", type: "potion", val: "1350 gp", rarity: "rare", description: "Restores 10d4 + 20 HP." }
            ]
        };
        
        // --- SUITE DROPDOWN COMPONENT ---
        const SuiteDropdown = () => {
            const [isOpen, setIsOpen] = useState(false);
            const dropdownRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => {
                    document.removeEventListener("mousedown", handleClickOutside);
                };
            }, []);

            return (
                <div className="relative" ref={dropdownRef}>
                    <button 
                        onClick={() => setIsOpen(!isOpen)}
                        className={`flex items-center gap-2 px-4 py-2 rounded-lg hover:bg-white/5 transition-colors text-slate-300 hover:text-white border border-transparent hover:border-white/10 ${isOpen ? 'bg-white/10 text-white' : ''}`}
                    >
                        <span className="text-sm font-medium">Suite Apps</span>
                        <ChevronDown size={14} className={`transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}`}/>
                    </button>
                    
                    <div className={`absolute top-full right-0 mt-2 w-64 bg-slate-900/95 backdrop-blur-xl rounded-xl shadow-2xl border border-slate-700 overflow-hidden py-2 flex flex-col gap-1 z-[100] transition-all duration-200 origin-top-right ${isOpen ? 'opacity-100 scale-100 translate-y-0 pointer-events-auto' : 'opacity-0 scale-95 -translate-y-2 pointer-events-none'}`}>
                        <div className="px-4 py-2 text-[10px] font-bold text-slate-500 uppercase tracking-wider">Navigation</div>

                        {/* Tracker (Purple) */}
                        <a href="./tome.html" className="suite-item tracker-hover flex items-center gap-3 px-4 py-3 text-slate-300 hover:bg-slate-800/50">
                            <Crosshair size={18} className="text-slate-400" />
                            <div className="flex flex-col">
                                <span className="text-sm font-bold">Tracker</span>
                                <span className="text-[10px] opacity-60">Initiative & Combat</span>
                            </div>
                        </a>

                        {/* Atlas (Cyan) */}
                        <a href="./map.html" className="suite-item map-hover flex items-center gap-3 px-4 py-3 text-slate-300 hover:bg-slate-800/50">
                            <MapIcon size={18} className="text-slate-400" />
                            <div className="flex flex-col">
                                <span className="text-sm font-bold">Atlas</span>
                                <span className="text-[10px] opacity-60">Tactical Maps</span>
                            </div>
                        </a>

                        {/* Records (Red) */}
                        <a href="./sheet.html" className="suite-item sheet-hover flex items-center gap-3 px-4 py-3 text-slate-300 hover:bg-slate-800/50">
                            <User size={18} className="text-slate-400" />
                            <div className="flex flex-col">
                                <span className="text-sm font-bold">Records</span>
                                <span className="text-[10px] opacity-60">Character Sheets</span>
                            </div>
                        </a>

                        {/* Workshop (Green) */}
                        <a href="./homebrew.html" className="suite-item workshop-hover flex items-center gap-3 px-4 py-3 text-slate-300 hover:bg-slate-800/50">
                            <Hammer size={18} className="text-slate-400" />
                            <div className="flex flex-col">
                                <span className="text-sm font-bold">Workshop</span>
                                <span className="text-[10px] opacity-60">Monster Creator</span>
                            </div>
                        </a>

                        {/* Loot (Current App - Hidden/Optional, can show for completeness or hide) */}
                        {/* Hidden here since we are in Loot */}

                        {/* Campaign (Grey) */}
                        <a href="./campaign.html" className="suite-item campaign-hover flex items-center gap-3 px-4 py-3 text-slate-300 hover:bg-slate-800/50">
                            <Flag size={18} className="text-slate-400" />
                            <div className="flex flex-col">
                                <span className="text-sm font-bold">Campaign</span>
                                <span className="text-[10px] opacity-60">Adventure Module</span>
                            </div>
                        </a>

                        {/* Compendium (Indigo) */}
                        <a href="./compendium.html" className="suite-item compendium-hover flex items-center gap-3 px-4 py-3 text-slate-300 hover:bg-slate-800/50 border-t border-slate-700">
                            <BookOpen size={18} className="text-slate-400" />
                            <div className="flex flex-col">
                                <span className="text-sm font-bold">Compendium</span>
                                <span className="text-[10px] opacity-60">Rules & Spells</span>
                            </div>
                        </a>
                    </div>
                </div>
            );
        };

        // --- FLOATING SETTINGS BUTTON COMPONENT ---
        const FloatingSettingsButton = ({ apiKey, setModalVisible }) => {
            const isKeyNeeded = !apiKey;
            if (isKeyNeeded) { return (<button onClick={() => setModalVisible(true)} className="floating-button px-4 py-2 flex items-center gap-2 bg-red-700 text-white rounded-full font-bold uppercase text-sm border-2 border-red-500 hover:bg-red-600 transition-colors duration-300 animate-pulse" title="Gemini API Key Needed for AI Features"><AlertTriangle size={16} /> API Key Needed</button>); }
            return (<button onClick={() => setModalVisible(true)} className="floating-button w-10 h-10 flex items-center justify-center bg-slate-700 text-slate-400 hover:text-white rounded-full border border-slate-600 hover:bg-slate-600 transition-colors duration-300" title="AI Settings"><Settings size={20} /></button>);
        };

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, errorInfo) { console.error("Uncaught error:", error, errorInfo); }
            handleReset = () => { if(confirm("Clear local data?")) { localStorage.clear(); window.location.reload(); } };
            render() {
                if (this.state.hasError) { return (<div className="min-h-screen bg-slate-950 flex items-center justify-center p-4 text-center"><div className="bg-slate-900 p-8 rounded-xl border border-red-900 shadow-2xl max-w-md"><AlertTriangle size={48} className="text-red-500 mx-auto mb-4" /><h1 className="text-2xl font-bold text-white mb-2">Magical Feedback Loop</h1><button onClick={this.handleReset} className="bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-6 rounded-lg w-full transition-colors mt-4">Reset Data</button></div></div>); }
                return this.props.children;
            }
        }

        function App() {
            const [view, setView] = useState('dashboard');
            const [lootHistory, setLootHistory] = useState(() => { try { return JSON.parse(localStorage.getItem('akashic_loot_history')) || []; } catch { return []; } });
            const [lootedBattles, setLootedBattles] = useState(() => { try { return JSON.parse(localStorage.getItem('akashic_looted_battles')) || []; } catch { return []; } });
            
            const [recentBattle, setRecentBattle] = useState(null);
            const [localBattle, setLocalBattle] = useState(null); // Stores scanned LOCAL items
            
            const [isSyncing, setIsSyncing] = useState(false);
            const [debugInfo, setDebugInfo] = useState('');
            
            // Forge State
            const [forgeForm, setForgeForm] = useState({ name: '', type: 'weapon', rarity: 'common', val: '', description: '', qty: 1 });
            const [isGenerating, setIsGenerating] = useState(false);
            const [aiPrompt, setAiPrompt] = useState('');
            const [userApiKey, setUserApiKey] = useState(() => localStorage.getItem('dm-tracker-api-key') || "");
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [expandedItem, setExpandedItem] = useState(null);
            const [deleteTarget, setDeleteTarget] = useState(null);
            
            const fileInputRef = useRef(null);

            // Persistence
            useEffect(() => { localStorage.setItem('akashic_loot_history', JSON.stringify(lootHistory)); }, [lootHistory]);
            useEffect(() => { localStorage.setItem('akashic_looted_battles', JSON.stringify(lootedBattles)); }, [lootedBattles]);
            useEffect(() => { 
                if (userApiKey && userApiKey !== localStorage.getItem('dm-tracker-api-key')) {
                    localStorage.setItem('dm-tracker-api-key', userApiKey);
                }
            }, [userApiKey]);

            // --- SCANNER LOGIC (LOCAL ONLY) ---
            const scanBattlefield = () => {
                setIsSyncing(true);
                setRecentBattle(null); // Clear old cloud state
                setLocalBattle(null);
                setDebugInfo("Scanning local tracker data...");

                // CHECK LOCAL TRACKER BACKUP
                // This checks the `dm-tracker-monsters` key which the Tracker app writes to.
                try {
                    const localMonsters = JSON.parse(localStorage.getItem('dm-tracker-monsters')) || [];
                    const deadMonsters = localMonsters.filter(m => m.type === 'monster' && m.currentHp === 0);
                    
                    if (deadMonsters.length > 0) {
                        // Create a pseudo-battle ID based on current time + count + hash
                        const battleId = `local_${deadMonsters.length}_${deadMonsters.map(m=>m.name).join('').replace(/\s/g,'').slice(0,10)}_${new Date().getHours()}`;
                        
                        if (!lootedBattles.includes(battleId)) {
                            setLocalBattle({
                                id: battleId,
                                enemies: deadMonsters.map(m => ({ name: m.name, cr: m.cr || 0, type: m.monsterType || 'Unknown' })),
                                timestamp: new Date().toISOString()
                            });
                            setDebugInfo(prev => prev + `\nFound Local Carnage: ${deadMonsters.length} bodies.`);
                        } else {
                            setDebugInfo(prev => prev + "\nLocal bodies already marked as looted.");
                        }
                    } else {
                        setDebugInfo(prev => prev + "\nNo dead bodies found in local tracker.");
                    }
                } catch(e) {
                    console.error("Local Scan Error", e);
                    setDebugInfo(prev => prev + `\nError reading local data: ${e.message}`);
                }

                setIsSyncing(false);
            };

            const lootBattle = (battleData) => {
                if (!battleData) return;
                
                // Add to looted list so we don't scan it again immediately
                setLootedBattles(prev => [...prev, battleData.id]);
                
                // Generate Loot Logic
                const items = [];
                battleData.enemies.forEach(enemy => {
                    const cr = parseFloat(enemy.cr) || 0;
                    let tier = 'low';
                    if (cr >= 5 && cr <= 10) tier = 'med';
                    if (cr >= 11) tier = 'high';

                    const pool = LOOT_TABLE[tier];
                    const item = pool[Math.floor(Math.random() * pool.length)];
                    items.push({ ...item, id: Math.random() });
                });
                
                const newEntry = {
                    id: Date.now(),
                    source: 'Local Skirmish',
                    items: items,
                    date: new Date().toLocaleTimeString()
                };
                
                setLootHistory(prev => [newEntry, ...prev]);
                
                // Clear UI
                setLocalBattle(null);
                
                alert(`Looted ${items.length} items from ${battleData.enemies.length} enemies!`);
            };

            // Standard Generation
            const generateLoot = (tier) => {
                const count = Math.floor(Math.random() * 3) + 1;
                const items = [];
                const pool = [...LOOT_TABLE[tier]];
                for(let i=0; i<count; i++) {
                    if(pool.length === 0) break;
                    const randomIndex = Math.floor(Math.random() * pool.length);
                    items.push({ ...pool.splice(randomIndex, 1)[0], id: Math.random() });
                }
                setLootHistory(prev => [{ id: Date.now(), source: 'Quick Loot', items, date: new Date().toLocaleTimeString() }, ...prev]);
            };

            const clearHistory = () => { setLootHistory([]); setLootedBattles([]); localStorage.removeItem('akashic_loot_history'); localStorage.removeItem('akashic_looted_battles'); };
            const resetScannedMemory = () => { setLootedBattles([]); localStorage.removeItem('akashic_looted_battles'); scanBattlefield(); };
            
            // --- FORGE & AI ---
            const handleAIGenerate = async () => {
                if (!aiPrompt) { alert("Describe the item first."); return; }
                if (!userApiKey) { setShowSettingsModal(true); return; }
                
                setIsGenerating(true);
                const prompt = `Create a D&D 5e item based on: "${aiPrompt}". Return ONLY JSON: { "name":str, "type":str(weapon/armor/magic/potion/gem/currency), "rarity":str, "val":str, "description":str (stats) }.`;
                
                const response = await callGemini(prompt, userApiKey);
                
                if (response) {
                    try {
                        const itemData = JSON.parse(response);
                        setForgeForm(prev => ({ ...prev, ...itemData, qty: 1 }));
                    } catch (e) { alert("AI Parse Error"); }
                } else { alert("AI generation failed."); }
                setIsGenerating(false);
            };

            const handleForgeSubmit = () => {
                if (!forgeForm.name) return;
                const count = parseInt(forgeForm.qty) || 1;
                const newItems = Array(count).fill().map(() => ({ ...forgeForm, id: Math.random() }));
                setLootHistory(prev => [{ id: Date.now(), source: 'The Forge', items: newItems, date: new Date().toLocaleTimeString() }, ...prev]);
                setForgeForm({ name: '', type: 'weapon', rarity: 'common', val: '', description: '', qty: 1 });
            };

            const callGemini = async (prompt, key) => {
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ 
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: { responseMimeType: "application/json" }
                        }) 
                    });
                    if (!res.ok) throw new Error("API Error");
                    const data = await res.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                } catch (e) { return null; }
            };

            const getIconForType = (type) => {
                switch(type) {
                    case 'currency': return <Coins size={16} className="text-yellow-500" />;
                    case 'gem': return <Gem size={16} className="text-pink-400" />;
                    case 'weapon': return <Sword size={16} className="text-slate-300" />;
                    case 'armor': return <Shield size={16} className="text-slate-300" />;
                    case 'magic': return <Wand size={16} className="text-purple-400" />;
                    case 'potion': return <FlaskConical size={16} className="text-red-400" />;
                    default: return <Scroll size={16} className="text-slate-400" />;
                }
            };

            return (
                <div className="max-w-2xl mx-auto p-4 pb-24">
                    <FloatingSettingsButton apiKey={userApiKey} setModalVisible={setShowSettingsModal} />
                    
                    <nav className="bg-slate-900/80 backdrop-blur-md border-b border-yellow-900/30 sticky top-0 z-50 px-4 py-3 shadow-md mb-6 rounded-xl">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            {/* Left: Logo/Title */}
                            <div className="flex items-center gap-3">
                                <div className="bg-slate-900 p-2 rounded-lg border border-yellow-600 shadow-[0_0_15px_rgba(234,179,8,0.2)]"><Gem className="text-yellow-500 w-6 h-6" /></div>
                                <span className="font-bold text-lg text-slate-100 hidden sm:block tracking-tight">Akashic Loot Records</span>
                            </div>

                            {/* Right: Nav */}
                            <div className="flex bg-slate-950 rounded-lg p-1 border border-slate-800 items-center shadow-inner">
                                <a href="./index.html" className="flex items-center justify-center p-2 text-slate-400 hover:text-white rounded-md hover:bg-slate-800 transition-colors" title="Back to Hub"><Home size={18} /></a>
                                <div className="w-px bg-slate-800 h-6 mx-1"></div>
                                <SuiteDropdown />
                            </div>
                        </div>
                    </nav>

                    <div className="flex gap-2 mb-6 p-1 bg-slate-900/50 rounded-lg border border-slate-700 overflow-x-auto">
                        {['dashboard', 'forge', 'scanner', 'history'].map(m => ( <button key={m} onClick={() => setView(m)} className={`flex-1 py-2 px-2 text-sm font-bold rounded transition-all capitalize whitespace-nowrap ${view===m ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>{m === 'dashboard' ? 'Quick Loot' : m === 'history' ? 'Vault' : m}</button> ))}
                    </div>

                    <main className="animate-fade-in">
                        {view === 'dashboard' && (
                            <div className="p-6 loot-card rounded-xl text-center space-y-4">
                                <h2 className="text-lg font-bold text-indigo-200">Quick Loot</h2>
                                <p className="text-xs text-slate-400">Generate rewards for social encounters or traversal.</p>
                                <div className="grid grid-cols-3 gap-3 mt-4">
                                    {[ {l:'Trivial', t:'low', c:'green'}, {l:'Standard', t:'med', c:'blue'}, {l:'Hoard', t:'high', c:'yellow'} ].map(b => (
                                        <button key={b.t} onClick={() => generateLoot(b.t)} className={`p-3 bg-slate-800 hover:bg-slate-700 border border-slate-600 hover:border-${b.c}-500 rounded-lg flex flex-col items-center gap-2 transition-all group`}>
                                            <Box className={`text-slate-500 group-hover:text-${b.c}-400 transition-colors`}/> <span className="text-xs font-bold text-slate-300">{b.l}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'forge' && (
                            <div className="p-6 loot-card rounded-xl">
                                <h2 className="text-lg font-bold text-indigo-200 mb-4 flex items-center gap-2"><Hammer className="text-orange-500"/> Item Forge</h2>
                                <div className="mb-6 p-3 bg-slate-900/50 rounded border border-slate-700">
                                    <label className="text-xs text-indigo-400 uppercase font-bold mb-1 block flex items-center gap-1"><Sparkles size={12}/> AI Generation</label>
                                    <div className="flex gap-2"><input type="text" placeholder="Describe item..." value={aiPrompt} onChange={e => setAiPrompt(e.target.value)} className="mb-0 flex-1"/><button onClick={handleAIGenerate} disabled={isGenerating} className="p-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded font-bold flex items-center justify-center transition-colors min-w-[42px]">{isGenerating ? <RefreshCw className="animate-spin" size={18}/> : <Wand size={18}/>}</button></div>
                                </div>
                                <div className="border-t border-slate-700 pt-4 space-y-3">
                                    <input type="text" placeholder="Item Name" value={forgeForm.name} onChange={e => setForgeForm({...forgeForm, name: e.target.value})} />
                                    <div className="grid grid-cols-2 gap-3">
                                        <select value={forgeForm.type} onChange={e => setForgeForm({...forgeForm, type: e.target.value})}>{['weapon','armor','magic','potion','gem','currency'].map(o=><option key={o} value={o}>{o.toUpperCase()}</option>)}</select>
                                        <select value={forgeForm.rarity} onChange={e => setForgeForm({...forgeForm, rarity: e.target.value})}>{['common','uncommon','rare','epic','legendary'].map(o=><option key={o} value={o}>{o.toUpperCase()}</option>)}</select>
                                    </div>
                                    <div className="grid grid-cols-3 gap-3"><div className="col-span-2"><input type="text" placeholder="Value/Notes" value={forgeForm.val} onChange={e => setForgeForm({...forgeForm, val: e.target.value})} /></div><div><input type="number" min="1" value={forgeForm.qty} onChange={e => setForgeForm({...forgeForm, qty: parseInt(e.target.value) || 1})} /></div></div>
                                    <textarea placeholder="Description/Stats" value={forgeForm.description || ''} onChange={e => setForgeForm({...forgeForm, description: e.target.value})} className="h-24 resize-none text-xs font-mono"></textarea>
                                    <button onClick={handleForgeSubmit} className="w-full py-3 bg-orange-700 hover:bg-orange-600 text-white font-bold rounded-lg shadow-lg flex items-center justify-center gap-2"><Plus size={18}/> MINT ITEM</button>
                                </div>
                            </div>
                        )}

                        {view === 'scanner' && (
                            <div className="p-6 loot-card rounded-xl border-dashed border-2 border-slate-600 flex flex-col items-center justify-center min-h-[200px] relative overflow-hidden text-center">
                                {isSyncing && <div className="absolute inset-0 bg-slate-900/80 backdrop-blur-sm flex flex-col items-center justify-center z-10 animate-fade-in"><RefreshCw className="w-12 h-12 text-indigo-500 animate-spin mb-4"/><h3 className="text-xl font-bold text-white animate-pulse">Scanning...</h3></div>}
                                
                                {!localBattle ? (
                                    <>
                                        <div className="mb-4 p-4 rounded-full bg-slate-800"><Skull className="text-slate-500"/></div>
                                        <h3 className="text-lg font-bold text-white mb-1">Scan for Bodies</h3>
                                        <p className="text-xs text-slate-400 mb-4 max-w-xs">Searches Local Tracker for unlooted dead enemies.</p>
                                        <button onClick={scanBattlefield} disabled={isSyncing} className="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-full shadow-lg active:scale-95 disabled:opacity-50">START SCAN</button>
                                        <div className="mt-6 border-t border-slate-700 pt-4 w-full"><p className="text-[10px] text-slate-600 font-mono whitespace-pre-wrap">{debugInfo}</p><button onClick={resetScannedMemory} className="text-[10px] text-red-500 hover:text-red-400 underline mt-2">Reset Scanned Memory</button></div>
                                    </>
                                ) : (
                                    <div className="w-full animate-fade-in space-y-6">
                                        {/* LOCAL BATTLE */}
                                        {localBattle && (
                                            <div className="bg-slate-900/50 p-4 rounded-xl border border-emerald-500/30">
                                                <div className="flex justify-between items-center mb-3 border-b border-emerald-500/20 pb-2">
                                                    <h3 className="text-sm font-bold text-emerald-400 flex items-center gap-2"><Home size={14}/> Local Tracker Bodies</h3>
                                                    <span className="text-[10px] bg-emerald-900/30 text-emerald-300 px-2 py-0.5 rounded-full">OFFLINE READY</span>
                                                </div>
                                                <ul className="space-y-1 mb-4">{localBattle.enemies.map((e, i) => <li key={i} className="flex justify-between text-xs bg-slate-800 p-1.5 rounded"><span>{e.name}</span><span className="text-slate-500">CR {e.cr}</span></li>)}</ul>
                                                <button onClick={() => lootBattle(localBattle)} className="w-full py-2 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded shadow-lg flex items-center justify-center gap-2"><Gem size={16}/> LOOT LOCAL BODIES</button>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}

                        {view === 'history' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center mb-2">
                                     <div className="flex gap-2"><input type="file" ref={fileInputRef} onChange={(e) => { const file = e.target.files[0]; if(file) { const r = new FileReader(); r.onload = ev => setLootHistory(p => [...JSON.parse(ev.target.result), ...p]); r.readAsText(file); } }} className="hidden" /><button onClick={() => fileInputRef.current.click()} className="text-xs bg-slate-900 border border-slate-700 px-3 py-1 rounded">Import</button><button onClick={() => { const b = new Blob([JSON.stringify(lootHistory, null, 2)], {type:"application/json"}); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = "loot.json"; a.click(); }} className="text-xs bg-slate-900 border border-slate-700 px-3 py-1 rounded">Export</button></div>
                                    {lootHistory.length > 0 && <button onClick={clearHistory} className="text-xs text-red-400 bg-red-950/30 border border-red-900 px-3 py-1 rounded">Clear All</button>}
                                </div>
                                {lootHistory.length === 0 ? <div className="text-center py-12 text-slate-500 italic"><Archive className="mb-2 opacity-50 mx-auto"/>Vault is empty.</div> : lootHistory.map(entry => (
                                    <div key={entry.id} className="loot-card p-4 rounded-xl mb-4 relative">
                                        <div className="flex justify-between mb-3 border-b border-slate-700/50 pb-2"><div className="flex flex-col"><span className="text-xs font-bold text-indigo-300 uppercase">{entry.source}</span><span className="text-[10px] text-slate-500">{entry.date}</span></div><button onClick={() => setDeleteTarget(entry.id)} className="text-slate-400 hover:text-red-400"><Trash2 size={16}/></button></div>
                                        <ul className="space-y-2">{entry.items.map(item => (<li key={item.id} className="text-sm cursor-pointer hover:bg-slate-800/50 p-1 rounded" onClick={() => setExpandedItem(expandedItem === item.id ? null : item.id)}><div className="flex gap-3"><div className="mt-1">{getIconForType(item.type)}</div><div className="flex-1"><div className="flex justify-between"><span className={`font-bold rarity-${item.rarity}`}>{item.name}</span><span className="text-slate-400 text-xs font-mono">{item.val}</span></div></div></div>{expandedItem === item.id && <div className="mt-2 ml-7 text-xs text-slate-300 italic bg-slate-900/50 p-2 rounded">{item.description || "No details."}</div>}</li>))}</ul>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {deleteTarget !== null && (<div className="fixed inset-0 z-[120] flex items-center justify-center p-4 bg-black/70"><div className="bg-gray-900 w-full max-w-sm rounded-xl p-5 text-center"><h3 className="font-bold text-white mb-4">Delete Entry?</h3><div className="flex gap-2"><button onClick={() => setDeleteTarget(null)} className="flex-1 py-2 bg-slate-700 text-white rounded">Cancel</button><button onClick={() => { setLootHistory(p => p.filter(e => e.id !== deleteTarget)); setDeleteTarget(null); }} className="flex-1 py-2 bg-red-600 text-white rounded">Delete</button></div></div></div>)}
                    {/* SETTINGS MODAL */}
                    {showSettingsModal && (<div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm"><div className="bg-gray-900 w-full max-w-md rounded-xl shadow-2xl border border-gray-700 flex flex-col"><div className="flex justify-between items-center p-4 border-b border-gray-700"><h2 className="text-xl font-bold text-white flex items-center gap-2"><Settings className="text-slate-400" /> Settings</h2><button onClick={() => setShowSettingsModal(false)} className="text-slate-400 hover:text-white"><X size={24} /></button></div><div className="p-6"><label className="block text-sm font-bold text-white mb-2 flex items-center gap-2"><Key size={16} className="text-yellow-500" /> Gemini API Key</label><input type="password" placeholder="Paste your key here..." className="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none mb-2" value={userApiKey} onChange={(e) => setUserApiKey(e.target.value)} /><p className="text-xs text-slate-400 mb-4">The AI features require a Google Gemini API Key. Stored locally.<br/><br/><a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noreferrer" className="text-indigo-400 underline hover:text-indigo-300">Get a free API Key here</a></p><div className="flex justify-end"><button onClick={() => {setShowSettingsModal(false);}} className="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded font-bold">Save & Close</button></div></div></div></div>)}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>