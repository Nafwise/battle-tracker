<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Akashic Loot Records</title>
    
    <!-- PWA / Mobile App Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0F172A">

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React 18 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Polyfills & Babel -->
    <script src="https://cdn.jsdelivr.net/npm/core-js-bundle@3.37.1/minified.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        :root {
            --loot-bg: #0F172A;
            --loot-gold: #F59E0B;
            --loot-purple: #8B5CF6;
            --loot-text: #F8FAFC;
        }
        body { background-color: var(--loot-bg); color: var(--loot-text); font-family: ui-serif, Georgia, Cambria, "Times New Roman", Times, serif; }
        
        .gold-gradient-text {
            background: linear-gradient(to bottom, #FCD34D, #F59E0B);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .loot-card {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid #475569;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        /* Coin Spin Animation */
        @keyframes flip { 0% { transform: rotateY(0); } 100% { transform: rotateY(360deg); } }
        .animate-flip { animation: flip 2s infinite linear; }
        
        .rarity-common { color: #94a3b8; }
        .rarity-uncommon { color: #10b981; }
        .rarity-rare { color: #3b82f6; }
        .rarity-epic { color: #a855f7; }
        .rarity-legendary { color: #f59e0b; text-shadow: 0 0 10px rgba(245, 158, 11, 0.5); }
        
        input, select, textarea {
            background-color: #1e293b;
            border: 1px solid #475569;
            color: white;
            padding: 8px;
            border-radius: 6px;
            width: 100%;
            margin-bottom: 8px;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #8B5CF6;
        }
        
        /* Animation classes */
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-900 via-slate-950 to-black">
    <div id="root"></div>

   <!-- FIREBASE CONFIG & INITIALIZATION (MERGED & ROBUST) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, deleteDoc, onSnapshot, query, serverTimestamp, getDocs, orderBy, limit, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAdlWWNWbpizo_Dx2xJikTDKHdj4AJ0VSY",
            authDomain: "battletracker-51502.firebaseapp.com",
            projectId: "battletracker-51502",
            storageBucket: "battletracker-51502.firebasestorage.app",
            messagingSenderId: "717377728252",
            appId: "1:717377728252:web:652210dc6904fef7ce7179"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global instances for React
        window.db = db;
        window.auth = auth;
        window.currentUserId = null;
        window.isAuthReady = false;
        window.isOffline = false;

        // Expose Firestore functions to window for React
        window.firebase = {
            doc, setDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, getDocs, orderBy, limit, addDoc
        };

        // Initialize Auth Helper (Robust)
        async function initAuth() {
            console.log("[Loot Auth] Initializing...");
            const localId = localStorage.getItem('akashic_user_id');
            
            // Priority: Try Custom Token (Environment injected)
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                 try {
                     await signInWithCustomToken(auth, __initial_auth_token);
                     console.log("[Loot Auth] Signed in with Custom Token");
                     return auth.currentUser;
                 } catch (e) {
                     console.warn("[Loot Auth] Custom token failed, attempting fallback...", e);
                 }
            }

            return new Promise((resolve) => {
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("[Loot Auth] User Logged In:", user.uid);
                        if (!localId) localStorage.setItem('akashic_user_id', user.uid);
                        unsubscribe();
                        resolve(user);
                    } else {
                        console.log("[Loot Auth] Attempting Anonymous Sign-in...");
                        signInAnonymously(auth).then((userCredential) => {
                             unsubscribe();
                             resolve(userCredential.user);
                        }).catch((error) => {
                            console.warn("[Loot Auth] Auth Failed. Entering Offline Mode.", error);
                            window.isOffline = true;
                            window.currentUserId = localId || 'offline_user_' + Date.now();
                            unsubscribe();
                            resolve({ uid: window.currentUserId, isAnonymous: true }); 
                        });
                    }
                });
            });
        }

        // Expose initAuth
        window.initAuth = initAuth;

        // Kickoff Auth Flow
        initAuth().then((user) => {
            if (user && !window.isOffline) {
                console.log("Loot Connected as:", user.uid);
                window.currentUserId = user.uid;
            } else {
                console.log("Loot Initialized in Offline Mode");
            }
            window.isAuthReady = true;
            document.dispatchEvent(new CustomEvent('auth-ready'));
        });
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- BAKED IN KEY ---
        const HARDCODED_API_KEY = "AIzaSyB1Xn3Wq0UXF92lmS6zWOjFJ3SXGj2pSrk"; 

        // --- ICONS ---
        const Icon = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Coins = (props) => <Icon {...props}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7.71-2.82 2.82"/></Icon>;
        const Gem = (props) => <Icon {...props}><path d="M6 3h12l4 6-10 13L2 9Z"/><path d="M11 3 8 9l4 13 4-13-3-6"/><path d="M2 9h20"/></Icon>;
        const Scroll = (props) => <Icon {...props}><path d="M19 17V5a2 2 0 0 0-2-2H4"/><path d="M8 21h12a2 2 0 0 0 2-2v-2H10v2a2 2 0 1 1-4 0V5a2 2 0 1 0-4 0v3h4"/></Icon>;
        const Skull = (props) => <Icon {...props}><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="m12.5 17-.5-1-.5 1h1z"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/></Icon>;
        const RefreshCw = (props) => <Icon {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></Icon>;
        const ArrowLeft = (props) => <Icon {...props}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></Icon>;
        const Archive = (props) => <Icon {...props}><rect width="20" height="5" x="2" y="3" rx="1"/><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/><path d="M10 12h4"/></Icon>;
        const Sword = (props) => <Icon {...props}><path d="M12 2l2 4h-4l2-4z" /><path d="M12 6v7" /><path d="M8 13h8" /><path d="M12 13v6" /><path d="M10 21h4" /></Icon>;
        const Shield = (props) => <Icon {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /></Icon>;
        const Wand = (props) => <Icon {...props}><path d="M3 21l12-12l1.5 1.5l-12 12z" /><path d="M19 2l1 2 2 1-2 1-1 2-1-2-2-1 2-1z" /></Icon>;
        const FlaskConical = (props) => <Icon {...props}><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2" /><path d="M8.5 2h7" /><path d="M7 16h10" /></Icon>;
        const Trash2 = (props) => <Icon {...props}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></Icon>;
        const Hammer = (props) => <Icon {...props}><path d="M6 5h12v4h-12z" /><path d="M12 9v12" /><path d="M10 21h4" /></Icon>;
        const Plus = (props) => <Icon {...props}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>;
        const Settings = (props) => <Icon {...props}><circle cx="12" cy="12" r="3" /><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" /></Icon>;
        const Key = (props) => <Icon {...props}><path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" /></Icon>;
        const X = (props) => <Icon {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>;
        const Sparkles = (props) => <Icon {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.276 1.276L3 12l5.813 1.912a2 2 0 0 1 1.276 1.276L12 21l1.912-5.813a2 2 0 0 1 1.276-1.276L21 12l-5.813-1.912a2 2 0 0 1-1.276-1.276Z" /></Icon>;
        const CastleGate = (props) => (<Icon {...props}><path d="M19 21v-8a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v8"/><path d="M4 11V7"/><path d="M20 11V7"/><path d="M2 7h4v4H2z"/><path d="M18 7h4v4h-4z"/><path d="M4 7l2-4 2 4"/><path d="M18 7l2-4 2 4"/><path d="M10 21v-4a2 2 0 0 1 4 0v4"/></Icon>);
        const Home = (props) => <Icon {...props}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></Icon>; 
        const Info = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></Icon>;
        const Download = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></Icon>;
        const Upload = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></Icon>;
        const AlertTriangle = (props) => <Icon {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></Icon>;
        const Box = (props) => <Icon {...props}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></Icon>;

        // --- LOOT TABLES ---
        const LOOT_TABLE = {
            low: [
                { name: "Pouch of Copper", type: "currency", val: "4d6 cp", rarity: "common", description: "A simple pouch containing loose change." },
                { name: "Agate Gem", type: "gem", val: "10 gp", rarity: "uncommon", description: "A translucent gemstone with banded colors." },
                { name: "Rusty Dagger", type: "weapon", val: "1 gp", rarity: "common", description: "Stats: 1d4 Piercing. Finesse, Light." },
                { name: "Healing Potion", type: "potion", val: "50 gp", rarity: "uncommon", description: "Restores 2d4 + 2 HP." },
                { name: "Leather Armor", type: "armor", val: "10 gp", rarity: "common", description: "AC: 11 + Dex Modifier." }
            ],
            med: [
                { name: "Sack of Silver", type: "currency", val: "2d8 sp", rarity: "common", description: "A heavy sack of silver coins." },
                { name: "Gold Ring", type: "art", val: "25 gp", rarity: "rare", description: "A simple but elegant gold ring." },
                { name: "Scroll of Magic Missile", type: "magic", val: "100 gp", rarity: "uncommon", description: "Single use spell scroll." },
                { name: "+1 Arrow", type: "weapon", val: "5 gp", rarity: "uncommon", description: "Stats: +1 to Attack/Damage rolls." },
                { name: "Chain Shirt", type: "armor", val: "50 gp", rarity: "uncommon", description: "AC: 13 + Dex Modifier (max 2)." },
                { name: "Wand of Secrets", type: "magic", val: "Uncommon", rarity: "uncommon", description: "3 charges. Detects secret doors." }
            ],
            high: [
                { name: "Chest of Gold", type: "currency", val: "4d10 gp", rarity: "uncommon", description: "A sturdy chest filled with gold." },
                { name: "Diamond", type: "gem", val: "300 gp", rarity: "epic", description: "A flawless clear gemstone." },
                { name: "Cloak of Protection", type: "magic", val: "500 gp", rarity: "rare", description: "+1 to AC and Saving Throws." },
                { name: "Vorpal Sword Fragment", type: "quest", val: "???", rarity: "legendary", description: "A shard of a legendary blade." },
                { name: "Plate Armor", type: "armor", val: "1500 gp", rarity: "rare", description: "AC: 18. Str 15 Req. Stealth Disadvantage." },
                { name: "Supreme Healing Potion", type: "potion", val: "1350 gp", rarity: "rare", description: "Restores 10d4 + 20 HP." }
            ]
        };

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, errorInfo) { console.error("Uncaught error:", error, errorInfo); }
            handleReset = () => { if(confirm("Clear local data?")) { localStorage.clear(); window.location.reload(); } };
            render() {
                if (this.state.hasError) { return (<div className="min-h-screen bg-slate-950 flex items-center justify-center p-4 text-center"><div className="bg-slate-900 p-8 rounded-xl border border-red-900 shadow-2xl max-w-md"><AlertTriangle size={48} className="text-red-500 mx-auto mb-4" /><h1 className="text-2xl font-bold text-white mb-2">Magical Feedback Loop</h1><button onClick={this.handleReset} className="bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-6 rounded-lg w-full transition-colors mt-4">Reset Data</button></div></div>); }
                return this.props.children;
            }
        }

        function App() {
            const [db, setDb] = useState(null);
            const [userId, setUserId] = useState(null);
            const [appId, setAppId] = useState(null);

            const [view, setView] = useState('dashboard');
            const [lootHistory, setLootHistory] = useState(() => { try { return JSON.parse(localStorage.getItem('akashic_loot_history')) || []; } catch { return []; } });
            const [lootedBattles, setLootedBattles] = useState(() => { try { return JSON.parse(localStorage.getItem('akashic_looted_battles')) || []; } catch { return []; } });
            
            const [recentBattle, setRecentBattle] = useState(null);
            const [localBattle, setLocalBattle] = useState(null); // Stores scanned LOCAL items
            
            const [isSyncing, setIsSyncing] = useState(false);
            const [debugInfo, setDebugInfo] = useState('');
            
            // Forge State
            const [forgeForm, setForgeForm] = useState({ name: '', type: 'weapon', rarity: 'common', val: '', description: '', qty: 1 });
            const [isGenerating, setIsGenerating] = useState(false);
            const [aiPrompt, setAiPrompt] = useState('');
            const [userApiKey, setUserApiKey] = useState(() => localStorage.getItem('dm-tracker-api-key') || HARDCODED_API_KEY);
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [expandedItem, setExpandedItem] = useState(null);
            const [deleteTarget, setDeleteTarget] = useState(null);
            
            const fileInputRef = useRef(null);

            // AUTH & FIREBASE SYNC
            useEffect(() => {
                const handleAuthReady = () => {
                    if (window.isAuthReady && window.db && window.currentUserId) {
                        setDb(window.db);
                        setUserId(window.currentUserId);
                        setAppId(typeof __app_id !== 'undefined' ? __app_id : 'default-app-id');
                    }
                };
                if (window.isAuthReady) handleAuthReady();
                document.addEventListener('auth-ready', handleAuthReady);
                return () => document.removeEventListener('auth-ready', handleAuthReady);
            }, []);

            // Persistence
            useEffect(() => { localStorage.setItem('akashic_loot_history', JSON.stringify(lootHistory)); }, [lootHistory]);
            useEffect(() => { localStorage.setItem('akashic_looted_battles', JSON.stringify(lootedBattles)); }, [lootedBattles]);
            useEffect(() => { if (userApiKey && userApiKey !== localStorage.getItem('dm-tracker-api-key')) localStorage.setItem('dm-tracker-api-key', userApiKey); }, [userApiKey]);

            // --- SCANNER LOGIC (DUAL MODE) ---
            const scanBattlefield = async () => {
                setIsSyncing(true);
                setRecentBattle(null);
                setLocalBattle(null);
                setDebugInfo("Scanning...");

                let foundNewCloudBattle = false;

                // 1. CLOUD SCAN (If Online)
                if (db && userId && !window.isOffline) {
                    setDebugInfo(prev => prev + "\nChecking Cloud Records...");
                    try {
                        const battlesCollection = window.firebase.collection(db, 'artifacts', appId, 'users', userId, 'battles');
                        const q = window.firebase.query(battlesCollection, window.firebase.limit(10));
                        const snapshot = await window.firebase.getDocs(q);
                        
                        if (!snapshot.empty) {
                            const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), millis: doc.data().timestamp?.toMillis ? doc.data().timestamp.toMillis() : Date.now() }));
                            docs.sort((a, b) => b.millis - a.millis); // Newest first

                            for (const doc of docs) {
                                if (!lootedBattles.includes(doc.id)) {
                                    setRecentBattle({ id: doc.id, enemies: doc.enemies || [], timestamp: new Date(doc.millis).toISOString() });
                                    setDebugInfo(prev => prev + `\nFound Cloud Battle: ${doc.id}`);
                                    foundNewCloudBattle = true;
                                    break;
                                }
                            }
                        }
                    } catch(e) { console.error(e); setDebugInfo(prev => prev + `\nCloud Error: ${e.message}`); }
                } else {
                    setDebugInfo(prev => prev + "\nOffline Mode: Skipping Cloud Check.");
                }

                // 2. LOCAL SCAN (Tracker Backup)
                // This checks the `dm-tracker-monsters` key which the Tracker app writes to.
                // It filters for dead monsters (HP 0).
                setDebugInfo(prev => prev + "\nChecking Local Tracker Backup...");
                try {
                    const localMonsters = JSON.parse(localStorage.getItem('dm-tracker-monsters')) || [];
                    const deadMonsters = localMonsters.filter(m => m.type === 'monster' && m.currentHp === 0);
                    
                    if (deadMonsters.length > 0) {
                        // Create a pseudo-battle ID based on current time + count
                        // We check if we've already "looted" this specific batch by length/names hash roughly, 
                        // or just simplify and let user decide. Since local storage is mutable, we just show what is currently dead.
                        const battleId = `local_${deadMonsters.length}_${deadMonsters[0].name.replace(/\s/g,'')}`;
                        
                        if (!lootedBattles.includes(battleId)) {
                            setLocalBattle({
                                id: battleId,
                                enemies: deadMonsters.map(m => ({ name: m.name, cr: m.cr || 0, type: m.monsterType || 'Unknown' })),
                                timestamp: new Date().toISOString()
                            });
                            setDebugInfo(prev => prev + `\nFound Local Carnage: ${deadMonsters.length} bodies.`);
                        } else {
                            setDebugInfo(prev => prev + "\nLocal bodies already marked as looted.");
                        }
                    } else {
                        setDebugInfo(prev => prev + "\nNo dead bodies found in local tracker.");
                    }
                } catch(e) {
                    console.error("Local Scan Error", e);
                }

                setIsSyncing(false);
            };

            const lootBattle = (battleData, isLocal) => {
                if (!battleData) return;
                
                // Add to looted list so we don't scan it again immediately
                setLootedBattles(prev => [...prev, battleData.id]);
                
                // Generate Loot Logic
                const items = [];
                battleData.enemies.forEach(enemy => {
                    const cr = parseFloat(enemy.cr) || 0;
                    let tier = 'low';
                    if (cr >= 5 && cr <= 10) tier = 'med';
                    if (cr >= 11) tier = 'high';

                    const pool = LOOT_TABLE[tier];
                    const item = pool[Math.floor(Math.random() * pool.length)];
                    items.push({ ...item, id: Math.random() });
                });
                
                const newEntry = {
                    id: Date.now(),
                    source: isLocal ? 'Local Skirmish' : 'Battlefield Salvage',
                    items: items,
                    date: new Date().toLocaleTimeString()
                };
                
                setLootHistory(prev => [newEntry, ...prev]);
                
                // Clear UI
                if (isLocal) setLocalBattle(null);
                else setRecentBattle(null);
                
                alert(`Looted ${items.length} items from ${battleData.enemies.length} enemies!`);
            };

            // Standard Generation
            const generateLoot = (tier) => {
                const count = Math.floor(Math.random() * 3) + 1;
                const items = [];
                const pool = [...LOOT_TABLE[tier]];
                for(let i=0; i<count; i++) {
                    if(pool.length === 0) break;
                    const randomIndex = Math.floor(Math.random() * pool.length);
                    items.push({ ...pool.splice(randomIndex, 1)[0], id: Math.random() });
                }
                setLootHistory(prev => [{ id: Date.now(), source: 'Quick Loot', items, date: new Date().toLocaleTimeString() }, ...prev]);
            };

            const clearHistory = () => { setLootHistory([]); setLootedBattles([]); localStorage.removeItem('akashic_loot_history'); localStorage.removeItem('akashic_looted_battles'); };
            const resetScannedMemory = () => { setLootedBattles([]); localStorage.removeItem('akashic_looted_battles'); scanBattlefield(); };
            
            // --- FORGE & AI ---
            const handleAIGenerate = async () => {
                if (!aiPrompt) { alert("Describe the item first."); return; }
                setIsGenerating(true);
                const prompt = `Create a D&D 5e item based on: "${aiPrompt}". Return ONLY JSON: { "name":str, "type":str(weapon/armor/magic/potion/gem/currency), "rarity":str, "val":str, "description":str (stats) }.`;
                const response = await callGemini(prompt);
                if (response) {
                    try {
                        const itemData = JSON.parse(response.replace(/```json|```/g, '').trim());
                        setForgeForm(prev => ({ ...prev, ...itemData, qty: 1 }));
                    } catch (e) { alert("AI Parse Error"); }
                } else { alert("AI generation failed."); }
                setIsGenerating(false);
            };

            const handleForgeSubmit = () => {
                if (!forgeForm.name) return;
                const count = parseInt(forgeForm.qty) || 1;
                const newItems = Array(count).fill().map(() => ({ ...forgeForm, id: Math.random() }));
                setLootHistory(prev => [{ id: Date.now(), source: 'The Forge', items: newItems, date: new Date().toLocaleTimeString() }, ...prev]);
                setForgeForm({ name: '', type: 'weapon', rarity: 'common', val: '', description: '', qty: 1 });
            };

            const callGemini = async (prompt) => {
                if (!userApiKey) { setShowSettingsModal(true); return null; }
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                    if (!res.ok) throw new Error("API Error");
                    return (await res.json()).candidates?.[0]?.content?.parts?.[0]?.text || "";
                } catch (e) { return null; }
            };

            const getIconForType = (type) => {
                switch(type) {
                    case 'currency': return <Coins size={16} className="text-yellow-500" />;
                    case 'gem': return <Gem size={16} className="text-pink-400" />;
                    case 'weapon': return <Sword size={16} className="text-slate-300" />;
                    case 'armor': return <Shield size={16} className="text-slate-300" />;
                    case 'magic': return <Wand size={16} className="text-purple-400" />;
                    case 'potion': return <FlaskConical size={16} className="text-red-400" />;
                    default: return <Scroll size={16} className="text-slate-400" />;
                }
            };

            return (
                <div className="max-w-2xl mx-auto p-4 pb-24">
                    <header className="flex justify-between items-center mb-8 border-b border-indigo-900/50 pb-4">
                        <div className="flex items-center gap-3"><div className="bg-slate-900 p-2 rounded-lg border border-yellow-600 shadow-[0_0_15px_rgba(234,179,8,0.2)]"><Gem className="text-yellow-500 w-6 h-6" /></div><div><h1 className="text-2xl font-bold tracking-tight text-white">Akashic Loot Records</h1>{userId && <div className="text-[10px] text-slate-500 font-mono mt-1"><span className="text-indigo-400">User ID:</span> {userId.slice(0,8)}...</div>}</div></div>
                        <div className="flex gap-2">
                             <button onClick={() => setShowSettingsModal(true)} className="p-2 text-indigo-400 hover:text-white rounded-full bg-slate-900 border border-slate-700 hover:bg-slate-800 transition-colors" title="Settings"><Settings size={18}/></button>
                            <a href="./index.html" className="flex items-center justify-center p-2 text-slate-400 hover:text-white rounded-full bg-slate-900 border border-slate-700 hover:bg-slate-800 transition-colors"><Home size={18} /></a>
                            <a href="./tome.html" className="flex items-center gap-2 bg-purple-900 hover:bg-purple-800 text-white px-3 py-1.5 rounded-full text-xs font-bold transition-all shadow-[0_0_15px_rgba(147,51,234,0.5)] border border-purple-700 hover:border-purple-500 hover:shadow-[0_0_25px_rgba(147,51,234,0.8)] hover:scale-105 active:scale-95 no-underline"><CastleGate size={16} /><span className="hidden sm:inline">Tracker</span></a>
                            <a href="./homebrew.html" className="flex items-center gap-2 bg-green-900 hover:bg-green-800 text-white px-3 py-1.5 rounded-full text-xs font-bold transition-all shadow-[0_0_15px_rgba(22,163,74,0.5)] border border-green-700 hover:border-green-500 hover:shadow-[0_0_25px_rgba(22,163,74,0.8)] hover:scale-105 active:scale-95 no-underline"><FlaskConical size={14}/><span className="hidden sm:inline">Workshop</span></a>
                        </div>
                    </header>

                    <div className="flex gap-2 mb-6 p-1 bg-slate-900/50 rounded-lg border border-slate-700 overflow-x-auto">
                        {['dashboard', 'forge', 'scanner', 'history'].map(m => ( <button key={m} onClick={() => setView(m)} className={`flex-1 py-2 px-2 text-sm font-bold rounded transition-all capitalize whitespace-nowrap ${view===m ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>{m === 'dashboard' ? 'Quick Loot' : m === 'history' ? 'Vault' : m}</button> ))}
                    </div>

                    <main className="animate-fade-in">
                        {view === 'dashboard' && (
                            <div className="p-6 loot-card rounded-xl text-center space-y-4">
                                <h2 className="text-lg font-bold text-indigo-200">Quick Loot</h2>
                                <p className="text-xs text-slate-400">Generate rewards for social encounters or traversal.</p>
                                <div className="grid grid-cols-3 gap-3 mt-4">
                                    {[ {l:'Trivial', t:'low', c:'green'}, {l:'Standard', t:'med', c:'blue'}, {l:'Hoard', t:'high', c:'yellow'} ].map(b => (
                                        <button key={b.t} onClick={() => generateLoot(b.t)} className={`p-3 bg-slate-800 hover:bg-slate-700 border border-slate-600 hover:border-${b.c}-500 rounded-lg flex flex-col items-center gap-2 transition-all group`}>
                                            <Box className={`text-slate-500 group-hover:text-${b.c}-400 transition-colors`}/> <span className="text-xs font-bold text-slate-300">{b.l}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'forge' && (
                            <div className="p-6 loot-card rounded-xl">
                                <h2 className="text-lg font-bold text-indigo-200 mb-4 flex items-center gap-2"><Hammer className="text-orange-500"/> Item Forge</h2>
                                <div className="mb-6 p-3 bg-slate-900/50 rounded border border-slate-700">
                                    <label className="text-xs text-indigo-400 uppercase font-bold mb-1 block flex items-center gap-1"><Sparkles size={12}/> AI Generation</label>
                                    <div className="flex gap-2"><input type="text" placeholder="Describe item..." value={aiPrompt} onChange={e => setAiPrompt(e.target.value)} className="mb-0 flex-1"/><button onClick={handleAIGenerate} disabled={isGenerating} className="p-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded font-bold flex items-center justify-center transition-colors min-w-[42px]">{isGenerating ? <RefreshCw className="animate-spin" size={18}/> : <Wand size={18}/>}</button></div>
                                </div>
                                <div className="border-t border-slate-700 pt-4 space-y-3">
                                    <input type="text" placeholder="Item Name" value={forgeForm.name} onChange={e => setForgeForm({...forgeForm, name: e.target.value})} />
                                    <div className="grid grid-cols-2 gap-3">
                                        <select value={forgeForm.type} onChange={e => setForgeForm({...forgeForm, type: e.target.value})}>{['weapon','armor','magic','potion','gem','currency'].map(o=><option key={o} value={o}>{o.toUpperCase()}</option>)}</select>
                                        <select value={forgeForm.rarity} onChange={e => setForgeForm({...forgeForm, rarity: e.target.value})}>{['common','uncommon','rare','epic','legendary'].map(o=><option key={o} value={o}>{o.toUpperCase()}</option>)}</select>
                                    </div>
                                    <div className="grid grid-cols-3 gap-3"><div className="col-span-2"><input type="text" placeholder="Value/Notes" value={forgeForm.val} onChange={e => setForgeForm({...forgeForm, val: e.target.value})} /></div><div><input type="number" min="1" value={forgeForm.qty} onChange={e => setForgeForm({...forgeForm, qty: parseInt(e.target.value) || 1})} /></div></div>
                                    <textarea placeholder="Description/Stats" value={forgeForm.description || ''} onChange={e => setForgeForm({...forgeForm, description: e.target.value})} className="h-24 resize-none text-xs font-mono"></textarea>
                                    <button onClick={handleForgeSubmit} className="w-full py-3 bg-orange-700 hover:bg-orange-600 text-white font-bold rounded-lg shadow-lg flex items-center justify-center gap-2"><Plus size={18}/> MINT ITEM</button>
                                </div>
                            </div>
                        )}

                        {view === 'scanner' && (
                            <div className="p-6 loot-card rounded-xl border-dashed border-2 border-slate-600 flex flex-col items-center justify-center min-h-[200px] relative overflow-hidden text-center">
                                {isSyncing && <div className="absolute inset-0 bg-slate-900/80 backdrop-blur-sm flex flex-col items-center justify-center z-10 animate-fade-in"><RefreshCw className="w-12 h-12 text-indigo-500 animate-spin mb-4"/><h3 className="text-xl font-bold text-white animate-pulse">Scanning...</h3></div>}
                                
                                {!recentBattle && !localBattle ? (
                                    <>
                                        <div className="mb-4 p-4 rounded-full bg-slate-800"><Skull className="text-slate-500"/></div>
                                        <h3 className="text-lg font-bold text-white mb-1">Scan for Bodies</h3>
                                        <p className="text-xs text-slate-400 mb-4 max-w-xs">Searches Cloud Uploads AND Local Tracker for unlooted dead enemies.</p>
                                        <button onClick={scanBattlefield} disabled={isSyncing} className="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-full shadow-lg active:scale-95 disabled:opacity-50">START SCAN</button>
                                        <div className="mt-6 border-t border-slate-700 pt-4 w-full"><p className="text-[10px] text-slate-600 font-mono whitespace-pre-wrap">{debugInfo}</p><button onClick={resetScannedMemory} className="text-[10px] text-red-500 hover:text-red-400 underline mt-2">Reset Scanned Memory</button></div>
                                    </>
                                ) : (
                                    <div className="w-full animate-fade-in space-y-6">
                                        {/* CLOUD BATTLE */}
                                        {recentBattle && (
                                            <div className="bg-slate-900/50 p-4 rounded-xl border border-indigo-500/30">
                                                <div className="flex justify-between items-center mb-3 border-b border-indigo-500/20 pb-2">
                                                    <h3 className="text-sm font-bold text-indigo-400 flex items-center gap-2"><Cloud size={14}/> Cloud Battle Report</h3>
                                                    <span className="text-xs text-slate-500">{recentBattle.timestamp.slice(11,16)}</span>
                                                </div>
                                                <ul className="space-y-1 mb-4">{recentBattle.enemies.map((e, i) => <li key={i} className="flex justify-between text-xs bg-slate-800 p-1.5 rounded"><span>{e.name}</span><span className="text-slate-500">CR {e.cr}</span></li>)}</ul>
                                                <button onClick={() => lootBattle(recentBattle, false)} className="w-full py-2 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded shadow-lg flex items-center justify-center gap-2"><Download size={16}/> IMPORT & LOOT</button>
                                            </div>
                                        )}

                                        {/* LOCAL BATTLE */}
                                        {localBattle && (
                                            <div className="bg-slate-900/50 p-4 rounded-xl border border-emerald-500/30">
                                                <div className="flex justify-between items-center mb-3 border-b border-emerald-500/20 pb-2">
                                                    <h3 className="text-sm font-bold text-emerald-400 flex items-center gap-2"><Home size={14}/> Local Tracker Bodies</h3>
                                                    <span className="text-[10px] bg-emerald-900/30 text-emerald-300 px-2 py-0.5 rounded-full">OFFLINE READY</span>
                                                </div>
                                                <ul className="space-y-1 mb-4">{localBattle.enemies.map((e, i) => <li key={i} className="flex justify-between text-xs bg-slate-800 p-1.5 rounded"><span>{e.name}</span><span className="text-slate-500">CR {e.cr}</span></li>)}</ul>
                                                <button onClick={() => lootBattle(localBattle, true)} className="w-full py-2 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded shadow-lg flex items-center justify-center gap-2"><Gem size={16}/> LOOT LOCAL BODIES</button>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}

                        {view === 'history' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center mb-2">
                                     <div className="flex gap-2"><input type="file" ref={fileInputRef} onChange={(e) => { const file = e.target.files[0]; if(file) { const r = new FileReader(); r.onload = ev => setLootHistory(p => [...JSON.parse(ev.target.result), ...p]); r.readAsText(file); } }} className="hidden" /><button onClick={() => fileInputRef.current.click()} className="text-xs bg-slate-900 border border-slate-700 px-3 py-1 rounded">Import</button><button onClick={() => { const b = new Blob([JSON.stringify(lootHistory, null, 2)], {type:"application/json"}); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = "loot.json"; a.click(); }} className="text-xs bg-slate-900 border border-slate-700 px-3 py-1 rounded">Export</button></div>
                                    {lootHistory.length > 0 && <button onClick={clearHistory} className="text-xs text-red-400 bg-red-950/30 border border-red-900 px-3 py-1 rounded">Clear All</button>}
                                </div>
                                {lootHistory.length === 0 ? <div className="text-center py-12 text-slate-500 italic"><Archive className="mb-2 opacity-50 mx-auto"/>Vault is empty.</div> : lootHistory.map(entry => (
                                    <div key={entry.id} className="loot-card p-4 rounded-xl mb-4 relative">
                                        <div className="flex justify-between mb-3 border-b border-slate-700/50 pb-2"><div className="flex flex-col"><span className="text-xs font-bold text-indigo-300 uppercase">{entry.source}</span><span className="text-[10px] text-slate-500">{entry.date}</span></div><button onClick={() => setDeleteTarget(entry.id)} className="text-slate-400 hover:text-red-400"><Trash2 size={16}/></button></div>
                                        <ul className="space-y-2">{entry.items.map(item => (<li key={item.id} className="text-sm cursor-pointer hover:bg-slate-800/50 p-1 rounded" onClick={() => setExpandedItem(expandedItem === item.id ? null : item.id)}><div className="flex gap-3"><div className="mt-1">{getIconForType(item.type)}</div><div className="flex-1"><div className="flex justify-between"><span className={`font-bold rarity-${item.rarity}`}>{item.name}</span><span className="text-slate-400 text-xs font-mono">{item.val}</span></div></div></div>{expandedItem === item.id && <div className="mt-2 ml-7 text-xs text-slate-300 italic bg-slate-900/50 p-2 rounded">{item.description || "No details."}</div>}</li>))}</ul>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {deleteTarget !== null && (<div className="fixed inset-0 z-[120] flex items-center justify-center p-4 bg-black/70"><div className="bg-gray-900 w-full max-w-sm rounded-xl p-5 text-center"><h3 className="font-bold text-white mb-4">Delete Entry?</h3><div className="flex gap-2"><button onClick={() => setDeleteTarget(null)} className="flex-1 py-2 bg-slate-700 text-white rounded">Cancel</button><button onClick={() => { setLootHistory(p => p.filter(e => e.id !== deleteTarget)); setDeleteTarget(null); }} className="flex-1 py-2 bg-red-600 text-white rounded">Delete</button></div></div></div>)}
                    {showSettingsModal && (<div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-black/70"><div className="bg-gray-900 w-full max-w-md rounded-xl p-6"><h2 className="text-xl font-bold text-white mb-4">Settings</h2><input type="password" placeholder="Gemini API Key" className="mb-4" value={userApiKey} onChange={e => setUserApiKey(e.target.value)} /><div className="flex justify-end"><button onClick={() => setShowSettingsModal(false)} className="bg-indigo-600 text-white px-4 py-2 rounded font-bold">Save</button></div></div></div>)}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>