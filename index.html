<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Akashic Tome</title>
    
    <!-- PWA / Mobile App Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Akashic Tome">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0F172A">
    <link rel="manifest" href="manifest.json">

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React 18 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Polyfills & Babel -->
    <script src="https://cdn.jsdelivr.net/npm/core-js-bundle@3.37.1/minified.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* --- The Astral Plane Palette --- */
        :root {
            --astral-bg: #0F172A;       /* Deep Midnight Blue (The Void) */
            --astral-card: #1E293B;     /* Lighter Slate Blue */
            --astral-input: #020617;    /* Almost Black for depth */
            --text-primary: #F8FAFC;    /* Starlight White */
            --text-secondary: #94A3B8;  /* Nebula Grey */
            --accent-cyan: #38BDF8;     /* Cyan/Ether (Active) */
            --accent-purple: #A855F7;   /* Mystic Purple (Magic) */
            --accent-red: #F43F5E;      /* Rose Red (Danger) */
            --border-color: #334155;    /* Slate border */
        }

        body {
             background-color: #020617; 
             font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
             color: var(--text-primary);
             overscroll-behavior-y: none;
             /* Prevent text selection on mobile for app-like feel, except inputs */
             -webkit-user-select: none;
             user-select: none;
             -webkit-tap-highlight-color: transparent;
        }
        
        input, textarea, .selectable-text {
            -webkit-user-select: text;
            user-select: text;
        }

        .astral-container {
            background-color: var(--astral-bg);
            color: var(--text-primary);
            /* Subtle radial gradient to give it depth */
            background-image: radial-gradient(circle at top right, #1e293b 0%, #0f172a 60%);
            box-shadow: 0 0 40px rgba(56, 189, 248, 0.05), 0 0 0 1px #334155;
            border-radius: 12px;
            margin: 20px auto;
            max-width: 1200px;
            position: relative;
            z-index: 10;
            min-height: 95vh;
        }
        
        /* Mobile Optimizations */
        @media (max-width: 640px) {
             .astral-container {
                 margin: 0;
                 border-radius: 0;
                 box-shadow: none;
                 min-height: 100vh;
                 border: none;
             }
        }

        /* --- Overrides for Astral Theme --- */
        
        /* Text Colors */
        .text-slate-100, .text-white, .text-gray-50, .text-gray-200 { color: var(--text-primary) !important; }
        .text-slate-300, .text-slate-400, .text-slate-500, .text-slate-600, .text-gray-400 { color: var(--text-secondary) !important; }
        
        /* Accents */
        .text-red-500, .text-red-400 { color: var(--accent-red) !important; }
        .text-green-400, .text-green-500, .text-green-600 { color: var(--accent-cyan) !important; } /* Map Green text to Cyan */
        .text-indigo-400, .text-indigo-300, .text-indigo-200 { color: var(--accent-purple) !important; } /* Map Indigo text to Purple */
        .text-yellow-400, .text-amber-500 { color: #FCD34D !important; } /* Keep gold/amber for stars/keywords */

        /* Backgrounds & Borders */
        .bg-slate-900, .bg-gray-900, .bg-slate-950 { background-color: var(--astral-input) !important; border-color: var(--border-color) !important; }
        .bg-slate-800, .bg-gray-800 { background-color: var(--astral-card) !important; border-color: var(--border-color) !important; }
        .bg-slate-700 { background-color: #334155 !important; color: var(--text-primary) !important; }
        .border-slate-600, .border-slate-700, .border-gray-600, .border-gray-700 { border-color: var(--border-color) !important; }

        /* Hover States */
        .hover\:bg-slate-700:hover { background-color: #334155 !important; }
        .hover\:bg-slate-600:hover { background-color: #475569 !important; }
        .hover\:text-white:hover { color: #fff !important; text-shadow: 0 0 8px rgba(255,255,255,0.5); }

        /* Inputs */
        input, textarea, select {
            background-color: var(--astral-input) !important;
            border-color: var(--border-color) !important;
            color: var(--text-primary) !important;
            font-size: 16px !important; /* Prevents iOS zoom */
        }
        input::placeholder, textarea::placeholder { color: #475569 !important; }
        input:focus, textarea:focus { 
            border-color: var(--accent-cyan) !important; 
            box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2) !important;
            outline: none !important;
        }

        /* Buttons - Primary Action (Green mapped to Cyan) */
        .bg-green-600, .bg-green-500 { 
            background-color: var(--accent-cyan) !important; 
            color: #0F172A !important; /* Dark text for contrast on bright cyan */
            font-weight: 800 !important;
        }
        .hover\:bg-green-500:hover { background-color: #7DD3FC !important; box-shadow: 0 0 15px rgba(56, 189, 248, 0.4); }
        
        /* Buttons - Secondary Action (Indigo mapped to Purple) */
        .bg-indigo-600, .bg-indigo-900 { background-color: var(--accent-purple) !important; color: white !important; }
        .hover\:bg-indigo-500:hover { background-color: #C084FC !important; box-shadow: 0 0 15px rgba(168, 85, 247, 0.4); }
        
        /* Buttons - Danger (Red mapped to Rose) */
        .bg-red-600, .bg-red-700 { background-color: var(--accent-red) !important; }
        .border-red-500 { border-color: var(--accent-red) !important; }
        .bg-red-900\/10 { background-color: rgba(244, 63, 94, 0.1) !important; }

        /* Header Specifics */
        header.sticky {
             background-color: rgba(15, 23, 42, 0.9) !important;
             backdrop-filter: blur(12px);
             border-bottom: 1px solid var(--border-color) !important;
             z-index: 50;
        }
        
        /* Active Card Highlight */
        .ring-2.ring-green-500 {
            --tw-ring-color: var(--accent-cyan) !important;
            border-color: var(--accent-cyan) !important;
            background-color: #162032 !important; /* Slightly lighter bg for active */
            box-shadow: 0 0 25px rgba(56, 189, 248, 0.15);
        }
        
        /* Progress Bars */
        .bg-green-500 { background-color: var(--accent-cyan) !important; }
        .bg-yellow-500 { background-color: #FBBF24 !important; }
        .bg-red-600 { background-color: var(--accent-red) !important; }

        /* Modal Backdrop */
        .bg-black\/70 { background-color: rgba(2, 6, 23, 0.8) !important; backdrop-filter: blur(6px); }

        /* Scrollbar styles */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--astral-bg); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
        
        /* Floating Buttons & Mobile Fix */
        .floating-button {
            z-index: 90;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            /* Fixed position for the settings/API key button (BOTTOM RIGHT now to avoid header) */
            position: fixed;
            bottom: 20px;
            right: 20px;
        }

        .floating-turn-button {
            z-index: 90;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            /* Fixed position for the Next Turn button (bottom center) */
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            /* Ensure it is visible on mobile over the scrollable area */
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        
        /* Animation Utility */
        @keyframes spin-die { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-spin-fast { animation: spin-die 0.6s ease-in-out infinite; }
        .animate-spin-slow { animation: spin-die 1.5s ease-out 1; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Hide scrollbar for horizontal scroll areas */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Input standardization */
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        /* Stat Block Text */
        .stat-block strong { color: #FCD34D; }
        .stat-block h3 { color: var(--accent-red); border-bottom-color: var(--accent-red); }
        
        /* Masonry Grid Fix for screen */
        .masonry-grid { column-count: 1; column-gap: 1rem; }
        @media (min-width: 640px) { .masonry-grid { column-count: 2; } }
        @media (min-width: 1024px) { .masonry-grid { column-count: 3; } }
        .break-inside-avoid { break-inside: avoid; page-break-inside: avoid; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, memo, useCallback } = React;

        // --- ICONS ---
        const Icon = ({ children, className, ...props }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width="24" 
                height="24" 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className} 
                {...props}
            >
                {children}
            </svg>
        );

        const Sword = (props) => <Icon {...props}><polyline points="14.5 17.5 3 22 4.5 10.5" /><path d="M22 3l-7.5 14.5L10 12 3 7l14.5-4.5 4.5 4.5z" /><line x1="8" y1="14" x2="2.5" y2="19.5" /><line x1="16" y1="5" x2="21.5" y2="10.5" /></Icon>;
        const Shield = (props) => <Icon {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /></Icon>;
        const Trash2 = (props) => <Icon {...props}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></Icon>;
        const Plus = (props) => <Icon {...props}><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></Icon>;
        const Minus = (props) => <Icon {...props}><line x1="5" y1="12" x2="19" y2="12" /></Icon>;
        const AlertCircle = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></Icon>;
        const GripVertical = (props) => <Icon {...props}><circle cx="9" cy="12" r="1" /><circle cx="9" cy="5" r="1" /><circle cx="9" cy="19" r="1" /><circle cx="15" cy="12" r="1" /><circle cx="15" cy="5" r="1" /><circle cx="15" cy="19" r="1" /></Icon>;
        const Zap = (props) => <Icon {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" /></Icon>;
        const Ghost = (props) => <Icon {...props}><path d="M9 22l2-2.5L13 22l2-2.5L17 22V10a5 5 0 0 0-5-5 5 5 0 0 0-5 5v12z" /><circle cx="10" cy="13" r="2" /><circle cx="14" cy="13" r="2" /></Icon>;
        const Sparkles = (props) => <Icon {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.276 1.276L3 12l5.813 1.912a2 2 0 0 1 1.276 1.276L12 21l1.912-5.813a2 2 0 0 1 1.276-1.276L21 12l-5.813-1.912a2 2 0 0 1-1.276-1.276Z" /></Icon>;
        const Loader2 = (props) => <Icon {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56" /></Icon>;
        const MessageSquare = (props) => <Icon {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" /></Icon>;
        const BookOpen = (props) => <Icon {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" /><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" /></Icon>;
        const Book = (props) => <Icon {...props}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" /><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" /></Icon>;
        const X = (props) => <Icon {...props}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></Icon>;
        const Save = (props) => <Icon {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></Icon>;
        const CheckCircle = (props) => <Icon {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></Icon>;
        const AlertTriangle = (props) => <Icon {...props}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" /><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" /></Icon>;
        const User = (props) => <Icon {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></Icon>;
        const Users = (props) => <Icon {...props}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M23 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></Icon>;
        const Download = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></Icon>;
        const Upload = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></Icon>;
        const Settings = (props) => <Icon {...props}><circle cx="12" cy="12" r="3" /><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" /></Icon>;
        const Key = (props) => <Icon {...props}><path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" /></Icon>;
        const CircleHelp = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" /><line x1="12" y1="17" x2="12.01" y2="17" /></Icon>;
        const ArrowRight = (props) => <Icon {...props}><line x1="5" y1="12" x2="19" y2="12" /><polyline points="12 5 19 12 12 19" /></Icon>;
        const RotateCw = (props) => <Icon {...props}><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.75-2.75l-2.25 2.25" /><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.75 2.75l2.25-2.25" /></Icon>;
        const RotateCcw = (props) => <Icon {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></Icon>;
        const Droplet = (props) => <Icon {...props}><path d="M12 2a10 10 0 0 0-3.54 19.34l-1.09-1.9A8 8 0 0 1 12 4a8 8 0 0 1 4.63 1.34l1.09-1.9A10 10 0 0 0 12 2z" /></Icon>;
        const Sunrise = (props) => <Icon {...props}><path d="M12 2v2" /><path d="M16.21 4.79l-1.42 1.42" /><path d="M18 12h2" /><path d="M16.21 19.21l-1.42-1.42" /><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" /><path d="M12 22v-2" /><path d="M7.79 19.21l1.42-1.42" /><path d="M4 12h2" /><path d="M7.79 4.79l1.42 1.42" /></Icon>;
        const Bolt = (props) => <Icon {...props}><path d="M15 4V2H9v2h6zM9 18v2h6v-2H9zM19 8H5c-1.1 0-2 .9-2 2v6c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-6c0-1.1-.9-2-2-2zM9 12v-2h6v2H9z" /></Icon>;
        const Brain = (props) => <Icon {...props}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z" /><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z" /></Icon>;
        // NEW: Flask Icon for Homebrew Lab
        const FlaskConical = (props) => <Icon {...props}><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2" /><path d="M8.5 2h7" /><path d="M7 16h10" /></Icon>;
        const Grid = (props) => <Icon {...props}><rect width="7" height="7" x="3" y="3" rx="1" /><rect width="7" height="7" x="14" y="3" rx="1" /><rect width="7" height="7" x="14" y="14" rx="1" /><rect width="7" height="7" x="3" y="14" rx="1" /></Icon>;
        const ChevronDown = (props) => <Icon {...props}><path d="m6 9 6 6 6-6"/></Icon>;
        const ChevronRight = (props) => <Icon {...props}><path d="m9 18 6-6-6-6"/></Icon>;
        const ChevronLeft = (props) => <Icon {...props}><path d="m15 18-6-6 6-6"/></Icon>;
        // NEW: Search Icon
        const Search = (props) => <Icon {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></Icon>;
        // NEW: Filter Icon
        const Filter = (props) => <Icon {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></Icon>;
        // NEW: Info Icon for Changelog
        const Info = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></Icon>;

        // NEW: Custom Dragon Head Icon - UPDATED to look like a beast/monster face
        const DragonHead = (props) => (
            <Icon {...props}>
                <path d="M11 2a9 9 0 0 0-9 9v7a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-7a9 9 0 0 0-9-9z M8 13a2 2 0 1 1 0-4 2 2 0 0 1 0 4z M16 13a2 2 0 1 1 0-4 2 2 0 0 1 0 4z M12 18a4 4 0 0 1-4-2h8a4 4 0 0 1-4 2z" />
            </Icon>
        );
        // NEW: Custom Castle Gate Icon
        const CastleGate = (props) => (
            <Icon {...props}>
                <path d="M19 21v-8a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v8"/><path d="M4 11V7"/><path d="M20 11V7"/><path d="M2 7h4v4H2z"/><path d="M18 7h4v4h-4z"/><path d="M4 7l2-4 2 4"/><path d="M18 7l2-4 2 4"/><path d="M10 21v-4a2 2 0 0 1 4 0v4"/>
            </Icon>
        );
        // NEW: Sort/Order Icon
        const ArrowDownUp = (props) => (
            <Icon {...props}>
                <path d="m3 16 4 4 4-4" /><path d="M7 20V4" /><path d="m21 8-4-4-4 4" /><path d="M17 4v16" />
            </Icon>
        );
        // NEW: Dice Icon for Dice Roller
        const Dices = (props) => <Icon {...props}><path d="m21 16-5.87-4.4a1 1 0 0 0-1.12-.08L9 15"/><path d="M11.5 11 9 15l-2.43 1.82a1 1 0 0 0 .09 1.63L12 21l4.58-2.32a1 1 0 0 0 .5-1.12z"/><path d="M15 9l-3.07-2.3a1 1 0 0 0-1.21-.08L6 10l-1.38 3a1 1 0 0 0 .09 1.07l2.25 3L9 15l2.5-4"/><path d="M2 12h5"/><path d="M22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6z"/></Icon>;
        // NEW: History/Log Icon
        const ScrollText = (props) => <Icon {...props}><path d="M8 21h12a2 2 0 0 0 2-2v-2H10v2a2 2 0 1 1-4 0V5a2 2 0 1 0-4 0v3h4"/><path d="M19 17V5a2 2 0 0 0-2-2H4"/></Icon>;
        // NEW: Database Icon for Homebrew Bank
        const Database = (props) => <Icon {...props}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></Icon>;
        // NEW: D20 Icon
        const D20Icon = (props) => <Icon {...props}><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 7v10l10 5 10-5V7" /><path d="M12 22V12" /></Icon>;


        const CONDITIONS = [
            { name: 'Blinded', color: 'bg-gray-600' },
            { name: 'Charmed', color: 'bg-pink-600' },
            { name: 'Deafened', color: 'bg-gray-500' },
            { name: 'Frightened', color: 'bg-purple-600' },
            { name: 'Grappled', color: 'bg-orange-700' },
            { name: 'Incapacitated', color: 'bg-red-800' },
            { name: 'Invisible', color: 'bg-blue-400' },
            { name: 'Paralyzed', color: 'bg-yellow-600' },
            { name: 'Petrified', color: 'bg-stone-500' },
            { name: 'Poisoned', color: 'bg-green-600' },
            { name: 'Prone', color: 'bg-indigo-700' },
            { name: 'Restrained', color: 'bg-orange-800' },
            { name: 'Stunned', color: 'bg-yellow-500' },
            { name: 'Unconscious', color: 'bg-black' },
        ];

        const MONSTER_TYPES = [
            "Aberration", "Beast", "Celestial", "Construct", "Dragon", "Elemental", 
            "Fey", "Fiend", "Giant", "Humanoid", "Monstrosity", "Ooze", "Plant", "Undead", "Unknown"
        ];
        
        // UTILITY FUNCTION to infer type from stat block (Deep Scan Import feature)
        const inferTypeFromStatBlock = (summary) => {
            if (!summary) return 'Unknown';
            const lowerSummary = summary.toLowerCase();
            
            // Look for the standard format, e.g., "Medium humanoid (elf), chaotic good"
            const match = lowerSummary.match(/\((.*?)\)/);
            let candidateType = 'Unknown';
            
            if (match && match[1]) {
                // Check within the first parenthesis for a known type
                const potentialTypes = match[1].split(',').map(s => s.trim());
                for (const potential of potentialTypes) {
                    const typeMatch = MONSTER_TYPES.find(type => potential.startsWith(type.toLowerCase()));
                    if (typeMatch) return typeMatch;
                }
            }
            
            // Fallback: Check the entire summary for an exact type match
            for (const type of MONSTER_TYPES) {
                if (type !== 'Unknown' && lowerSummary.includes(type.toLowerCase())) {
                    candidateType = type; // Use the first match as best effort
                }
            }
            
            return candidateType;
        };


        // DM SCREEN CONTENT - COMPREHENSIVE
        const RULES_DATA = [
            {
                category: "Conditions & Exhaustion",
                items: [
                    { title: "Blinded", text: "Auto-fail sight checks. Atks vs you have Adv. Your atks have Disadv." },
                    { title: "Charmed", text: "Can't attack charmer. Charmer has Adv on social checks vs you." },
                    { title: "Deafened", text: "Auto-fail hearing checks." },
                    { title: "Frightened", text: "Disadv on checks/atks while source is seen. Can't move closer to source." },
                    { title: "Grappled", text: "Speed 0. Ends if grappler incapacitated or moved away." },
                    { title: "Incapacitated", text: "No Actions or Reactions." },
                    { title: "Invisible", text: "Considered Heavily Obscured. Atks vs you Disadv. Your atks Adv." },
                    { title: "Paralyzed", text: "Incapacitated. Auto-fail Str/Dex saves. Atks vs you have Adv & Auto-Crit if within 5ft." },
                    { title: "Petrified", text: "Incapacitated. Resistance to all dmg. Immune to Poison/Disease." },
                    { title: "Poisoned", text: "Disadv on Atk rolls and Ability Checks." },
                    { title: "Prone", text: "Crawl (½ speed). Atks vs you have Adv (within 5ft) or Disadv (outside 5ft). Your atks Disadv." },
                    { title: "Restrained", text: "Speed 0. Atks vs you Adv. Your atks Disadv. Disadv on Dex saves." },
                    { title: "Stunned", text: "Incapacitated. Auto-fail Str/Dex saves. Atks vs you have Adv." },
                    { title: "Unconscious", text: "Incapacitated & Prone. Auto-fail Str/Dex saves. Atks vs you Adv & Auto-Crit if 5ft." },
                    { title: "Exhaustion Lvl 1", text: "Disadvantage on Ability Checks." },
                    { title: "Exhaustion Lvl 2", text: "Speed halved." },
                    { title: "Exhaustion Lvl 3", text: "Disadvantage on Attack rolls and Saving throws." },
                    { title: "Exhaustion Lvl 4", text: "Hit point maximum halved." },
                    { title: "Exhaustion Lvl 5", text: "Speed reduced to 0." },
                    { title: "Exhaustion Lvl 6", text: "Death." }
                ]
            },
            {
                category: "Combat Actions & Rules",
                items: [
                    { title: "Attack", text: "Make melee or ranged attack. Can split move between attacks." },
                    { title: "Cast a Spell", text: "Cast time: 1 action. (Bonus action spells limit action to Cantrip only)." },
                    { title: "Dash", text: "Gain extra movement for current turn equal to speed." },
                    { title: "Disengage", text: "Movement doesn't provoke opportunity attacks." },
                    { title: "Dodge", text: "Atks vs you have Disadv. Dex saves have Adv. (Must see attacker)." },
                    { title: "Help", text: "Give ally Adv on next check/attack before your next turn." },
                    { title: "Hide", text: "Stealth check vs Passive Perception. Must break LoS." },
                    { title: "Ready", text: "Trigger reaction on specific condition. Hold spell requires conc." },
                    { title: "Search", text: "Dedicate action to Perception or Investigation check." },
                    { title: "Use Object", text: "Interact with an object requiring specific action (e.g. potion)." },
                    { title: "Two-Weapon Fighting", text: "Bonus action to attack with off-hand light weapon. No ability mod to dmg (unless Negative)." },
                    { title: "Grapple", text: "Attack action (can replace one attack). Athletics vs Athletics/Acrobatics." },
                    { title: "Shove", text: "Attack action. Athletics vs Athletics/Acrobatics. Success: Prone or push 5ft." },
                    { title: "Cover (Half)", text: "+2 AC and Dex Saves." },
                    { title: "Cover (3/4)", text: "+5 AC and Dex Saves." },
                    { title: "Cover (Total)", text: "Cannot be targeted directly." },
                    { title: "Opportunity Attack", text: "Reaction when enemy leaves reach. Disengage prevents this." }
                ]
            },
            {
                category: "Movement & Travel",
                items: [
                    { title: "Travel Pace (Fast)", text: "400ft/min, 4 miles/hr, 30 miles/day. -5 Passive Perception." },
                    { title: "Travel Pace (Normal)", text: "300ft/min, 3 miles/hr, 24 miles/day." },
                    { title: "Travel Pace (Slow)", text: "200ft/min, 2 miles/hr, 18 miles/day. Able to use Stealth." },
                    { title: "Forced March", text: "Con Save DC 10 + 1 per hour past 8 hours. Fail: 1 level Exhaustion." },
                    { title: "Difficult Terrain", text: "Half speed (cost 2ft per 1ft moved)." },
                    { title: "Climbing/Swimming", text: "Half speed unless you have climb/swim speed." },
                    { title: "Long Jump", text: "Running: Distance = Str Score. Standing: Half that." },
                    { title: "High Jump", text: "Running: Height = 3 + Str Mod. Standing: Half that." }
                ]
            },
            {
                category: "Environment, Light & Vision",
                items: [
                    { title: "Bright Light", text: "Normal vision." },
                    { title: "Dim Light", text: "Lightly Obscured. Disadvantage on Perception (sight)." },
                    { title: "Darkness", text: "Heavily Obscured. Effectively Blinded." },
                    { title: "Blindsight", text: "Perceive surroundings without sight (oozes, bats)." },
                    { title: "Darkvision", text: "See in Dim as Bright, Dark as Dim (No colors)." },
                    { title: "Truesight", text: "See in normal/magical darkness, see invisible, see through illusions/shapechangers." },
                    { title: "Suffocation", text: "Hold breath: 1 + Con Mod mins (min 30s). Then Con Mod rounds to 0 HP." },
                    { title: "Falling", text: "1d6 bludgeoning per 10ft (max 20d6). Land prone unless avoided." },
                    { title: "Food/Water", text: "Need 1lb food/day. Need 1 gal water/day (2 if hot). Half water = DC 15 Con save or Exhaustion." }
                ]
            },
            {
                category: "Resting, Healing & Death",
                items: [
                    { title: "Short Rest", text: "1 hour. Spend Hit Dice to heal (add Con mod per die)." },
                    { title: "Long Rest", text: "8 hours. Regain all HP and ½ max Hit Dice. Lose all Exhaustion levels (if 1 per day)." },
                    { title: "Death Saves", text: "Start turn at 0 HP. 10+ success. 3 success = stable. 3 fail = dead. Nat 1 = 2 fails. Nat 20 = 1 HP." },
                    { title: "Stabilize", text: "Action. Medicine DC 10. Target no longer makes death saves." },
                    { title: "Instant Death", text: "Damage reduces to 0 and remainder >= Max HP." },
                    { title: "Knock Out", text: "Melee attacker reducing creature to 0 HP can choose to knock unconscious (stable) instead of kill." },
                    { title: "Potion of Healing", text: "Action to drink. Heals 2d4 + 2." }
                ]
            },
            {
                category: "Ability Checks & DCs",
                items: [
                    { title: "Very Easy", text: "DC 5" },
                    { title: "Easy", text: "DC 10" },
                    { title: "Medium", text: "DC 15" },
                    { title: "Hard", text: "DC 20" },
                    { title: "Very Hard", text: "DC 25" },
                    { title: "Nearly Impossible", text: "DC 30" },
                    { title: "Strength", text: "Athletics (Climb, Jump, Swim, Grapple, Shove, Break)." },
                    { title: "Dexterity", text: "Acrobatics (Balance, Tumble), Sleight of Hand, Stealth, Pick Lock." },
                    { title: "Intelligence", text: "Arcana, History, Investigation (Search), Nature, Religion." },
                    { title: "Wisdom", text: "Animal Handling, Insight (Lie detect), Medicine, Perception (Spot), Survival (Track)." },
                    { title: "Charisma", text: "Deception, Intimidation, Performance, Persuasion." },
                    { title: "Contests", text: "e.g. Grapple: Str (Athletics) vs Str (Athletics) or Dex (Acrobatics)." }
                ]
            },
            {
                category: "Spellcasting",
                items: [
                    { title: "Concentration", text: "End if: Cast another conc spell, take damage (Con save DC 10 or half dmg), incapacitated." },
                    { title: "Ritual", text: "+10 mins casting time. Does not expend spell slot." },
                    { title: "Components", text: "Verbal (speak), Somatic (gesture), Material (focus/pouch unless cost listed)." },
                    { title: "Line", text: "Line from origin. Width = 5ft usually." },
                    { title: "Cone", text: "Width at furthest point = Length." },
                    { title: "Cube", text: "Origin can be on face or corner." },
                    { title: "Sphere", text: "Origin is center." },
                    { title: "Cylinder", text: "Origin is center of circular top/bottom." }
                ]
            },
            {
                category: "Objects & Structures",
                items: [
                    { title: "AC - Cloth/Paper", text: "11" },
                    { title: "AC - Crystal/Glass/Ice", text: "13" },
                    { title: "AC - Wood/Bone", text: "15" },
                    { title: "AC - Stone", text: "17" },
                    { title: "AC - Iron/Steel", text: "19" },
                    { title: "AC - Mithral", text: "21" },
                    { title: "AC - Adamantine", text: "23" },
                    { title: "HP - Tiny (Bottle/Lock)", text: "2 (fragile) / 5 (resilient)" },
                    { title: "HP - Small (Chest/Lute)", text: "3 (fragile) / 10 (resilient)" },
                    { title: "HP - Medium (Barrel/Door)", text: "4 (fragile) / 18 (resilient)" },
                    { title: "HP - Large (Cart/Window)", text: "5 (fragile) / 27 (resilient)" }
                ]
            },
            {
                category: "Equipment & Services",
                items: [
                    { 
                        title: "General Store", 
                        text: "Torch: 1 cp (1 hr light, 20ft bright/20ft dim)\n\nRope, Hempen (50ft): 1 gp\nRope, Silk (50ft): 10 gp\n\nRations (1 day): 5 sp\nWaterskin: 2 sp\n\nBedroll: 1 gp\nBackpack: 2 gp\n\nHealer's Kit: 5 gp (10 uses, stabilize without check)" 
                    },
                    { 
                        title: "Potions & Healing", 
                        text: "--- Potions ---\nPotion of Healing: 50 gp (2d4+2)\nPotion of Greater Healing: 150 gp (4d4+4)\nPotion of Superior Healing: 500 gp (8d4+8)\nPotion of Supreme Healing: 5000 gp (10d4+20)\n\n--- Temple Services (Donation + Components) ---\nCure Wounds (1st Lvl): 10 gp\nLesser Restoration: 40 gp\nRemove Curse: 90 gp\nRevivify: 600 gp (incl. 300gp diamond)\nGreater Restoration: 450 gp (incl. 100gp dust)\nRaise Dead: 1,250 gp (incl. 500gp diamond)" 
                    },
                    { 
                        title: "Inn & Tavern", 
                        text: "--- Lodging (Per Night) ---\nSqualid: 7 cp\nPoor: 1 sp\nModest: 5 sp\nComfortable: 8 sp\nWealthy: 2 gp\nAristocratic: 4 gp+\n\n--- Food & Drink ---\nMug of Ale: 4 cp\nGallon of Ale: 2 sp\nPitcher of Common Wine: 2 sp\nBottle of Fine Wine: 10 gp\n\nMeal - Squalid: 3 cp (Gruel/Scraps)\nMeal - Poor: 6 cp (Bread & Cheese)\nMeal - Modest: 3 sp (Stew & Bread)\nMeal - Comfortable: 5 sp (Roast & Sides)\nMeal - Wealthy: 8 sp (Multi-course)\nMeal - Aristocratic: 2 gp (Exotic/Fine dining)" 
                    },
                    {
                        title: "Guild & Faction Services",
                        text: "--- The Harpers (Spies & Secret Agents) ---\nGoal: Preserve balance, oppose tyranny & abuse of power.\nServices: Information gathering (10-50 gp), Safehouse lodging (Free for allies), Lore/History consultation.\n\n--- The Zhentarim (Mercenaries & Assassins) ---\nGoal: Amass wealth and power to dominate/protect.\nServices: Assassination (500 gp+ depending on target), Smuggling (20% fee), Black Market Access, Hired Muscle (2 gp/day).\n\n--- Order of the Gauntlet (Paladins & Clerics) ---\nGoal: Smite evil, protect the innocent with vigilance.\nServices: Armed Escort (10 gp/day), Divine Spellcasting (see Temple), Monster Hunting assistance.\n\n--- The Emerald Enclave (Druids & Rangers) ---\nGoal: Restore and preserve the natural order.\nServices: Wilderness Guides (5 gp/day), Animal Messengers (10 gp), Rare Herbs/Antidotes.\n\n--- The Lords' Alliance (Political Coalition) ---\nGoal: Maintain civilization and stability through alliance.\nServices: Legal Aid/Bounties, High-level Diplomacy, Travel Papers/Letters of Marque.\n\n--- Local Thieves' Guild ---\nGoal: Profit through crime, control local underworld.\nServices: Fencing Stolen Goods (buys at 50% value), Forgery (15-50 gp), Lockpicking/Trap Disarming (20 gp)."
                    }
                ]
            }
        ];

        // --- VERSION CONTROL ---
        const CURRENT_VERSION = "1.1.75";
        const CHANGELOG_DATA = [
            {
                version: "1.1.75",
                date: "Current",
                changes: [
                    "General Bug Fixes & Stability Improvements.",
                    "Enhanced Homebrew Import: Now automatically detects monster types from descriptions.",
                    "Removed redundant code and optimized performance."
                ]
            },
            {
                version: "1.1.50",
                date: "Previous",
                changes: [
                    "Removed persistent auto-sort button from header.",
                    "Deep Scan Import: Smartly detects monster types from the stat block text if missing.",
                    "Updated Help Section icons to match the new Castle Gate and Ghost themes.",
                    "Updated icons: Brew Monster (Ghost) and Battlefield (Castle Gate).",
                    "Added navigation icons to main tabs for better visibility.",
                    "Improved Setup Layout: Add/Reset buttons now span the full width below inputs.",
                    "Code Sweep: Centered all icon-only buttons for easier tapping.",
                    "Half-version update focused on Stability & UX Polish.",
                    "Added Error Boundary to prevent white-screen crashes.",
                    "Major Performance Upgrade: Extracted Combatant Cards.",
                    "HTML sanitization for AI stat blocks.",
                    "Preserved all existing features."
                ]
            },
            {
                version: "1.1.00",
                date: "Previous",
                changes: [
                    "Added Homebrew Backup & Restore (JSON export/import).",
                    "Added Monster Type classification (Aberration, Beast, etc.) to Homebrew.",
                    "Enhanced Homebrew Search (Filter by Name or Type).",
                    "Added Sorting & Grouping by Monster Type in Homebrew Bank.",
                    "Improved mobile responsiveness for Setup form and floating buttons.",
                    "Added this Changelog system!"
                ]
            }
        ];

        const INITIAL_FORM = { name: '', hp: '', ac: '', initiative: '', initMod: 0, qty: 1 };
        const INITIAL_MONSTER_DETAILS = { resistances: '', vulnerabilities: '', actions: '', statBlockSummary: '', type: '' };
        const HARDCODED_API_KEY = ""; 
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        const rollInitiative = (mod) => Math.floor(Math.random() * 20) + 1 + mod;
        
        // ROBUSTNESS UTILS
        const safeLoad = (key, fallback) => { try { const item = localStorage.getItem(key); return item ? JSON.parse(item) : fallback; } catch (e) { console.warn(`Corrupt data for ${key}, using fallback.`); return fallback; } };
        const sanitizeHtml = (str) => { if (!str) return ''; return str.replace(/<script\b[^>]*>([\s\S]*?)<\/script>/gm, "").replace(/on\w+="[^"]*"/g, ""); };

        const INPUT_CLASS = "w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 focus:outline-none focus:border-indigo-500 text-sm";

        const handleInputBlur = () => { 
            setTimeout(() => { 
                if (document.activeElement === document.body) { 
                    window.scrollTo({ top: 0, behavior: 'smooth' }); 
                } 
            }, 150); 
        };
        
        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, errorInfo) { console.error("Uncaught error:", error, errorInfo); }
            handleReset = () => { if(confirm("This will clear local storage to fix the crash. Continue?")) { localStorage.clear(); window.location.reload(); } };
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen bg-slate-950 flex items-center justify-center p-4 text-center">
                            <div className="bg-slate-900 p-8 rounded-xl border border-red-900 shadow-2xl max-w-md">
                                <AlertTriangle size={48} className="text-red-500 mx-auto mb-4" />
                                <h1 className="text-2xl font-bold text-white mb-2">Magical Feedback Loop Detected</h1>
                                <p className="text-slate-400 mb-6">The Akashic Tome has encountered a critical error. The Weave is unstable.</p>
                                <button onClick={this.handleReset} className="bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-6 rounded-lg w-full transition-colors">Perform Ritual of Restoration (Reset Data)</button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- SUBCOMPONENTS ---
        const ProgressBar = memo(({ current, max, isPlayer }) => {
            if (max <= 0) return <div className="text-xs text-indigo-400 italic text-center py-2 border border-indigo-900/50 rounded bg-slate-900/30">{isPlayer ? 'HP Not Tracked' : 'No Max HP'}</div>;
            const pct = Math.max(0, Math.min(100, (current / max) * 100));
            const color = pct <= 25 ? 'bg-red-600' : pct <= 50 ? 'bg-yellow-500' : 'bg-green-500';
            return <div className="h-4 w-full bg-slate-700 rounded-full overflow-hidden mt-2 relative border border-slate-600"><div className={`h-full transition-all duration-300 ease-out ${current===0 ? 'bg-gray-700' : color}`} style={{ width: `${pct}%` }} /><div className="absolute top-0 left-0 w-full h-full flex items-center justify-center text-xs font-bold text-white shadow-sm drop-shadow-md">{current} / {max} HP</div></div>;
        });
        
        const DeathSaveTracker = memo(({ saves, id, onToggle }) => {
                return (
                    <div className="mt-2 p-2 bg-slate-900/80 rounded border border-red-900 flex flex-col gap-1">
                    <div className="flex items-center justify-between text-[10px] text-slate-400 font-bold uppercase"><span>Death Saves</span></div>
                    <div className="flex items-center justify-between gap-2">
                            <div className="flex items-center gap-1"><span className="text-[10px] text-green-500 font-bold w-4">Suc</span>
                            {[0, 1, 2].map(i => (
                                <button key={`suc-${i}`} onClick={() => onToggle(id, 'successes', i)} className={`w-4 h-4 rounded-full border border-green-600 flex items-center justify-center transition-colors ${saves.successes > i ? 'bg-green-600' : 'bg-transparent hover:bg-green-900'}`}></button>
                            ))}
                            </div>
                            <div className="flex items-center gap-1"><span className="text-[10px] text-red-500 font-bold w-4">Fail</span>
                            {[0, 1, 2].map(i => (
                                <button key={`fail-${i}`} onClick={() => onToggle(id, 'failures', i)} className={`w-4 h-4 rounded-full border border-red-600 flex items-center justify-center transition-colors ${saves.failures > i ? 'bg-red-600' : 'bg-transparent hover:bg-red-900'}`}></button>
                            ))}
                            </div>
                    </div>
                    </div>
                );
        });

        const MonsterActionDetails = ({ combatant }) => {
            const chips = [ {l:'Resistances', i:<Shield size={12} className="text-blue-400"/>, c:'text-blue-400', v:combatant.resistances}, {l:'Vulnerabilities', i:<Droplet size={12} className="text-red-400"/>, c:'text-red-400', v:combatant.vulnerabilities} ];
            const acts = combatant.actions ? combatant.actions.split(',').map(a=>a.trim()).filter(a=>a) : [];
            return (
                <div className="mt-3 space-y-2">
                    <div className="space-y-1">{chips.map(d => <div key={d.l} className="flex items-center gap-2 text-xs font-medium bg-slate-900/50 p-1.5 rounded border border-slate-700">{d.i}<span className={d.c}>{d.l}:</span><span className="text-white flex-1 truncate" title={d.v||'None'}>{d.v||'None'}</span></div>)}</div>
                    {acts.length > 0 && <div className="pt-2 border-t border-slate-700/50"><h5 className="text-xs font-bold text-yellow-400 mb-1 flex items-center gap-1"><Bolt size={12}/> Actions:</h5><ul className="space-y-0.5 pl-3 text-white text-xs list-disc list-inside">{acts.map((a,i)=><li key={i} className="pl-1 leading-tight">{a}</li>)}</ul></div>}
                </div>
            );
        };

        // NEW: Extracted Combatant Card for Performance
        const CombatantCard = memo(({ 
            combatant: c, 
            active, 
            onUpdateHealth, 
            onToggleConcentration, 
            onToggleActionDetails, 
            onNarrate, 
            onDelete, 
            onStatBlock, 
            onToggleCondition,
            onToggleDeathSave,
            openActionDetailsId,
            openConditionId,
            setOpenConditionId,
            narration,
            isNarrating
        }) => {
            // Local state for damage input prevents full app re-renders on typing
            const [localDmg, setLocalDmg] = useState('');

            const handleLocalDmgSubmit = (e) => {
                e.preventDefault();
                const val = parseInt(localDmg);
                if (!isNaN(val) && val !== 0) {
                    onUpdateHealth(c.id, -val);
                    setLocalDmg('');
                }
            };

            return (
                <div id={`card-${c.id}`} className={`relative flex flex-col p-4 rounded-xl border shadow-md transition-all ${active ? 'ring-2 ring-green-500 border-green-500 bg-slate-800' : 'bg-slate-800 border-slate-600'}`}>
                    {active && <div className="absolute -top-3 left-1/2 -translate-x-1/2 bg-green-600 text-white text-[10px] font-bold px-2 py-0.5 rounded">ACTIVE</div>}
                    {c.isConcentrating && <div className="absolute -top-1 -right-1"><span className="flex h-3 w-3"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-sky-400 opacity-75"></span><span className="relative inline-flex rounded-full h-3 w-3 bg-sky-500"></span></span></div>}
                    
                    <div className="flex justify-between items-start mb-2">
                        <div><h3 className={`font-bold text-lg ${c.type==='player'?'text-indigo-300':'text-white'}`}>{c.type === 'player' && <User size={16} />}{c.name}</h3><div className="text-xs text-slate-400 mt-1 flex gap-3"><span>AC: {c.ac}</span><span>Init: {c.initiative}</span></div></div>
                        <div className="flex gap-1">
                            <button onClick={() => onToggleConcentration(c.id)} className={`p-1 hover:text-white transition-colors ${c.isConcentrating ? 'text-sky-400' : 'text-slate-600'} flex items-center justify-center`} title="Toggle Concentration"><Brain size={16} /></button>
                            {c.statBlockSummary && <button onClick={()=>onStatBlock(c)} className="text-slate-500 hover:text-white p-1 flex items-center justify-center"><CircleHelp size={18}/></button>}
                            {c.actions && <button onClick={()=>onToggleActionDetails(c.id)} className={`text-slate-500 hover:text-white p-1 ${openActionDetailsId===c.id?'text-indigo-400':''} flex items-center justify-center`}><BookOpen size={18}/></button>}
                            <button onClick={()=>onNarrate(c)} className="text-slate-500 hover:text-white p-1 flex items-center justify-center">{isNarrating?<Loader2 size={16} className="animate-spin"/>:<MessageSquare size={16}/>}</button>
                            <button onClick={()=>onDelete(c.id)} className="text-slate-500 hover:text-red-400 p-1 flex items-center justify-center"><Trash2 size={16}/></button>
                        </div>
                    </div>
                    {openActionDetailsId===c.id && <div className="mb-3 bg-slate-900/50 p-2 rounded border border-slate-700"><MonsterActionDetails combatant={c}/></div>}
                    <ProgressBar current={c.currentHp} max={c.maxHp} isPlayer={c.type==='player'}/>
                    
                    {/* DEATH SAVES for Players at 0 HP */}
                    {c.type === 'player' && c.currentHp === 0 && <DeathSaveTracker saves={c.deathSaves} id={c.id} onToggle={onToggleDeathSave} />}
                    
                    {c.maxHp>0 && (
                        <div className="flex gap-2 mt-2">
                            <button onClick={()=>onUpdateHealth(c.id,-1)} className="p-1 bg-slate-700 rounded text-red-300 hover:bg-slate-600 flex items-center justify-center" style={{touchAction: 'manipulation'}}><Minus size={14}/></button>
                            <button onClick={()=>onUpdateHealth(c.id,1)} className="p-1 bg-slate-700 rounded text-green-300 hover:bg-slate-600 flex items-center justify-center" style={{touchAction: 'manipulation'}}><Plus size={14}/></button>
                            <form onSubmit={handleLocalDmgSubmit} className="flex-1">
                                <input className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-xs text-center" placeholder="Dmg" value={localDmg} onChange={e=>setLocalDmg(e.target.value)} />
                            </form>
                        </div>
                    )}
                    {narration && <div className="mt-2 text-xs text-indigo-300 italic">"{narration}"</div>}
                    <div className="mt-3 pt-2 border-t border-slate-700/50">
                        <div className="flex flex-wrap gap-1">
                            {c.conditions.map(cond=><span key={cond} onClick={()=>onToggleCondition(c.id,cond)} className="px-1.5 py-0.5 bg-slate-700 rounded text-[10px] cursor-pointer hover:bg-red-900/50">{cond} ×</span>)}
                            <button onClick={()=>{setOpenConditionId(openConditionId===c.id?null:c.id)}} className="px-1.5 py-0.5 bg-slate-700/50 rounded text-[10px] text-slate-400 hover:text-white">+ Cond</button>
                        </div>
                        {openConditionId===c.id && (
                            <div className="mt-2 grid grid-cols-2 gap-1 bg-slate-900 p-2 rounded absolute z-20 w-full left-0 shadow-xl border border-slate-600">
                                {CONDITIONS.map(cond=><button key={cond.name} onClick={()=>onToggleCondition(c.id,cond.name)} className="text-left text-[10px] p-1 hover:bg-slate-700 rounded text-slate-300" style={{touchAction: 'manipulation'}}>{cond.name}</button>)}
                            </div>
                        )}
                    </div>
                </div>
            );
        });
        
        // NEW: Battle Log Modal
        const BattleLogModal = ({ logs, onClose, onClear }) => {
            const bottomRef = useRef(null);
            useEffect(() => { bottomRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [logs]);
            return (
                <div className="fixed inset-0 z-[120] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
                    <div className="bg-gray-900 w-full max-w-lg rounded-xl shadow-2xl border border-gray-700 flex flex-col h-[70vh]">
                        <div className="flex justify-between items-center p-4 border-b border-gray-700 bg-gray-800 rounded-t-xl"><h2 className="text-xl font-bold text-white flex items-center gap-2"><ScrollText className="text-indigo-400" /> Battle Log</h2><button onClick={onClose}><X size={24} className="text-gray-400 hover:text-white"/></button></div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-900/50">
                            {logs.length === 0 ? <p className="text-slate-500 text-center text-sm italic py-4">The chronicles are empty...</p> : 
                            logs.map((log, i) => (
                                <div key={i} className={`text-sm p-2 rounded border-l-2 ${log.type==='damage'?'border-red-500 bg-red-900/10 text-red-200': log.type==='heal'?'border-green-500 bg-green-900/10 text-green-200': log.type==='turn'?'border-yellow-500 bg-yellow-900/10 text-yellow-200': 'border-slate-500 bg-slate-800 text-slate-300'}`}>
                                    <span className="text-[10px] text-slate-500 block mb-0.5 uppercase tracking-wider">{new Date(log.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'})}</span>
                                    {log.message}
                                </div>
                            ))}
                            <div ref={bottomRef} />
                        </div>
                        <div className="p-3 border-t border-gray-700 bg-gray-800 rounded-b-xl flex justify-between">
                            <button onClick={onClear} className="text-xs text-red-400 hover:text-red-300">Clear Log</button>
                            <button onClick={onClose} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded text-sm font-bold">Close</button>
                        </div>
                    </div>
                </div>
            );
        };

        // NEW: Changelog Modal
        const ChangelogModal = ({ onClose }) => {
            return (
                <div className="fixed inset-0 z-[120] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
                    <div className="bg-gray-900 w-full max-w-lg rounded-xl shadow-2xl border border-gray-700 flex flex-col max-h-[80vh]">
                        <div className="flex justify-between items-center p-4 border-b border-gray-700 bg-gray-800 rounded-t-xl">
                            <h2 className="text-xl font-bold text-white flex items-center gap-2">
                                <Info className="text-amber-400" /> Changelog
                            </h2>
                            <button onClick={onClose}><X size={24} className="text-gray-400 hover:text-white"/></button>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            {CHANGELOG_DATA.map((log, index) => (
                                <div key={index} className="mb-6 last:mb-0">
                                    <div className="flex justify-between items-center mb-2">
                                        <h3 className="text-lg font-bold text-amber-400">Version {log.version}</h3>
                                        <span className="text-xs text-slate-500 bg-slate-800 px-2 py-1 rounded">{log.date}</span>
                                    </div>
                                    <ul className="space-y-2">
                                        {log.changes.map((change, i) => (
                                            <li key={i} className="text-sm text-slate-300 flex items-start gap-2">
                                                <span className="text-amber-500 mt-1">•</span>
                                                {change}
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            ))}
                        </div>
                        <div className="p-4 border-t border-gray-700 bg-gray-800 rounded-b-xl flex justify-end">
                            <button onClick={onClose} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded text-sm font-bold">Close</button>
                        </div>
                    </div>
                </div>
            );
        };

        // NEW: Dice Roller Modal
        const DiceRollerModal = ({ onClose, addToLog }) => {
            const [history, setHistory] = useState([]);
            const [mod, setMod] = useState(0); // number
            const [count, setCount] = useState(1); // number
            const [selectedDie, setSelectedDie] = useState(20); // number of sides

            const roll = () => {
                const sides = selectedDie;
                const n = Math.max(1, parseInt(count) || 1);
                const m = parseInt(mod) || 0;
                
                let totalRaw = 0;
                let rolls = [];
                
                for(let i=0; i<n; i++) {
                    const r = Math.floor(Math.random() * sides) + 1;
                    rolls.push(r);
                    totalRaw += r;
                }
                
                const total = totalRaw + m;
                const rollStr = `[${rolls.join(', ')}]`;
                const diceStr = `${n}d${sides}`;
                const modStr = m !== 0 ? (m > 0 ? `+${m}` : m) : '';
                
                const result = { 
                    desc: `${diceStr}${modStr}`, 
                    detail: `${rollStr} ${modStr} = `,
                    total: total,
                    isCrit: (sides === 20 && n === 1 && rolls[0] === 20),
                    isFail: (sides === 20 && n === 1 && rolls[0] === 1),
                    id: Date.now() 
                };
                
                setHistory(prev => [result, ...prev].slice(0, 20));
                addToLog(`Rolled ${result.desc}: ${rollStr}${modStr} = ${total}`, 'roll');
            };

            return (
                 <div className="fixed inset-0 z-[120] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
                    <div className="bg-gray-900 w-full max-w-sm rounded-xl shadow-2xl border border-gray-700 flex flex-col max-h-[90vh]">
                        {/* Header */}
                        <div className="flex justify-between items-center p-4 border-b border-gray-700 bg-gray-800 rounded-t-xl shrink-0">
                            <h2 className="text-xl font-bold text-white flex items-center gap-2">
                                <D20Icon className="text-green-400 w-6 h-6" /> Dice Roller
                            </h2>
                            <button onClick={onClose}><X size={24} className="text-gray-400 hover:text-white"/></button>
                        </div>
                        
                        <div className="p-5 space-y-5 overflow-y-auto flex-1">
                            {/* Die Selector */}
                            <div>
                                <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Select Die</label>
                                <div className="flex flex-wrap gap-2 justify-center">
                                    {[4,6,8,10,12,20,100].map(d => (
                                        <button 
                                            key={d} 
                                            onClick={() => setSelectedDie(d)} 
                                            className={`w-10 h-10 rounded font-bold font-mono transition-all ${selectedDie === d ? 'bg-indigo-600 text-white ring-2 ring-indigo-400 scale-110' : 'bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white'}`}
                                        >
                                            d{d}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Inputs Row */}
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-300 uppercase mb-1">Count</label>
                                    <div className="flex items-center">
                                        <button onClick={() => setCount(Math.max(1, count - 1))} className="bg-slate-800 text-slate-300 p-2 rounded-l border border-slate-600 border-r-0 hover:bg-slate-700 hover:text-white"><Minus size={14}/></button>
                                        <input 
                                            type="number" 
                                            value={count} 
                                            onChange={(e)=>setCount(Math.max(1, parseInt(e.target.value)||1))} 
                                            className="w-full bg-slate-900 border border-slate-600 py-2 text-center font-bold text-white focus:outline-none" 
                                        />
                                        <button onClick={() => setCount(count + 1)} className="bg-slate-800 text-slate-300 p-2 rounded-r border border-slate-600 border-l-0 hover:bg-slate-700 hover:text-white"><Plus size={14}/></button>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-300 uppercase mb-1">Modifier</label>
                                    <div className="flex items-center">
                                        <button onClick={() => setMod(mod - 1)} className="bg-slate-800 text-slate-300 p-2 rounded-l border border-slate-600 border-r-0 hover:bg-slate-700 hover:text-white"><Minus size={14}/></button>
                                        <input 
                                            type="number" 
                                            value={mod} 
                                            onChange={(e)=>setMod(parseInt(e.target.value)||0)} 
                                            className="w-full bg-slate-900 border border-slate-600 py-2 text-center font-bold text-white focus:outline-none" 
                                        />
                                        <button onClick={() => setMod(mod + 1)} className="bg-slate-800 text-slate-300 p-2 rounded-r border border-slate-600 border-l-0 hover:bg-slate-700 hover:text-white"><Plus size={14}/></button>
                                    </div>
                                </div>
                            </div>

                            {/* Roll Button */}
                            <button 
                                onClick={roll} 
                                className="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2 text-lg"
                            >
                                <D20Icon className="w-6 h-6 animate-spin-slow" /> 
                                ROLL {count}d{selectedDie} {mod !== 0 && (mod > 0 ? `+${mod}` : mod)}
                            </button>

                            {/* History Panel */}
                            <div className="bg-slate-950 rounded p-3 h-40 overflow-y-auto border border-slate-800 relative">
                                <div className="flex justify-between items-center mb-2 sticky top-0 bg-slate-950/95 backdrop-blur-sm pb-2 border-b border-slate-800 z-10">
                                    <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider">History</h4>
                                    {history.length > 0 && <button onClick={() => setHistory([])} className="text-[10px] text-red-400 hover:text-red-300 font-bold uppercase border border-red-900/50 px-2 py-0.5 rounded bg-red-900/10 hover:bg-red-900/30 transition-colors">Clear Log</button>}
                                </div>
                                
                                {history.length === 0 && <div className="text-center text-slate-600 text-xs mt-12 italic">Ready to roll...</div>}
                                
                                <div className="space-y-1.5">
                                    {history.map(h => (
                                        <div key={h.id} className="flex justify-between items-center text-sm border-b border-slate-800/50 pb-1.5 last:border-0 animate-fade-in">
                                            <div className="flex flex-col">
                                                <span className="text-slate-400 text-xs font-mono">{h.desc}</span>
                                                <span className="text-slate-500 text-[10px] truncate max-w-[140px]">{h.detail}</span>
                                            </div>
                                            <span className={`font-mono font-bold text-lg ${h.isCrit ? 'text-green-400 drop-shadow-md' : h.isFail ? 'text-red-500' : 'text-white'}`}>
                                                {h.total}
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const MonsterStatBlockModal = ({ combatant, onClose }) => {
            if (!combatant?.statBlockSummary) return null;
            const escapeHtml = (unsafe) => {
                return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            }
            const renderSummary = (text) => {
                // Use sanitized text if possible, but for specific formatting logic we need to split it
                return text.split('\n').map((line, index) => {
                    let cleanLine = escapeHtml(line);
                    let isHeader = false;
                    if (cleanLine.trim().startsWith('**') && cleanLine.trim().endsWith('**')) {
                        isHeader = true;
                    } else {
                        const upperLine = cleanLine.trim().toUpperCase();
                        const knownHeaders = ["ACTIONS", "LEGENDARY ACTIONS", "REACTIONS", "SPECIAL TRAITS", "SPELLCASTING"];
                        if (knownHeaders.includes(upperLine)) {
                            isHeader = true;
                            cleanLine = cleanLine.trim(); 
                        }
                    }
                    if (isHeader) {
                        return <h3 key={index} className="!text-sm font-bold mt-3 mb-1 text-red-500">{cleanLine.replace(/\*\*/g, '')}</h3>;
                    }
                    const formattedLine = cleanLine.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<strong>$1</strong>');
                    return <p key={index} dangerouslySetInnerHTML={{ __html: sanitizeHtml(formattedLine) }}></p>;
                });
            };
            
            return (
                <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
                    <div className="bg-gray-900 text-gray-50 w-full max-w-2xl rounded-xl shadow-2xl border border-gray-700 flex flex-col max-h-[90vh]">
                        <div className="flex justify-between items-center p-4 border-b border-gray-700 bg-gray-800 rounded-t-xl"><h2 className="text-xl font-bold text-red-400 flex items-center gap-2"><BookOpen className="text-red-400"/> {combatant.name} - Full Stat Block</h2><button onClick={onClose}><X size={24} className="text-gray-400 hover:text-white"/></button></div>
                        <div className="p-6 overflow-y-auto flex-1 stat-block"><h3 className="!text-2xl text-white border-b-2 border-red-500 pb-2 mb-3">{combatant.name.toUpperCase()} <span className="text-xs font-normal text-slate-400 ml-2">({combatant.type || 'Unknown'})</span></h3><p className="text-sm font-mono text-gray-400">AC: {combatant.ac} | HP: {combatant.maxHp} | Init Mod: {combatant.initMod}</p><div className="mt-4 text-sm text-gray-200">{combatant.statBlockSummary.length > 0 ? renderSummary(combatant.statBlockSummary.replace(/\\n/g, '\n')) : <span className="flex items-center text-red-400"><AlertTriangle className="inline w-4 h-4 text-yellow-500 mr-2" /> Stat block details were not successfully retrieved by the AI.</span>}</div></div>
                        <div className="p-4 border-t border-gray-700 bg-gray-800 rounded-b-xl flex justify-end"><button onClick={onClose} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded text-sm font-medium">Close Stat Block</button></div>
                    </div>
                </div>
            );
        };

        const FilenameModal = ({ fileName, setFileName, onClose }) => {
            return (
                <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
                    <div className="bg-gray-900 w-full max-w-md rounded-xl border border-slate-700 p-6 shadow-2xl">
                        <h2 className="text-xl font-bold text-white mb-4">File Options</h2>
                        <div className="mb-4">
                            <label className="block text-xs font-bold text-slate-400 mb-1 uppercase">Export Filename Base</label>
                            <input className={INPUT_CLASS} 
                                    value={fileName} 
                                    onChange={(e) => setFileName(e.target.value)} 
                                    onBlur={handleInputBlur}
                                    placeholder="encounter_name" 
                            />
                            <p className="text-xs text-slate-500 mt-1">Used for encounter export (e.g., `<span className="text-amber-500">{fileName}</span>.json`) and Homebrew Backup (e.g., `<span className="text-amber-500">{fileName}</span>_HB-Backup.json`).</p>
                        </div>
                        <div className="flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded text-sm font-bold">Done</button>
                        </div>
                    </div>
                </div>
            );
        };

        const FloatingSettingsButton = ({ apiKey, setModalVisible }) => {
            const isKeyNeeded = !apiKey;
            if (isKeyNeeded) {
                return (
                    <button onClick={() => setModalVisible(true)} className="floating-button px-4 py-2 flex items-center gap-2 bg-red-700 text-white rounded-full font-bold uppercase text-sm border-2 border-red-500 hover:bg-red-600 transition-colors duration-300 animate-pulse" title="Gemini API Key Needed for AI Features"><AlertTriangle size={16} /> API Key Needed</button>
                );
            }
            return (
                <button onClick={() => setModalVisible(true)} className="floating-button w-10 h-10 flex items-center justify-center bg-slate-700 text-slate-400 hover:text-white rounded-full border border-slate-600 hover:bg-slate-600 transition-colors duration-300" title="AI Settings"><Settings size={20} /></button>
            );
        };
        
        const FloatingNextTurnButton = ({ handleNextTurn, combatants, turnIndex, viewMode }) => {
            if (viewMode !== 'battlefield' || combatants.length === 0) return null;
            
            // Adjusting button classes for mobile responsiveness
            return <button onClick={handleNextTurn} className="floating-turn-button px-6 py-3 sm:px-4 sm:py-2 bg-green-600 text-white rounded-full font-bold shadow-lg active:scale-95 flex items-center gap-2 text-base sm:text-sm">Next Turn <ArrowRight size={16}/></button>;
        };

        const HomebrewImportModal = ({ file, onConfirm, onClose }) => {
            if (!file) return null;
            return (
                <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
                    <div className="bg-gray-900 w-full max-w-md rounded-xl border border-slate-700 p-6 shadow-2xl">
                        <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2"><Upload className="text-amber-500"/> Restore Homebrew Bank</h2>
                        <p className="text-slate-300 mb-6 text-sm">You are restoring data from: <span className="font-mono text-amber-300">{file.name}</span></p>

                        <div className="space-y-4">
                            <div className="p-3 border border-slate-700 rounded bg-slate-800">
                                <p className="font-bold text-white flex items-center gap-2 mb-1"><RotateCw size={16} className="text-amber-500"/> Merge Data</p>
                                <p className="text-xs text-slate-400">Adds all imported monsters to your current Homebrew Bank. Existing monsters are kept.</p>
                                <button onClick={() => onConfirm('merge')} className="mt-3 w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 rounded text-sm">Confirm Merge</button>
                            </div>

                            <div className="p-3 border border-slate-700 rounded bg-slate-800">
                                <p className="font-bold text-white flex items-center gap-2 mb-1"><Trash2 size={16} className="text-red-500"/> Overwrite Bank</p>
                                <p className="text-xs text-slate-400">Replaces your current Homebrew Bank with the imported data. **This action cannot be undone.**</p>
                                <button onClick={() => onConfirm('overwrite')} className="mt-3 w-full bg-red-700 hover:bg-red-600 text-white font-bold py-2 rounded text-sm">Confirm Overwrite</button>
                            </div>
                        </div>

                        <div className="flex justify-end mt-4">
                            <button onClick={onClose} className="px-4 py-2 text-slate-400 hover:text-white rounded text-sm">Cancel</button>
                        </div>
                    </div>
                </div>
            );
        };


        function App() {
            // ROBUSTNESS: Use safeLoad instead of JSON.parse
            const [combatants, setCombatants] = useState(() => safeLoad('dm-tracker-monsters', []));
            const [homebrew, setHomebrew] = useState(() => safeLoad('dm-tracker-homebrew', []));
            const [userApiKey, setUserApiKey] = useState(() => localStorage.getItem('dm-tracker-api-key') || HARDCODED_API_KEY);
            const [exportFileName, setExportFileName] = useState(() => localStorage.getItem('dm-tracker-filename') || 'encounter_data');
            const [combatState, setCombatState] = useState(() => safeLoad('dm-tracker-combat-state', { round: 1, turnIndex: 0 }));
            const [battleLogs, setBattleLogs] = useState(() => safeLoad('dm-tracker-logs', []));

            // VERSION STATE
            const [lastSeenVersion, setLastSeenVersion] = useState(() => localStorage.getItem('dm-tracker-last-seen-version') || '0.0.0');
            const hasUnseenChangelog = lastSeenVersion !== CURRENT_VERSION;

            const [monsterDetails, setMonsterDetails] = useState(INITIAL_MONSTER_DETAILS);
            const [formData, setFormData] = useState(INITIAL_FORM);
            
            // ROBUSTNESS: damageInput is now handled LOCALLY inside CombatantCard for performance!
            // We keep this state here just in case legacy logic needs it, but primarily cards use their own state.
            // const [damageInput, setDamageInput] = useState({}); 

            const [isGeneratingStats, setIsGeneratingStats] = useState(false);
            const [isRollingInit, setIsRollingInit] = useState(false); 
            const [narratingId, setNarratingId] = useState(null); 
            const [narrations, setNarrations] = useState({}); 
            
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [showHelpModal, setShowHelpModal] = useState(false);
            const [showFilenameModal, setShowFilenameModal] = useState(false);
            const [showDiceModal, setShowDiceModal] = useState(false);
            const [showLogModal, setShowLogModal] = useState(false);
            const [showChangelogModal, setShowChangelogModal] = useState(false);
            const [viewStatBlockMonster, setViewStatBlockMonster] = useState(null);
            
            const [homebrewForm, setHomebrewForm] = useState({ name: '', hp: '', ac: '', initMod: '', type: 'Unknown' });
            const [lastSource, setLastSource] = useState(null);
            const [openConditionId, setOpenConditionId] = useState(null); 
            const [addMode, setAddMode] = useState('monster'); 
            const [notification, setNotification] = useState(null);
            const [clearConfirm, setClearConfirm] = useState(false);
            const [openActionDetailsId, setOpenActionDetailsId] = useState(null); 
            
            const [viewMode, setViewMode] = useState('setup');
            
            // NEW STATE FOR HOMEBREW LAB
            const [labInput, setLabInput] = useState('');
            const [isBrewing, setIsBrewing] = useState(false);
            const [homebrewSearch, setHomebrewSearch] = useState('');
            const [homebrewSortBy, setHomebrewSortBy] = useState('name'); // 'name' | 'type'
            
            // NEW STATE FOR DM SCREEN SEARCH & SELECTION
            const [screenSearch, setScreenSearch] = useState('');
            const [selectedRule, setSelectedRule] = useState(null);
            const [expandedCategories, setExpandedCategories] = useState({});

            // NEW STATE/REFS FOR HOMEBREW BACKUP
            const [showHomebrewImportModal, setShowHomebrewImportModal] = useState(null); // stores file object or null
            const encounterFileInputRef = useRef(null);
            const homebrewFileInputRef = useRef(null); // Dedicated input for Homebrew backup

            const currentCombatant = combatants[combatState.turnIndex];

            // Define navigation items with icons
            const NAV_ITEMS = [
                { mode: 'setup', label: 'Setup', icon: User },
                { mode: 'battlefield', label: 'Battlefield', icon: CastleGate },
                { mode: 'homebrew', label: 'Homebrew', icon: FlaskConical },
                { mode: 'screen', label: 'DM Information', icon: Grid }
            ];

            // Effects
            useEffect(() => { localStorage.setItem('dm-tracker-monsters', JSON.stringify(combatants)); }, [combatants]);
            useEffect(() => { localStorage.setItem('dm-tracker-homebrew', JSON.stringify(homebrew)); }, [homebrew]);
            useEffect(() => { if (userApiKey && userApiKey !== localStorage.getItem('dm-tracker-api-key')) localStorage.setItem('dm-tracker-api-key', userApiKey); }, [userApiKey]);
            useEffect(() => { localStorage.setItem('dm-tracker-filename', exportFileName); }, [exportFileName]);
            useEffect(() => { localStorage.setItem('dm-tracker-combat-state', JSON.stringify(combatState)); }, [combatState]);
            useEffect(() => { localStorage.setItem('dm-tracker-logs', JSON.stringify(battleLogs)); }, [battleLogs]);
            useEffect(() => { if (combatants.length === 0) setCombatState({ round: 1, turnIndex: 0 }); else if (combatState.turnIndex >= combatants.length) setCombatState(prev => ({ ...prev, turnIndex: 0 })); }, [combatants.length]);

            useEffect(() => {
                if (viewMode === 'battlefield' && combatants.length > 0) {
                    const activeCombatant = combatants[combatState.turnIndex];
                    if (activeCombatant) {
                        const element = document.getElementById(`card-${activeCombatant.id}`);
                        if (element) {
                            setTimeout(() => {
                                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }, 100);
                        }
                    }
                }
            }, [combatState.turnIndex, viewMode]); 

            const handleInputBlur = () => { setTimeout(() => { if (document.activeElement === document.body) window.scrollTo({ top: 0, behavior: 'smooth' }); }, 150); };
            const showNotification = (message, type = 'info') => { setNotification({ message, type }); setTimeout(() => setNotification(null), 3000); };
            
            // ROBUSTNESS: Callbacks are now memoized implicitly or passed directly to CombatantCard
            const toggleActionDetails = useCallback((id) => { 
                setOpenActionDetailsId(prev => prev === id ? null : id); 
                setOpenConditionId(prev => (prev !== null && prev !== id ? null : prev)); 
            }, []);
            
            // NEW LOGGING FUNCTION
            const addToLog = (message, type='info') => {
                const newLog = { message, type, timestamp: new Date().toISOString() };
                setBattleLogs(prev => [...prev, newLog].slice(-50)); // Keep last 50
            };

            // FIX: Simplified openStatBlock to just set the view variable
            const openStatBlock = useCallback((monster) => { setViewStatBlockMonster(monster); }, []);
            
            // --- ENCOUNTER EXPORT/IMPORT ---
            const handleExportData = () => {
                const data = { timestamp: new Date().toISOString(), combatants, homebrew, combatState, battleLogs };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                const href = URL.createObjectURL(blob);
                const cleanFileName = exportFileName.trim().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '') || `dm_encounter_${new Date().toISOString().slice(0,10)}`;
                const link = document.createElement('a');
                link.href = href;
                link.download = cleanFileName + '.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showNotification(`Saved as ${cleanFileName}.json`, "success");
            };

            const handleImportClick = () => {
                if (encounterFileInputRef.current) {
                    encounterFileInputRef.current.click();
                }
            };
            
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        let newCombatants = [];
                        let newHomebrew = [];
                        let newCombatState = null;
                        let newLogs = [];

                        if (Array.isArray(data)) {
                            newCombatants = data; 
                        } else if (data.combatants && Array.isArray(data.combatants)) {
                            newCombatants = data.combatants;
                            if (Array.isArray(data.homebrew)) newHomebrew = data.homebrew;
                            if (data.combatState) newCombatState = data.combatState;
                            if (data.battleLogs) newLogs = data.battleLogs;
                        } else {
                            throw new Error("Invalid file format.");
                        }

                        if (confirm("Overwrite current encounter state (Combatants, Logs, State)?")) {
                            setCombatants(newCombatants);
                            if (newHomebrew.length > 0) setHomebrew(newHomebrew); 
                            if (newCombatState) setCombatState(newCombatState);
                            if (newLogs.length > 0) setBattleLogs(newLogs);
                            showNotification("Encounter loaded!", "success");
                        }
                    } catch (err) { showNotification("Failed to load encounter: " + err.message, "error"); }
                    e.target.value = null; 
                };
                reader.readAsText(file);
            };

            // --- HOMEBREW BACKUP/RESTORE ---
            const handleExportHomebrew = () => {
                const data = homebrew; 
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                const href = URL.createObjectURL(blob);
                const baseName = exportFileName.trim().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '') || `homebrew_bank`;
                const fileName = `${baseName}_HB-Backup.json`;
                const link = document.createElement('a');
                link.href = href;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showNotification(`Homebrew Bank saved as ${fileName}`, "success");
            };

            const handleHomebrewImportClick = () => {
                if (homebrewFileInputRef.current) {
                    homebrewFileInputRef.current.click();
                }
            };

            const handleHomebrewFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (!Array.isArray(importedData)) throw new Error("File content is not a list of monsters.");
                        setShowHomebrewImportModal({ data: importedData, name: file.name });
                    } catch (err) {
                        showNotification("Failed to parse Homebrew file: " + err.message, "error");
                    }
                    e.target.value = null; 
                };
                reader.readAsText(file);
            };

            const handleHomebrewConfirm = (strategy) => {
                const { data: importedMonsters } = showHomebrewImportModal;
                
                // DEEP SCAN FIX: Apply type inference to imported data
                const processedImports = importedMonsters.map(m => {
                    if ((!m.type || m.type === 'Unknown') && m.statBlockSummary) {
                        return { ...m, type: inferTypeFromStatBlock(m.statBlockSummary) };
                    }
                    return m;
                });

                const uniqueImported = processedImports.filter(m => m.name && m.hp);

                if (strategy === 'overwrite') {
                    setHomebrew(uniqueImported);
                    showNotification(`Overwrote Homebrew Bank with ${uniqueImported.length} entries.`, 'success');
                } else if (strategy === 'merge') {
                    const existingNames = new Set(homebrew.map(m => m.name.toLowerCase()));
                    const newMonsters = uniqueImported.filter(m => !existingNames.has(m.name.toLowerCase()));
                    setHomebrew(prev => [...prev, ...newMonsters]);
                    showNotification(`Merged: Added ${newMonsters.length} new entries to Homebrew Bank.`, 'success');
                }
                setShowHomebrewImportModal(null);
            };

            // --- COMBAT STATE & GAME LOGIC ---
            const handleNextTurn = () => {
                if (combatants.length === 0) return;
                let nextIndex = combatState.turnIndex;
                let didWrap = false;
                do {
                    nextIndex = (nextIndex + 1) % combatants.length;
                    if (nextIndex === 0) didWrap = true;
                    const nextCombatant = combatants[nextIndex];
                    if (!nextCombatant || nextCombatant.currentHp > 0 || (nextCombatant.type === 'player' && nextCombatant.maxHp === 0) || !didWrap) break;
                } while (nextIndex !== combatState.turnIndex); 
                
                let nextCombatantName = combatants[nextIndex]?.name || "Unknown";

                if (didWrap) {
                     setCombatState(prev => ({ round: prev.round + 1, turnIndex: nextIndex }));
                     showNotification(`Round ${combatState.round + 1}!`, 'info');
                     addToLog(`Round ${combatState.round + 1} started. ${nextCombatantName}'s turn.`, 'turn');
                } else {
                     setCombatState(prev => ({ ...prev, turnIndex: nextIndex }));
                     addToLog(`Turn passed to ${nextCombatantName}.`, 'turn');
                }
            };
            const handleNextRound = () => { if (combatants.length === 0) return; setCombatState(prev => ({ round: prev.round + 1, turnIndex: 0 })); showNotification(`Round ${combatState.round + 1}!`, 'info'); };
            
            // ROBUSTNESS: Memoized for CombatantCard
            const updateHealth = useCallback((id, amount) => {
                setCombatants(prev => {
                     // Check if update is needed first (optimization)
                     const target = prev.find(c => c.id === id);
                     if (!target) return prev;
                     
                     // Logging
                     const msg = amount < 0 ? `${target.name} took ${Math.abs(amount)} damage` : `${target.name} healed ${amount} HP`;
                     // We can't easily call addToLog here due to closure, but we can access setter or just skip internal logging here if we rely on UI feedback.
                     // To keep robustness simple, we will skip the addToLog call inside this callback to avoid dependency issues, or we use a ref.
                     // Actually, we can just let the log update in a useEffect, OR we accept the dependency. 
                     // Let's rely on the fact that `setBattleLogs` is stable.
                     
                     return prev.map(m => {
                        if (m.id !== id) return m;
                        if (m.type === 'player' && m.maxHp === 0) return m;
                        const newHp = Math.max(0, Math.min(m.maxHp, m.currentHp + amount));
                        let newDeathSaves = m.deathSaves;
                        if (m.type === 'player' && m.currentHp === 0 && newHp > 0) { newDeathSaves = { successes: 0, failures: 0 }; }
                        return { ...m, currentHp: newHp, deathSaves: newDeathSaves !== undefined ? newDeathSaves : m.deathSaves };
                    });
                });
            }, []);
            
            const toggleConcentration = useCallback((id) => { 
                setCombatants(prev => prev.map(m => m.id !== id ? m : { ...m, isConcentrating: !m.isConcentrating })); 
            }, []);
            
            const toggleDeathSave = useCallback((id, type, index) => {
                setCombatants(prev => prev.map(m => {
                    if (m.id !== id) return m;
                    const currentSaves = m.deathSaves || { successes: 0, failures: 0 };
                    let newVal = index + 1;
                    if (currentSaves[type] === newVal) newVal = index; 
                    return { ...m, deathSaves: { ...currentSaves, [type]: newVal } };
                }));
            }, []);
            
            const deleteHomebrew = (id) => { setHomebrew(prev => prev.filter(h => h.id !== id)); };

            const toggleCondition = useCallback((id, c) => {
                setCombatants(prev => prev.map(m => m.id !== id ? m : { ...m, conditions: m.conditions.includes(c) ? m.conditions.filter(i => i !== c) : [...m.conditions, c] }));
            }, []);

            const deleteCombatant = useCallback((id) => { 
                setCombatants(prev => prev.filter(m => m.id !== id)); 
                setNarrations(prev => { const n = {...prev}; delete n[id]; return n; }); 
            }, []);

            const handleClearAll = () => { if (clearConfirm) { setCombatants([]); setNarrations({}); setCombatState({ round: 1, turnIndex: 0 }); setBattleLogs([]); setClearConfirm(false); showNotification("Cleared", "success"); } else { setClearConfirm(true); setTimeout(() => setClearConfirm(false), 3000); } };
            const sortCombatants = () => { setCombatants(prev => [...prev].sort((a, b) => b.initiative - a.initiative)); setCombatState(prev => ({ ...prev, turnIndex: 0 })); };
            const handleInputChange = (e) => { const { name, value } = e.target; if (name === 'initiative' && addMode === 'monster') return; setFormData(prev => ({ ...prev, [name]: value })); };
            const handleManualRoll = () => {
                if (addMode !== 'player') return;
                setIsRollingInit(true);
                setTimeout(() => {
                    const mod = parseInt(formData.initMod) || 0;
                    const total = rollInitiative(mod);
                    setFormData(prev => ({ ...prev, initiative: total.toString() }));
                    setIsRollingInit(false);
                }, 600);
            };

            const clearSetupForm = () => {
                setFormData(INITIAL_FORM);
                setMonsterDetails(INITIAL_MONSTER_DETAILS);
                setLastSource(null);
                showNotification("Setup form cleared", "info");
            };
            
            const clearHomebrewForm = () => {
                setHomebrewForm({ name: '', hp: '', ac: '', initMod: '', type: 'Unknown' });
                setMonsterDetails(INITIAL_MONSTER_DETAILS);
                showNotification("Homebrew form cleared", "info");
            };

            const handleOpenHelp = () => {
                setShowHelpModal(true);
                if (hasUnseenChangelog) {
                    localStorage.setItem('dm-tracker-last-seen-version', CURRENT_VERSION);
                    setLastSeenVersion(CURRENT_VERSION);
                }
            };

            // AI & Add Logic
            const callGemini = async (prompt) => {
                let attempt = 0;
                if (!userApiKey) { showNotification("Missing API Key", "error"); setShowSettingsModal(true); return null; }
                while (attempt < 3) {
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                        if (!res.ok) throw new Error("API Error");
                        const data = await res.json();
                        return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                    } catch (e) { attempt++; await new Promise(r => setTimeout(r, Math.pow(2, attempt) * 1000)); }
                }
            };

            const handleAutoFillStats = async (e) => {
                e.preventDefault();
                if (!formData.name) { showNotification("Enter name first", "error"); return; }
                setLastSource(null);
                setMonsterDetails(INITIAL_MONSTER_DETAILS);
                
                const normName = formData.name.trim().toLowerCase();
                let hb = homebrew.find(h => h.name.trim().toLowerCase() === normName);
                if (!hb) {
                    hb = homebrew.find(h => h.name.trim().toLowerCase().includes(normName));
                }

                if (hb) {
                    const mod = parseInt(hb.initMod) || 0;
                    setFormData(prev => ({ ...prev, hp: hb.hp, ac: hb.ac, initMod: mod, initiative: '' }));
                    setMonsterDetails({ 
                        resistances: hb.resistances||'', 
                        vulnerabilities: hb.vulnerabilities||'', 
                        actions: hb.actions||'', 
                        statBlockSummary: hb.statBlockSummary||'Not saved.', 
                        type: hb.type || 'Unknown' 
                    });
                    setLastSource('homebrew');
                    showNotification("Stats loaded from Homebrew.", 'info');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    return;
                }

                setIsGeneratingStats(true);
                const prompt = `You are a D&D 5e Rules Expert. Generate a COMPLETE, DETAILED stat block for the monster "${formData.name}". DO NOT SUMMARIZE. DO NOT OMIT DATA. Return a JSON object with these specific properties: - 'hp' (integer) - 'ac' (integer) - 'initMod' (integer) - 'resistances' (string: list or "None") - 'vulnerabilities' (string: list or "None") - 'actions' (string: concise list of action names and damage dice, e.g. "Bite (1d6+2)") - 'statBlockSummary' (string: A full markdown text block including: Ability Scores, Saving Throws, Skills, Senses, Languages, Challenge, Special Traits, Actions, and Legendary Actions if applicable. Use strict markdown headers like **Actions**.) - 'type' (string: e.g. "Aberration", "Beast", "Celestial") Return ONLY valid JSON.`;

                const txt = await callGemini(prompt);
                if (txt) {
                    try {
                        const json = JSON.parse(txt.replace(/```json|```/g, '').trim());
                        let monsterType = json.type || 'Unknown';
                        // Deep Scan: Check summary if type is missing or generic
                        if (monsterType === 'Unknown' && json.statBlockSummary) {
                            monsterType = inferTypeFromStatBlock(json.statBlockSummary);
                        }
                        
                        setFormData(prev => ({ ...prev, hp: json.hp, ac: json.ac, initMod: parseInt(json.initMod)||0, initiative: '' }));
                        setMonsterDetails({ 
                            resistances: json.resistances||'', 
                            vulnerabilities: json.vulnerabilities||'', 
                            actions: json.actions||'', 
                            statBlockSummary: json.statBlockSummary||'', 
                            type: monsterType 
                        });
                        setLastSource('ai');
                        showNotification("Stats generated by AI.", 'info');
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    } catch (e) { showNotification("AI Parse Error", "error"); }
                }
                setIsGeneratingStats(false);
            };
            
            const handleBrewMonster = async () => {
                if (!labInput.trim()) { showNotification("Describe your monster first!", "error"); return; }
                setIsBrewing(true);
                const prompt = `You are a D&D 5e Rules Expert. Create a BALANCED, COMPLETE monster stat block based on this concept: "${labInput}". DO NOT SUMMARIZE. Create a full playable monster. Return a JSON object with: - 'name' (string) - 'hp' (integer) - 'ac' (integer) - 'initMod' (integer) - 'resistances' (string) - 'vulnerabilities' (string) - 'actions' (string: concise list of action names and damage dice) - 'statBlockSummary' (string: A full markdown text block including: Ability Scores, Saving Throws, Skills, Senses, Languages, Challenge, Special Traits, Actions, and Legendary Actions if applicable. Use strict markdown headers like **Actions**.) - 'type' (string: e.g. "Aberration", "Beast", "Celestial") Return ONLY valid JSON.`;

                const txt = await callGemini(prompt);
                if (txt) {
                     try {
                        const json = JSON.parse(txt.replace(/```json|```/g, '').trim());
                        let monsterType = json.type || 'Unknown';
                        // Deep Scan: Check summary if type is missing or generic
                        if (monsterType === 'Unknown' && json.statBlockSummary) {
                            monsterType = inferTypeFromStatBlock(json.statBlockSummary);
                        }

                        setHomebrewForm({ name: json.name || "Unknown Beast", hp: json.hp || 10, ac: json.ac || 10, initMod: parseInt(json.initMod) || 0, type: monsterType });
                        setMonsterDetails({ resistances: json.resistances || '', vulnerabilities: json.vulnerabilities || '', actions: json.actions || '', statBlockSummary: json.statBlockSummary || '', type: monsterType });
                        showNotification("Monster brewed! Review and Save below.", "success");
                     } catch (e) { console.error(e); showNotification("Failed to brew monster. Try again.", "error"); }
                }
                setIsBrewing(false);
            };

            const handleNarrate = useCallback(async (combatant) => {
                setNarratingId(combatant.id);
                const txt = await callGemini(`Write short visceral combat flavor text for ${combatant.name} (HP ${combatant.currentHp}/${combatant.maxHp}). No quotes.`);
                if (txt) setNarrations(prev => ({ ...prev, [combatant.id]: txt.trim() }));
                setNarratingId(null);
            }, [userApiKey]);

            const addCombatant = (e) => {
                e.preventDefault();
                if (!formData.name) { showNotification("Name required", "error"); return; }
                if (addMode === 'monster' && !formData.hp) { showNotification("HP required", "error"); return; }

                const newC = [];
                const qty = parseInt(formData.qty) || 1;
                const mod = parseInt(formData.initMod) || 0;
                
                if (addMode === 'player') {
                    let init = parseInt(formData.initiative);
                    if (isNaN(init)) { init = rollInitiative(mod); showNotification(`Rolled Init: ${init}`, 'success'); }
                    newC.push({ id: generateId(), type: 'player', name: formData.name, maxHp: parseInt(formData.hp)||0, currentHp: parseInt(formData.hp)||0, ac: parseInt(formData.ac)||10, initiative: init, conditions: [], deathSaves: { successes: 0, failures: 0 }, isConcentrating: false });
                    addToLog(`Added player ${formData.name}`, 'info');
                } else {
                    for (let i=0; i<qty; i++) {
                        newC.push({ id: generateId(), type: 'monster', name: qty > 1 ? `${formData.name} ${i+1}` : formData.name, maxHp: parseInt(formData.hp), currentHp: parseInt(formData.hp), ac: parseInt(formData.ac)||10, initiative: rollInitiative(mod), conditions: [], isConcentrating: false, ...monsterDetails });
                    }
                    showNotification(`Added ${qty} ${formData.name}(s)`, 'success');
                    addToLog(`Added ${qty} x ${formData.name}`, 'info');
                }
                setCombatants(prev => [...prev, ...newC].sort((a, b) => b.initiative - a.initiative));
                setFormData(prev => ({ ...INITIAL_FORM, initMod: prev.initMod, qty: prev.qty }));
                setMonsterDetails(INITIAL_MONSTER_DETAILS);
                setLastSource(null);
                setCombatState(prev => ({ ...prev, turnIndex: 0 }));
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const saveHomebrewMonster = (e) => {
                e.preventDefault();
                if (!homebrewForm.name || !homebrewForm.hp) { showNotification("Name/HP required", "error"); return; }

                const existingIndex = homebrew.findIndex(h => h.name.toLowerCase() === homebrewForm.name.toLowerCase());
                const newMonster = { 
                    id: generateId(), 
                    name: homebrewForm.name, 
                    hp: parseInt(homebrewForm.hp), 
                    ac: parseInt(homebrewForm.ac)||10, 
                    initMod: parseInt(homebrewForm.initMod)||0, 
                    type: homebrewForm.type || 'Unknown',
                    ...monsterDetails 
                };

                if (existingIndex !== -1) {
                    setHomebrew(prev => prev.map((h, index) => index === existingIndex ? { ...h, ...newMonster } : h));
                    showNotification(`Updated existing monster: ${homebrewForm.name}`, "info");
                } else {
                    setHomebrew(prev => [...prev, newMonster]);
                    showNotification("Saved to Bank", "success");
                }
                setHomebrewForm({ name: '', hp: '', ac: '', initMod: '', type: 'Unknown' });
                setMonsterDetails(INITIAL_MONSTER_DETAILS); 
            };

            const toggleCategory = (category) => {
                setExpandedCategories(prev => ({ ...prev, [category]: !prev[category] }));
            };

            const getProcessedHomebrew = () => {
                let filtered = homebrew.filter(h => 
                    h.name.toLowerCase().includes(homebrewSearch.toLowerCase()) || 
                    (h.type && h.type.toLowerCase().includes(homebrewSearch.toLowerCase()))
                );

                if (homebrewSortBy === 'name') {
                    return { type: 'flat', data: filtered.sort((a, b) => a.name.localeCompare(b.name)) };
                } else {
                    const grouped = {};
                    filtered.forEach(h => {
                        const t = h.type || "Unknown";
                        if (!grouped[t]) grouped[t] = [];
                        grouped[t].push(h);
                    });
                    const sortedKeys = Object.keys(grouped).sort();
                    return { type: 'grouped', data: grouped, keys: sortedKeys };
                }
            };

            const processedHomebrew = getProcessedHomebrew();

            return (
                <div className="min-h-screen pb-32 font-serif">
                    {notification && <div className={`fixed top-20 right-4 z-[120] px-4 py-3 rounded shadow-xl flex items-center gap-2 animate-bounce-in ${notification.type==='error'?'bg-red-600 text-white':'bg-green-600 text-white'}`}>{notification.type==='error'?<AlertTriangle size={18}/>:<CheckCircle size={18}/>}<span>{notification.message}</span></div>}
                    
                    {viewStatBlockMonster && <MonsterStatBlockModal combatant={viewStatBlockMonster} onClose={() => setViewStatBlockMonster(null)} />}
                    {showFilenameModal && <FilenameModal fileName={exportFileName} setFileName={setExportFileName} onClose={() => setShowFilenameModal(false)} />}
                    {showDiceModal && <DiceRollerModal onClose={() => setShowDiceModal(false)} addToLog={addToLog} />}
                    {showLogModal && <BattleLogModal logs={battleLogs} onClose={() => setBattleLogs(false)} onClear={() => setBattleLogs([])} />}
                    {showHomebrewImportModal && <HomebrewImportModal file={showHomebrewImportModal} onConfirm={handleHomebrewConfirm} onClose={() => setShowHomebrewImportModal(null)} />}
                    {showChangelogModal && <ChangelogModal onClose={() => setShowChangelogModal(false)} />}

                    
                    <FloatingNextTurnButton handleNextTurn={handleNextTurn} combatants={combatants} turnIndex={combatState.turnIndex} viewMode={viewMode} />
                    <FloatingSettingsButton apiKey={userApiKey} setModalVisible={setShowSettingsModal} />

                    <div className="astral-container relative z-10 p-2 sm:p-4">
                        <header className="bg-slate-800 border-b border-slate-700 sticky top-0 z-50 shadow-md -mx-2 sm:-mx-4 -mt-2 sm:-mt-4 px-4 py-3 mb-4">
                            <div className="max-w-6xl mx-auto">
                                <div className="flex justify-between items-center mb-3">
                                    <div className="flex items-center gap-3"><Shield className="text-red-800 w-6 h-6 sm:w-8 sm:h-8" /><h1 className="text-lg sm:text-2xl font-bold tracking-tight text-white">The Akashic Tome</h1></div>
                                    <div className="flex items-center bg-slate-900 rounded px-3 py-1 border border-slate-700"><span className="text-xs font-bold text-slate-500 mr-2">ROUND</span><span className="text-white font-mono text-lg">{combatState.round}</span></div>
                                </div>
                                <div className="flex flex-col sm:flex-row justify-between items-center gap-3">
                                    <div className="flex bg-slate-900 p-1 rounded-lg border border-slate-700 w-full sm:w-auto overflow-x-auto no-scrollbar">
                                        {NAV_ITEMS.map(item => (
                                            <button key={item.mode} onClick={() => setViewMode(item.mode)} className={`flex-1 px-3 py-2 text-xs sm:text-sm font-bold rounded capitalize transition-colors whitespace-nowrap flex items-center justify-center gap-2 ${viewMode === item.mode ? (item.mode==='battlefield'?'bg-red-700 text-white':(item.mode==='homebrew'?'bg-amber-700 text-white':'bg-indigo-600 text-white')) : 'text-slate-400 hover:text-white'}`}>
                                                <item.icon size={16} />
                                                <span>{item.label}</span>
                                                {item.mode==='battlefield' && combatants.length>0 && <span className="ml-1 bg-black/30 px-1.5 rounded-full text-[10px]">{combatants.length}</span>}
                                            </button>
                                        ))}
                                    </div>
                                    <div className="flex w-full sm:w-auto gap-2 justify-end">
                                        <div className="flex bg-slate-900 rounded-lg p-1 border border-slate-700 flex-1 sm:flex-none justify-center">
                                            <button onClick={() => setShowLogModal(true)} className="p-2 hover:bg-slate-700 rounded text-slate-400 hover:text-white flex items-center justify-center" title="Battle Log"><ScrollText size={18}/></button>
                                            <button onClick={() => setShowDiceModal(true)} className="p-2 hover:bg-slate-700 rounded text-slate-400 hover:text-white flex items-center justify-center" title="Dice Roller"><D20Icon className="w-5 h-5"/></button>
                                            <div className="w-px bg-slate-700 mx-1"></div>
                                            <button onClick={sortCombatants} className="p-2 hover:bg-slate-700 rounded text-slate-400 hover:text-white flex items-center justify-center" title="Sort Initiative"><ArrowDownUp size={18}/></button>
                                            <div className="w-px bg-slate-700 mx-1"></div>
                                            <button onClick={() => setShowFilenameModal(true)} className="p-2 hover:bg-slate-700 rounded text-slate-400 hover:text-white flex items-center justify-center" title="Set File Name"><GripVertical size={18}/></button>
                                            
                                            <button onClick={handleImportClick} className="p-2 hover:bg-slate-700 rounded text-slate-400 hover:text-white flex items-center justify-center" title="Import Encounter (Includes Homebrew if present)"><Upload size={18}/></button> 
                                            <input 
                                                type="file" 
                                                ref={encounterFileInputRef} 
                                                onChange={handleFileChange} 
                                                className="hidden" 
                                                accept=".json" 
                                            />

                                            <button onClick={handleExportData} className="p-2 hover:bg-slate-700 rounded text-slate-400 hover:text-white flex items-center justify-center" title="Export Full Encounter Data"><Download size={18}/></button>
                                        </div>
                                        <button 
                                            onClick={handleOpenHelp} 
                                            className={`p-2 bg-slate-900 hover:bg-slate-700 rounded text-slate-400 hover:text-white border border-slate-700 relative transition-all flex items-center justify-center ${hasUnseenChangelog ? 'ring-2 ring-amber-400 shadow-[0_0_15px_rgba(251,191,36,0.6)] animate-pulse' : ''}`} 
                                            title="Help/Guide"
                                        >
                                            <CircleHelp size={20}/>
                                            {hasUnseenChangelog && <span className="absolute -top-1 -right-1 flex h-3 w-3"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-amber-400 opacity-75"></span><span className="relative inline-flex rounded-full h-3 w-3 bg-amber-500"></span></span>}
                                        </button>
                                        <button onClick={handleClearAll} className={`px-3 py-1.5 rounded text-xs font-bold uppercase tracking-wider border transition-colors ${clearConfirm ? 'bg-red-600 text-white border-red-500' : 'bg-slate-900 text-red-400 border-slate-700 hover:bg-slate-800'}`}>{clearConfirm ? "Sure?" : "Clear"}</button>
                                    </div>
                                </div>
                            </div>
                        </header>

                        <main className="max-w-6xl mx-auto">
                            {viewMode === 'setup' && (
                                <div className="animate-fade-in">
                                    <section className="bg-slate-800 rounded-xl p-4 border border-slate-700 shadow-md">
                                        <div className="flex justify-between items-center mb-4">
                                            <div className="flex gap-2">
                                                <button onClick={() => setAddMode('monster')} className={`px-3 py-1.5 rounded text-sm font-bold flex items-center gap-2 ${addMode === 'monster' ? 'bg-slate-700 text-white' : 'text-slate-500'}`}><Ghost size={16}/> Monster</button>
                                                <button onClick={() => setAddMode('player')} className={`px-3 py-1.5 rounded text-sm font-bold flex items-center gap-2 ${addMode === 'player' ? 'bg-indigo-900 text-indigo-100' : 'text-slate-500'}`}><User size={16}/> Player</button>
                                            </div>
                                            {addMode === 'monster' && (<div className="text-[10px] text-slate-500 flex items-center gap-1 bg-slate-900 px-2 py-1 rounded"><BookOpen size={10} className="text-indigo-400" /> <span>5th Edition Compatible</span></div>)}
                                        </div>
                                        <form onSubmit={addCombatant} className="grid grid-cols-4 md:grid-cols-12 gap-3 items-end">
                                            <div className="col-span-4 md:col-span-5"><label className="text-xs text-slate-400 block mb-1">Name</label><div className="relative"><input className={INPUT_CLASS} value={formData.name} name="name" onChange={handleInputChange} onBlur={handleInputBlur} placeholder={addMode==='monster'?"Lich":"Aragon"} />{addMode==='monster' && <button type="button" onClick={handleAutoFillStats} disabled={isGeneratingStats} className="absolute right-1 top-1 p-1.5 text-indigo-400 hover:text-white flex items-center justify-center h-full w-8">{isGeneratingStats?<Loader2 size={16} className="animate-spin"/>:<Sparkles size={16}/>}</button>}</div></div>
                                            <div className="col-span-2 md:col-span-2"><label className="text-xs text-slate-400 block mb-1">HP</label><input type="number" className={INPUT_CLASS} name="hp" value={formData.hp} onChange={handleInputChange} onBlur={handleInputBlur} placeholder="Max" /></div>
                                            <div className={`col-span-2 md:col-span-1`}>
                                                <label className="block text-xs text-slate-400 mb-1">AC</label>
                                                <input name="ac" type="number" className={INPUT_CLASS} value={formData.ac} onChange={handleInputChange} onBlur={handleInputBlur} placeholder="10" /></div>
                                            <div className="col-span-2 md:col-span-2"><label className="text-xs text-slate-400 block mb-1">{addMode==='player'?'Init':'Init Mod'}</label><div className="relative"><input type="number" className={INPUT_CLASS} name={addMode==='player'?'initiative':'initMod'} value={addMode==='player'?formData.initiative:formData.initMod} onChange={handleInputChange} onBlur={handleInputBlur} placeholder={addMode==='player'?'Roll':'+0'} />{addMode==='player' && <button type="button" onClick={handleManualRoll} className="absolute right-1 top-1 text-slate-400 hover:text-white flex items-center justify-center h-full w-8"><D20Icon className={`w-6 h-6 ${isRollingInit?'animate-spin-fast text-red-500':''}`}/></button>}</div></div>
                                            {addMode==='monster' && <div className="col-span-2 md:col-span-2"><label className="text-xs text-slate-400 block mb-1">Qty</label><input type="number" className={INPUT_CLASS} name="qty" value={formData.qty} onChange={handleInputChange} onBlur={handleInputBlur} /></div>}
                                            <div className="col-span-4 md:col-span-12 flex gap-2 h-[38px] mt-2">
                                                <button type="button" onClick={clearSetupForm} className="bg-slate-700 hover:bg-slate-600 text-slate-400 hover:text-white font-bold py-2 px-3 rounded flex justify-center items-center transition-colors h-full" title="Reset Form"><RotateCcw size={18}/></button>
                                                <button type="submit" className="flex-1 bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded flex justify-center items-center h-full"><Plus size={20}/></button>
                                            </div>
                                        </form>
                                        {(monsterDetails.resistances || monsterDetails.actions) && <div className="mt-4 p-3 bg-slate-900/50 rounded border border-slate-700 text-xs space-y-1"><p><span className="text-blue-400">Resistances:</span> {monsterDetails.resistances||'None'}</p><p><span className="text-yellow-400">Actions:</span> {monsterDetails.actions||'None'}</p></div>}
                                    </section>
                                </div>
                            )}

                            {viewMode === 'battlefield' && (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 animate-fade-in">
                                    {combatants.length === 0 && <div className="col-span-full text-center py-20 opacity-50"><div className="text-xl font-serif mb-2">The battlefield is silent...</div><p className="text-sm">Go to <strong>Setup</strong> to add combatants.</p></div>}
                                    {combatants.map((c, i) => (
                                        <CombatantCard 
                                            key={c.id} 
                                            combatant={c}
                                            active={i === combatState.turnIndex}
                                            onUpdateHealth={updateHealth}
                                            onToggleConcentration={toggleConcentration}
                                            onToggleActionDetails={toggleActionDetails}
                                            onNarrate={handleNarrate}
                                            onDelete={deleteCombatant}
                                            onStatBlock={openStatBlock}
                                            onToggleCondition={toggleCondition}
                                            onToggleDeathSave={toggleDeathSave}
                                            openActionDetailsId={openActionDetailsId}
                                            openConditionId={openConditionId}
                                            setOpenConditionId={setOpenConditionId}
                                            narration={narrations[c.id]}
                                            isNarrating={narratingId===c.id}
                                        />
                                    ))}
                                </div>
                            )}

                             {viewMode === 'homebrew' && (
                                <div className="animate-fade-in">
                                    <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 mb-6">
                                        <h2 className="text-lg font-bold text-white mb-4 flex items-center gap-2 text-amber-500"><FlaskConical size={20}/> Monster Homebrew Lab</h2>
                                        <div className="mb-4"><textarea className="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:outline-none focus:border-amber-500 h-24 resize-none" placeholder="Describe your monster concept (e.g., 'A clockwork dragon made of rusty gears that breathes steam')" value={labInput} onChange={(e) => setLabInput(e.target.value)} onBlur={handleInputBlur}></textarea></div>
                                        <button onClick={handleBrewMonster} disabled={isBrewing} className="w-full bg-amber-700 hover:bg-amber-600 text-white font-bold py-2 rounded flex justify-center items-center gap-2">{isBrewing ? <Loader2 size={18} className="animate-spin"/> : <Ghost size={20}/>} {isBrewing ? "Brewing..." : "Brew Monster"}</button>
                                    </div>

                                    <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                                            <h2 className="text-lg font-bold text-white flex items-center gap-2"><Database className="text-amber-500"/> Homebrew Bank</h2>
                                            
                                            {/* SEARCH & SORT TOOLBAR */}
                                            <div className="flex w-full sm:w-auto gap-2">
                                                <div className="relative flex-1 sm:flex-none">
                                                    <input 
                                                        className="bg-slate-900 border border-slate-600 rounded pl-8 pr-3 py-1.5 text-xs text-white focus:border-indigo-500 w-full"
                                                        placeholder="Search bank..."
                                                        value={homebrewSearch}
                                                        onChange={(e) => setHomebrewSearch(e.target.value)}
                                                    />
                                                    <Search size={14} className="absolute left-2.5 top-2 text-slate-500"/>
                                                </div>
                                                <button 
                                                    onClick={() => setHomebrewSortBy(homebrewSortBy === 'name' ? 'type' : 'name')}
                                                    className="flex items-center gap-1.5 px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-slate-300 hover:text-white rounded text-xs font-bold border border-slate-600 transition-colors"
                                                    title={`Sorted by ${homebrewSortBy}`}
                                                >
                                                    <Filter size={14} className={homebrewSortBy === 'type' ? 'text-amber-400' : 'text-slate-400'}/>
                                                    {homebrewSortBy === 'name' ? 'A-Z' : 'Type'}
                                                </button>
                                            </div>
                                        </div>
                                        
                                        {/* NEW: Backup/Restore Buttons */}
                                        <div className="flex gap-2 mb-6">
                                            <button onClick={handleHomebrewImportClick} className="flex-1 flex items-center justify-center gap-2 bg-slate-900 hover:bg-slate-700 text-slate-400 hover:text-white font-bold py-2 px-3 rounded text-sm border border-slate-700">
                                                <Upload size={18}/> Restore
                                            </button>
                                            <input 
                                                type="file" 
                                                ref={homebrewFileInputRef} 
                                                onChange={handleHomebrewFileChange} 
                                                className="hidden" 
                                                accept=".json" 
                                            />
                                            <button onClick={handleExportHomebrew} className="flex-1 flex items-center justify-center gap-2 bg-slate-900 hover:bg-slate-700 text-slate-400 hover:text-white font-bold py-2 px-3 rounded text-sm border border-slate-700">
                                                <Download size={18}/> Backup
                                            </button>
                                        </div>

                                        <form onSubmit={saveHomebrewMonster} className="mb-6 grid grid-cols-2 md:grid-cols-12 gap-3 items-end p-3 bg-slate-700/50 rounded-lg border border-slate-600">
                                            <div className="col-span-2 md:col-span-3"><label className="text-xs text-slate-400 block mb-1">Name</label><input className={INPUT_CLASS} value={homebrewForm.name} onChange={e=>setHomebrewForm({...homebrewForm,name:e.target.value})} onBlur={handleInputBlur} /></div>
                                            <div className="col-span-1 md:col-span-2"><label className="text-xs text-slate-400 block mb-1">Type</label>
                                                <select className={INPUT_CLASS} value={homebrewForm.type} onChange={e=>setHomebrewForm({...homebrewForm,type:e.target.value})}>
                                                    {MONSTER_TYPES.map(t => <option key={t} value={t}>{t}</option>)}
                                                </select>
                                            </div>
                                            <div className="col-span-1 md:col-span-2"><label className="text-xs text-slate-400 block mb-1">HP</label><input type="number" className={INPUT_CLASS} value={homebrewForm.hp} onChange={e=>setHomebrewForm({...homebrewForm,hp:e.target.value})} onBlur={handleInputBlur} /></div>
                                            <div className="col-span-1 md:col-span-2"><label className="text-xs text-slate-400 block mb-1">AC</label><input type="number" className={INPUT_CLASS} value={homebrewForm.ac} onChange={e=>setHomebrewForm({...homebrewForm,ac:e.target.value})} onBlur={handleInputBlur} /></div>
                                            <div className="col-span-1 md:col-span-2"><label className="text-xs text-slate-400 block mb-1">Init Mod</label><input type="number" className={INPUT_CLASS} value={homebrewForm.initMod} onChange={e=>setHomebrewForm({...homebrewForm,initMod:e.target.value})} onBlur={handleInputBlur} /></div>
                                            <div className="col-span-2 md:col-span-1 flex gap-1">
                                                <button type="button" onClick={clearHomebrewForm} className="bg-slate-800 hover:bg-slate-600 text-slate-400 hover:text-white p-1.5 rounded flex justify-center items-center transition-colors" title="Clear Form"><RotateCcw size={18}/></button>
                                                <button className="flex-1 bg-amber-700 hover:bg-amber-600 text-white py-1.5 rounded flex justify-center items-center" title="Save Monster or Update Existing"><Save size={18}/></button>
                                            </div>
                                        </form>
                                        
                                        {/* DISPLAY LIST */}
                                        <div className="space-y-2">
                                            {processedHomebrew.type === 'flat' ? (
                                                processedHomebrew.data.length > 0 ? (
                                                    processedHomebrew.data.map(h => (
                                                        <div key={h.id} className="flex justify-between items-center bg-slate-900/50 p-3 rounded border border-slate-700">
                                                            <div>
                                                                <div className="font-bold text-white flex items-center gap-2">{h.name} <span className="text-[10px] text-slate-500 font-normal uppercase border border-slate-700 px-1 rounded">{h.type||'Unknown'}</span></div>
                                                                <div className="text-xs text-slate-400">HP: {h.hp} | AC: {h.ac} | Init: {h.initMod >= 0 ? '+' : ''}{h.initMod}</div>
                                                            </div>
                                                            <div className="flex gap-2">
                                                                {h.statBlockSummary && <button onClick={() => openStatBlock(h)} className="text-slate-400 hover:text-white p-1 flex items-center justify-center" title="View Stat Block"><CircleHelp size={16}/></button>}
                                                                <button onClick={()=>deleteHomebrew(h.id)} className="text-slate-500 hover:text-red-500 flex items-center justify-center"><Trash2 size={16}/></button>
                                                            </div>
                                                        </div>
                                                    ))
                                                ) : <div className="text-center text-slate-500 italic py-4">No matching monsters found.</div>
                                            ) : (
                                                /* GROUPED DISPLAY */
                                                processedHomebrew.keys.length > 0 ? (
                                                    processedHomebrew.keys.map(typeKey => (
                                                        <div key={typeKey} className="mb-4">
                                                            <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest border-b border-slate-700 mb-2 pb-1">{typeKey}</h3>
                                                            <div className="space-y-2">
                                                                {processedHomebrew.data[typeKey].map(h => (
                                                                    <div key={h.id} className="flex justify-between items-center bg-slate-900/50 p-3 rounded border border-slate-700">
                                                                        <div>
                                                                            <div className="font-bold text-white">{h.name}</div>
                                                                            <div className="text-xs text-slate-400">HP: {h.hp} | AC: {h.ac} | Init: {h.initMod >= 0 ? '+' : ''}{h.initMod}</div>
                                                                        </div>
                                                                        <div className="flex gap-2">
                                                                            {h.statBlockSummary && <button onClick={() => openStatBlock(h)} className="text-slate-400 hover:text-white p-1 flex items-center justify-center" title="View Stat Block"><CircleHelp size={16}/></button>}
                                                                            <button onClick={()=>deleteHomebrew(h.id)} className="text-slate-500 hover:text-red-500 flex items-center justify-center"><Trash2 size={16}/></button>
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    ))
                                                ) : <div className="text-center text-slate-500 italic py-4">No matching monsters found.</div>
                                            )}
                                            
                                            {homebrew.length === 0 && <div className="text-center text-slate-500 italic py-4">No homebrew monsters saved.</div>}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* NEW: DM SCREEN VIEW - MASTER/DETAIL LAYOUT */}
                            {viewMode === 'screen' && (
                                <div className="animate-fade-in flex flex-col md:flex-row gap-4 h-[calc(100vh-140px)] md:h-[75vh]">
                                    
                                    {/* LEFT: SIDEBAR NAVIGATION */}
                                    {/* Mobile Logic: Hidden if a rule is selected (so we can see details) */}
                                    <div className={`w-full md:w-1/3 lg:w-1/4 bg-slate-900/50 border border-slate-700 rounded-xl overflow-hidden flex-col ${selectedRule ? 'hidden md:flex' : 'flex'}`}>
                                        <div className="p-3 border-b border-slate-700 bg-slate-900 sticky top-0 z-10">
                                            <div className="relative">
                                                <input 
                                                    type="text" 
                                                    placeholder="Search rules..." 
                                                    className="w-full bg-slate-800 border border-slate-600 rounded pl-8 pr-8 py-3 text-sm text-white focus:outline-none focus:border-indigo-500"
                                                    value={screenSearch}
                                                    onChange={(e) => setScreenSearch(e.target.value)}
                                                />
                                                <div className="absolute left-2.5 top-3.5 text-slate-400"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></div>
                                                {screenSearch && <button onClick={() => setScreenSearch('')} className="absolute right-2 top-3.5 text-slate-400 hover:text-white"><X size={14}/></button>}
                                            </div>
                                        </div>
                                        
                                        <div className="flex-1 overflow-y-auto p-2 space-y-1">
                                            {RULES_DATA.map((category, idx) => {
                                                const matchesSearch = !screenSearch || category.items.some(item => item.title.toLowerCase().includes(screenSearch.toLowerCase()));
                                                if (!matchesSearch) return null;

                                                const isExpanded = expandedCategories[category.category] || screenSearch.length > 0;

                                                return (
                                                    <div key={idx} className="mb-1">
                                                        <button 
                                                            onClick={() => toggleCategory(category.category)}
                                                            className="w-full flex items-center justify-between p-3 md:p-2 text-left text-sm font-bold text-slate-300 hover:bg-slate-800 rounded transition-colors"
                                                        >
                                                            <span className="uppercase tracking-wider text-[10px] sm:text-xs text-indigo-300">{category.category}</span>
                                                            {isExpanded ? <ChevronDown size={14} /> : <ChevronRight size={14} />}
                                                        </button>
                                                        
                                                        {isExpanded && (
                                                            <div className="ml-2 mt-1 space-y-0.5 border-l border-slate-700 pl-2">
                                                                {category.items
                                                                    .filter(item => !screenSearch || item.title.toLowerCase().includes(screenSearch.toLowerCase()))
                                                                    .map((item, i) => (
                                                                        <button 
                                                                            key={i}
                                                                            onClick={() => setSelectedRule(item)}
                                                                            className={`w-full text-left px-3 py-2 md:px-2 md:py-1.5 text-sm md:text-xs rounded transition-colors ${selectedRule === item ? 'bg-indigo-600 text-white font-bold shadow-md' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-800/50'}`}
                                                                        >
                                                                            {item.title}
                                                                        </button>
                                                                    ))
                                                                }
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                            {RULES_DATA.every(cat => !cat.items.some(i => i.title.toLowerCase().includes(screenSearch.toLowerCase()))) && (
                                                <div className="text-center text-slate-500 py-4 text-xs italic">No rules match your search.</div>
                                            )}
                                        </div>
                                    </div>

                                    {/* RIGHT: CONTENT DISPLAY */}
                                    {/* Mobile Logic: Hidden if NO rule is selected (so we show the list) */}
                                    <div className={`flex-1 bg-slate-800/50 border border-slate-700 rounded-xl p-4 md:p-6 overflow-y-auto flex-col items-start shadow-inner ${selectedRule ? 'flex' : 'hidden md:flex'}`}>
                                        {selectedRule ? (
                                            <div className="w-full animate-fade-in">
                                                {/* Back Button for Mobile */}
                                                <button 
                                                    onClick={() => setSelectedRule(null)} 
                                                    className="md:hidden mb-4 flex items-center gap-2 text-xs font-bold text-indigo-300 bg-slate-900/80 px-3 py-2 rounded-lg border border-slate-700 w-full justify-center"
                                                >
                                                    <ChevronLeft size={14}/> Back to Index
                                                </button>

                                                <div className="inline-block px-3 py-1 bg-indigo-900/50 text-indigo-300 text-[10px] font-bold uppercase tracking-widest rounded-full mb-3 border border-indigo-500/30">
                                                    Rule Details
                                                </div>
                                                <h2 className="text-2xl md:text-3xl font-bold text-white mb-4 border-b border-slate-700 pb-4">{selectedRule.title}</h2>
                                                <div className="prose prose-invert max-w-none text-slate-300 leading-loose text-base md:text-lg whitespace-pre-wrap">
                                                    {selectedRule.text}
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="w-full h-full flex flex-col items-center justify-center text-slate-600 opacity-50 select-none">
                                                <Grid size={64} strokeWidth={1} className="mb-4 text-slate-700"/>
                                                <p className="text-xl font-serif italic text-center">Select a rule from the index<br/>to view details.</p>
                                            </div>
                                        )}
                                    </div>

                                </div>
                            )}
                        </main>
                    </div>

                    {/* MODALS (Settings & Help) */}
                    {showSettingsModal && (
                        <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
                            <div className="bg-gray-900 w-full max-w-md rounded-xl shadow-2xl border border-gray-700 flex flex-col">
                                <div className="flex justify-between items-center p-4 border-b border-gray-700"><h2 className="text-xl font-bold text-white flex items-center gap-2"><Settings className="text-slate-400" /> Settings</h2><button onClick={() => setShowSettingsModal(false)} className="text-slate-400 hover:text-white"><X size={24} /></button></div>
                                <div className="p-6"><label className="block text-sm font-bold text-white mb-2 flex items-center gap-2"><Key size={16} className="text-yellow-500" /> Gemini API Key</label><input type="password" placeholder="Paste your key here..." className="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none mb-2" value={userApiKey} onChange={(e) => setUserApiKey(e.target.value)} /><p className="text-xs text-slate-400 mb-4">The AI features require a Google Gemini API Key. Stored locally.<br/><br/><a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noreferrer" className="text-indigo-400 underline hover:text-indigo-300">Get a free API Key here</a></p><div className="flex justify-end"><button onClick={() => {setShowSettingsModal(false); showNotification("Settings saved!", "success");}} className="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded font-bold">Save & Close</button></div></div>
                            </div>
                        </div>
                    )}
                    {showHelpModal && (
                        <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
                            <div className="bg-slate-900 w-full max-w-lg rounded-xl border border-slate-700 p-6 shadow-2xl max-h-[80vh] overflow-y-auto">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold text-white flex items-center gap-2"><CircleHelp className="text-indigo-400"/> Akashic Guide</h2>
                                    <button onClick={() => setShowHelpModal(false)}><X size={24} className="text-slate-400 hover:text-white"/></button>
                                </div>
                                <div className="space-y-4 text-sm text-slate-300">
                                    <div className="bg-slate-800 p-3 rounded border border-slate-700 mb-4">
                                        <div className="flex justify-between items-center">
                                            <div>
                                                <h3 className="text-amber-400 font-bold text-sm">Version {CURRENT_VERSION}</h3>
                                                <p className="text-xs text-slate-400">See what's new in this update.</p>
                                            </div>
                                            <button onClick={() => { setShowHelpModal(false); setShowChangelogModal(true); }} className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold rounded flex items-center gap-2 border border-slate-600 transition-colors">
                                                <Info size={14} className="text-amber-400"/> View Changelog
                                            </button>
                                        </div>
                                    </div>

                                    <div>
                                        <h3 className="text-white font-bold mb-1 flex items-center gap-2"><User size={14}/> Setup</h3>
                                        <p>Add players and monsters. Use the <Sparkles size={12} className="inline text-indigo-400"/> icon to auto-generate 5e stat blocks using AI. Use the Reset icon to clear the form.</p>
                                    </div>
                                    
                                    <div>
                                        <h3 className="text-white font-bold mb-1 flex items-center gap-2"><CastleGate size={14}/> Battlefield</h3>
                                        <p>Track Initiative, HP, and Conditions. Click the <BookOpen size={12} className="inline"/> icon to see AI-generated stat blocks. Use the "Next Turn" button to advance the round.</p>
                                    </div>

                                    <div>
                                        <h3 className="text-white font-bold mb-1 flex items-center gap-2"><FlaskConical size={14}/> Homebrew Lab</h3>
                                        <p>Describe a concept and let AI brew a full monster stat block for you. Save it to your local bank for future encounters. Use the dedicated **Backup/Restore** buttons to save your bank locally.</p>
                                    </div>

                                    <div>
                                        <h3 className="text-white font-bold mb-1 flex items-center gap-2"><Grid size={14}/> DM Information</h3>
                                        <p>A quick reference guide for Conditions, Actions, Cover, Resting, and more. Searchable for fast lookups.</p>
                                    </div>

                                    <div>
                                        <h3 className="text-white font-bold mb-1 flex items-center gap-2"><Settings size={14}/> Tools</h3>
                                        <ul className="list-disc list-inside space-y-1 ml-1 text-slate-400">
                                            <li><strong>Dice Roller:</strong> Quick rolls with modifiers and history.</li>
                                            <li><strong>Battle Log:</strong> A chronicle of turns, damage, and events.</li>
                                            <li><strong>Import/Export:</strong> Save your encounter state (combatants, logs, state) to a JSON file.</li>
                                        </ul>
                                    </div>

                                    <div className="pt-6 mt-6 border-t border-slate-700 text-center">
                                        <p className="text-indigo-300 italic font-serif text-lg">"Thank you for trying this out!"</p>
                                        <p className="text-slate-500 text-xs mt-1 uppercase tracking-widest">— by Nafwise</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        }

        // FIX: Using ReactDOM.createRoot for React 18 compatibility (best for modern browsers)
        window.onload = function() {
            setTimeout(() => {
                console.log("DOM loaded. Attempting React 18 mount...");
                try {
                    const rootElement = document.getElementById('root');
                    if (rootElement) {
                         const root = ReactDOM.createRoot(rootElement);
                         root.render(<ErrorBoundary><App /></ErrorBoundary>);
                         console.log("React mounted successfully.");
                    } else {
                         throw new Error("Root element not found.");
                    }
                } catch (e) {
                    console.error("React Mounting Failed:", e);
                    document.getElementById('root').innerHTML = `<div class="text-white text-center mt-20">Failed to load app. Check console.</div>`;
                }
            }, 100); 
        };
    </script>
</body>
</html>