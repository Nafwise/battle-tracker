<!DOCTYPE html>
<html lang="en">
<head><script src="./firebase-config.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monster Workshop</title>
    
    <!-- PWA / Mobile App Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0F172A">

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React 18 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Polyfills & Babel -->
    <script src="https://cdn.jsdelivr.net/npm/core-js-bundle@3.37.1/minified.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* --- The Astral Plane Palette --- */
        :root {
            --astral-bg: #0F172A;       /* Deep Midnight Midnight Blue (The Void) */
            --astral-card: #1E293B;     /* Lighter Slate Blue */
            --astral-input: #020617;    /* Almost Black for depth */
            --text-primary: #F8FAFC;    /* Starlight White */
            --text-secondary: #94A3B8;  /* Nebula Grey */
            --accent-cyan: #38BDF8;     /* Cyan/Ether (Active) */
            --accent-purple: #A855F7;   /* Mystic Purple (Magic) */
            --accent-red: #F43F5E;      /* Rose Red (Danger) */
            --border-color: #334155;    /* Slate border */
        }

        body {
             background-color: #020617; 
             font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
             color: var(--text-primary);
             overscroll-behavior-y: none;
             -webkit-user-select: none;
             user-select: none;
             -webkit-tap-highlight-color: transparent;
        }
        
        input, textarea, .selectable-text {
            -webkit-user-select: text;
            user-select: text;
        }

        .astral-container {
            background-color: var(--astral-bg);
            background-image: radial-gradient(circle at top right, #1e293b 0%, #0f172a 60%);
            box-shadow: 0 0 40px rgba(56, 189, 248, 0.05), 0 0 0 1px #334155;
            border-radius: 12px;
            margin: 20px auto;
            max-width: 1200px;
            min-height: 95vh;
        }
        
        @media (max-width: 640px) {
             .astral-container {
                 margin: 0;
                 border-radius: 0;
                 box-shadow: none;
                 min-height: 100vh;
                 border: none;
             }
        }
        
        /* General Styling Overrides (Tailwind mapping for theme) */
        .text-red-500, .text-red-400 { color: var(--accent-red) !important; }
        .text-green-400, .text-green-500, .bg-green-600 { background-color: var(--accent-cyan) !important; color: #0F172A !important; font-weight: 800 !important;}
        .text-indigo-400, .bg-indigo-600 { background-color: var(--accent-purple) !important; color: white !important;}
        .bg-slate-900, .bg-gray-900 { background-color: var(--astral-input) !important; border-color: var(--border-color) !important; }
        .bg-slate-800, .bg-gray-800 { background-color: var(--astral-card) !important; border-color: var(--border-color) !important; }
        .border-slate-600, .border-slate-700 { border-color: var(--border-color) !important; }
        .floating-button { z-index: 90; position: fixed; bottom: 20px; right: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        input, textarea, select { background-color: var(--astral-input) !important; border-color: var(--border-color) !important; color: var(--text-primary) !important; font-size: 16px !important; }
        input:focus, textarea:focus { border-color: var(--accent-cyan) !important; box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2) !important; outline: none !important; }
        .masonry-grid { column-count: 1; column-gap: 1rem; }
        @media (min-width: 640px) { .masonry-grid { column-count: 2; } }
        @media (min-width: 1024px) { .masonry-grid { column-count: 3; } }
    </style>
</head>
<body class="bg-slate-950 text-slate-100">
    <div id="root"></div>

    <!-- FIREBASE IMPORTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Import all Firestore functions needed
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase instances to be initialized and used by the React app
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.currentUserId = null;
        window.isAuthReady = false;

        // Initialize Firebase
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (Object.keys(firebaseConfig).length > 0) {
            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.auth = getAuth(window.firebaseApp);
            setLogLevel('Debug'); // Enable debug logging

            const authInit = async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(window.auth, initialAuthToken);
                    } else {
                        await signInAnonymously(window.auth);
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                    // Fallback to anonymous sign-in if custom token fails
                    await signInAnonymously(window.auth);
                }
            };
            
            // Listen for auth state changes and update global variables
            onAuthStateChanged(window.auth, (user) => {
                if (user) {
                    window.currentUserId = user.uid;
                } else {
                    // If sign-out or initial state is unauthenticated, use a random ID
                    window.currentUserId = crypto.randomUUID();
                }
                window.isAuthReady = true;
                // Re-render the React app to ensure data loading starts
                // A custom event is used here to trigger React update from module scope
                document.dispatchEvent(new CustomEvent('auth-ready'));
            });

            authInit();
            
            // --- EXPOSE FIREBASE FUNCTIONS TO WINDOW FOR REACT/BABEL SCRIPT ---
            // This ensures all Firestore modular functions are available globally.
            window.firebase = {
                doc,
                setDoc,
                deleteDoc,
                onSnapshot,
                collection,
                query,
                serverTimestamp,
                getDocs
            };

        } else {
            console.error("Firebase configuration not found. Firestore will be disabled.");
            window.isAuthReady = true;
            document.dispatchEvent(new CustomEvent('auth-ready'));
        }
    </script>


    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- ICONS ---
        const Icon = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const FlaskConical = (props) => <Icon {...props}><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2" /><path d="M8.5 2h7" /><path d="M7 16h10" /></Icon>;
        const Grid = (props) => <Icon {...props}><rect width="7" height="7" x="3" y="3" rx="1" /><rect width="7" height="7" x="14" y="3" rx="1" /><rect width="7" height="7" x="14" y="14" rx="1" /><rect width="7" height="7" x="3" y="14" rx="1" /></Icon>;
        const ChevronDown = (props) => <Icon {...props}><path d="m6 9 6 6 6-6"/></Icon>;
        const ChevronRight = (props) => <Icon {...props}><path d="m9 18 6-6-6-6"/></Icon>;
        const X = (props) => <Icon {...props}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></Icon>; 
        const Loader2 = (props) => <Icon {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56" /></Icon>;
        const Save = (props) => <Icon {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></Icon>;
        const Trash2 = (props) => <Icon {...props}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></Icon>; 
        const Pencil = (props) => <Icon {...props}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></Icon>;
        const Ghost = (props) => <Icon {...props}><path d="M9 22l2-2.5L13 22l2-2.5L17 22V10a5 5 0 0 0-5-5 5 5 0 0 0-5 5v12z" /><circle cx="10" cy="13" r="2" /><circle cx="14" cy="13" r="2" /><path d="M19 3a2 2 0 0 0-2 2c0 .5.5 1 1 1h2a2 2 0 0 0 2-2 2 2 0 0 0-2-2z" /></Icon>;
        const RotateCcw = (props) => <Icon {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></Icon>;
        const CircleHelp = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" /><line x1="12" y1="17" x2="12.01" y2="17" /></Icon>;
        const CheckCircle = (props) => <Icon {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></Icon>;
        const AlertTriangle = (props) => <Icon {...props}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" /><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" /></Icon>;
        const Settings = (props) => <Icon {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></Icon>;
        const Key = (props) => <Icon {...props}><path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" /></Icon>;
        const Database = (props) => <Icon {...props}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></Icon>;
        const Download = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></Icon>;
        const Upload = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></Icon>;
        const Info = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></Icon>;
        const Search = (props) => <Icon {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></Icon>;
        const Filter = (props) => <Icon {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></Icon>;
        const BookOpen = (props) => <Icon {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" /><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" /></Icon>;
        const Dices = (props) => <Icon {...props}><path d="m21 16-5.87-4.4a1 1 0 0 0-1.12-.08L9 15"/><path d="M11.5 11 9 15l-2.43 1.82a1 1 0 0 0 .09 1.63L12 21l4.58-2.32a1 1 0 0 0 .5-1.12z"/><path d="M15 9l-3.07-2.3a1 1 0 0 0-1.21-.08L6 10l-1.38 3a1 1 0 0 0 .09 1.07l2.25 3L9 15l2.5-4"/><path d="M2 12h5"/><path d="M22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6z"/></Icon>;
        const ScrollText = (props) => <Icon {...props}><path d="M8 21h12a2 2 0 0 0 2-2v-2H10v2a2 2 0 1 1-4 0V5a2 2 0 1 0-4 0v3h4"/><path d="M19 17V5a2 2 0 0 0-2-2H4"/></Icon>;
        const CastleGate = (props) => (<Icon {...props}><path d="M19 21v-8a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v8"/><path d="M4 11V7"/><path d="M20 11V7"/><path d="M2 7h4v4H2z"/><path d="M18 7h4v4h-4z"/><path d="M4 7l2-4 2 4"/><path d="M18 7l2-4 2 4"/><path d="M10 21v-4a2 2 0 0 1 4 0v4"/></Icon>);
        const Gem = (props) => <Icon {...props}><path d="M6 3h12l4 6-10 13L2 9Z"/><path d="M11 3 8 9l4 13 4-13-3-6"/><path d="M2 9h20"/></Icon>;


        // --- CONSTANTS & UTILITIES (SHARED) ---
        const MONSTER_TYPES = [
            "Aberration", "Beast", "Celestial", "Construct", "Dragon", "Elemental", 
            "Fey", "Fiend", "Giant", "Humanoid", "Monstrosity", "Ooze", "Plant", "Undead", "Unknown"
        ];
        const INITIAL_MONSTER_DETAILS = { resistances: '', vulnerabilities: '', actions: '', statBlockSummary: '', type: 'Unknown' };
        const LAST_ACKNOWLEDGED_VERSION_KEY = 'dm-tools-acknowledged-version';
        const HARDCODED_API_KEY = ""; 
        const CURRENT_VERSION = "1.2.0"; 
        const INPUT_CLASS = "w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 focus:outline-none focus:border-indigo-500 text-sm";
        
        // This generateId is used for *new* monsters before they are saved to Firestore, where Firestore assigns the final ID.
        // It's also used for import/export uniqueness.
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        
        // Removed safeLoad utility as we are now using Firestore
        const sanitizeHtml = (str) => { if (!str) return ''; return str.replace(/<script\b[^>]*>([\s\S]*?)<\/script>/gm, "").replace(/on\w+="[^"]*"/g, ""); };
        const handleInputBlur = () => { setTimeout(() => { if (document.activeElement === document.body) window.scrollTo({ top: 0, behavior: 'smooth' }); }, 150); };
        
        // DM SCREEN CONTENT - COMPREHENSIVE (Only needed here)
        const RULES_DATA = [
            // ... (Rules data remains unchanged for brevity)
            { category: "Conditions & Exhaustion", items: [ 
                { title: "Blinded", text: "A blinded creature can't see and automatically fails any ability check requiring sight. Attack rolls against the creature have advantage, and the creature's Attack rolls have disadvantage." }, 
                { title: "Charmed", text: "A charmed creature can't Attack the charmer or target the charmer with harmful Abilities or magical Effects. The charmer has advantage on any ability check to Interact socially with the creature." }, 
                { title: "Deafened", text: "A deafened creature can't hear and automatically fails any ability check requiring hearing." },
                { title: "Frightened", text: "A frightened creature has disadvantage on Ability Checks and Attack rolls while the source of its fear is within line of sight. The creature can't willingly move closer to the source of its fear." },
                { title: "Grappled", text: "Speed becomes 0, and it can't benefit from any bonus to its speed. The condition ends if the grappler is incapacitated or if an effect removes the grappled creature from the reach of the grappler." },
                { title: "Incapacitated", text: "An incapacitated creature can’t take Actions or Reactions." },
                { title: "Invisible", text: "An invisible creature is impossible to see without the aid of magic or a special sense. For the purpose of Hiding, the creature is heavily obscured. The creature’s location can be detected by any noise it makes or tracks it leaves. Attack rolls against the creature have disadvantage, and the creature's Attack rolls have advantage." },
                { title: "Paralyzed", text: "A paralyzed creature is incapacitated and can't move or speak. The creature automatically fails Strength and Dexterity Saving Throws. Attack rolls against the creature have advantage. Any Attack that hits the creature is a critical hit if the attacker is within 5 feet of the creature." },
                { title: "Petrified", text: "The creature is transformed into a solid inorganic substance (usually stone) and is incapacitated, unaware of its surroundings. Attack rolls against the creature have advantage. The creature has Resistance to all damage. The creature is immune to poison and disease, although a poison or disease already in its System is suspended, not neutralized." },
                { title: "Poisoned", text: "A poisoned creature has disadvantage on Attack rolls and Ability Checks." },
                { title: "Prone", text: "The creature's only Movement option is to crawl, unless it stands up. The creature has disadvantage on Attack rolls. An Attack roll against the creature has advantage if the attacker is within 5 feet of the creature. Otherwise, the Attack roll has disadvantage." },
                { title: "Restrained", text: "The creature’s Speed becomes 0, and it can’t benefit from any bonus to its speed. Attack rolls against the creature have advantage, and the creature’s Attack rolls have disadvantage. The creature has disadvantage on Dexterity Saving Throws." },
                { title: "Stunned", text: "The creature is incapacitated, can’t move, and can speak only falteringly. The creature automatically fails Strength and Dexterity Saving Throws. Attack rolls against the creature have advantage." },
                { title: "Unconscious", text: "The creature is incapacitated, can’t move or speak, and is unaware of its surroundings. The creature drops whatever it’s holding and falls prone. The creature automatically fails Strength and Dexterity Saving Throws. Attack rolls against the creature have advantage. Any Attack that hits the creature is a critical hit if the attacker is within 5 feet of the creature." },
                { title: "Exhaustion Lvl 1", text: "Disadvantage on Ability Checks." },
                { title: "Exhaustion Lvl 2", text: "Speed halved." },
                { title: "Exhaustion Lvl 3", text: "Disadvantage on Attack rolls and Saving Throws." },
                { title: "Exhaustion Lvl 4", text: "Hit point maximum halved." },
                { title: "Exhaustion Lvl 5", text: "Speed reduced to 0." },
                { title: "Exhaustion Lvl 6", text: "Death." }
            ] },
            { 
                category: "Combat Actions & Rules", 
                items: [ 
                    { title: "Attack", text: "Melee or Ranged Attack. Can be replaced by two-weapon fighting, grapple, or shove." }, 
                    { title: "Dash", text: "You gain extra Movement for the current turn equal to your speed. You must use a bonus action to Dash if you have the Cunning Action class feature (Rogue)." },
                    { title: "Dodge", text: "When you take the Dodge action, any Attack roll made against you before the start of your next turn has disadvantage, provided that you can see the attacker. You also make Dexterity Saving Throws with advantage." },
                    { title: "Ready", text: "You prepare an action and specify a trigger. When the trigger occurs, you can use your Reaction to take the prepared action." },
                    { title: "Search", text: "You devote your attention to finding something. The DM typically asks you to make a Wisdom (Perception) or Intelligence (Investigation) check." },
                    { title: "Use an Object", text: "You interact with a second object or manipulate the environment, e.g., opening a difficult door, pulling a lever, or retrieving an item from a backpack. You can interact with one object for free during movement." },
                    { title: "Cast a Spell", text: "If the spell's casting time is 1 action, you cast the spell. Casting a spell that takes longer than 1 action requires concentration." },
                    { title: "Opportunity Attack", text: "Reaction when enemy enemy leaves reach. Disengage prevents this. Attack is made immediately before the target leaves your reach." }, 
                    { title: "Disengage", text: "You spend your action taking the Disengage action, and your movement doesn't provoke opportunity attacks for the rest of the turn." }, 
                    { title: "Help", text: "You take the Help action to aid a friendly creature in attacking a creature within 5 feet of you, granting advantage on the attack roll. Alternatively, you can aid in an ability check, granting advantage on the next roll before your next turn." } 
                ] 
            },
            { 
                category: "Movement & Travel", 
                items: [ 
                    { title: "Travel Pace (Fast)", text: "3 miles per hour (mph), 30 miles per day (mpd). Characters suffer a -5 penalty to passive Perception." }, 
                    { title: "Normal Pace", text: "2 mph, 24 mpd." }, 
                    { title: "Slow Pace", text: "1 mph, 18 mpd. Characters can use Stealth." }, 
                    { title: "High Jump", text: "Running: Height = 3 + Str Mod. Standing: Half that. Each foot jumped costs 1 foot of Movement." }, 
                    { title: "Long Jump", text: "Running: Distance = Str Score. Standing: Half that. Each foot jumped costs 1 foot of Movement." },
                    { title: "Mount Travel (Horse/Pony)", text: "Normal Pace: 4 mph, 32 mpd. Fast Pace: 6 mph, 48 mpd. Mounts cannot travel Fast through difficult terrain for long periods." }, 
                    { title: "Wagon/Cart Travel", text: "Normal Pace: 2 mph, 16 mpd (max load 400 lbs per draft animal). Requires roads or open terrain." },
                    { title: "Ship/Boat Travel", text: "Rowboat: 1.5 mph, 12 mpd. Sailing Ship: 2 mph, 48 mpd (with favorable winds)." },
                    { title: "Chariot/Coach Travel", text: "Fast Pace: 5 mph, 40 mpd. Requires clear roads." },
                    { title: "Difficult Terrain Penalty", text: "Movement through difficult terrain (deep snow, heavy rubble, swamps) costs 2 feet of movement for every 1 foot moved." },
                    { title: "Forced March", text: "Traveling for more than 8 hours per day risks exhaustion. Each extra hour requires a Constitution saving throw (DC 10 + 1 for each hour past 8 hours)." }
                ] 
            },
            { 
                category: "Environment, Light & Vision", 
                items: [ 
                    { title: "Lightly Obscured", text: "Disadvantage on Wisdom (Perception) checks relying on sight. Examples: dim light, patchy fog." }, 
                    { title: "Heavily Obscured", text: "Creatures effectively suffer the Blinded condition. Examples: darkness, thick fog, dense smoke." },
                    { title: "Darkvision & Special Senses", text: "Darkvision allows a creature to treat darkness as dim light within a specified range (usually 60 or 120 ft), seeing only shades of gray. \n\n**Blindsight:** Allows a creature to perceive its surroundings without relying on sight, within a specific radius (e.g., 60 ft). Effective against invisibility and darkness, relies on hearing/vibration." },
                    { title: "Blind Beyond Darkness", text: "Blindness caused by lack of light is negated by Darkvision, but vision through magical darkness (e.g., *darkness* spell) or thick physical barriers requires special abilities (e.g., Truesight or Blindsight)." },
                    { title: "Falling", text: "1d6 bludgeoning damage per 10ft fallen (max 20d6). Creature lands prone unless it avoids damage." }, 
                    { title: "Extreme Cold", text: "Creature must succeed on a DC 10 Constitution saving throw at the end of each hour or gain one level of exhaustion. Creatures with resistance to cold damage automatically succeed." },
                    { title: "Extreme Heat", text: "Creature must succeed on a DC 10 Constitution saving throw at the end of each hour or gain one level of exhaustion. Creatures with resistance to fire damage automatically succeed. Heavy armor imposes disadvantage." },
                    { title: "Breathing (Suffocation)", text: "Creature can hold its breath for a number of minutes equal to 1 + its Constitution modifier (minimum 30 seconds). When a creature runs out of breath, it drops to 0 Hit Points and is dying. In combat, holding your breath is a free action." },
                    { title: "High Altitude", text: "Non-acclimated creatures are fatigued (disadvantage on attack rolls and ability checks) when spending 8 hours or more above 10,000 feet." }
                ] 
            },
            { category: "Resting, Healing & Death", items: [ { title: "Short Rest", text: "1 hour minimum. A character can spend one or more Hit Dice to regain HP (roll HD + Con mod per die)." }, { title: "Long Rest", text: "8 hours minimum (6 hours sleep, 1 hour light activity). Regain all lost HP. Regain spent Hit Dice up to half maximum." }, { title: "Death Saves", text: "3 successes before 3 failures = stabilize. 3 failures = death. Rolling a 20 = regain 1 HP. Rolling a 1 = 2 failures." }, { title: "Potion of Healing", text: "Action to drink. Heals 2d4 + 2 HP." } ] },
            { category: "Ability Checks & DCs", items: [ { title: "Very Easy", text: "DC 5" }, { title: "Easy", text: "DC 10" }, { title: "Moderate", text: "DC 15" }, { title: "Hard", text: "DC 20" }, { title: "Very Hard", text: "DC 25" }, { title: "Nearly Impossible", text: "DC 30" } ] },
            { category: "Spellcasting", items: [ { title: "Concentration", text: "End if: Cast another concentration spell, take damage (Con save DC 10 or half damage taken, whichever is higher, but never less than 10), incapacitated, or killed." }, { title: "Cylinder", text: "Origin is center of circular top/bottom. Extends equal distance above and below the origin point." }, { title: "Sphere", text: "Casts outward from the spell's point of origin." }, { title: "Visual & Somatic", text: "Requires visible hands and ability to speak." } ] },
            { category: "Objects & Structures", items: [ { title: "AC/HP/DT Table", text: `**Object Armor Class (AC)**\nCloth/Paper: 11\nRope/Glass/Ice: 13\nWood/Bone: 15\nStone: 17\nIron/Steel: 19\nAdamantine: 23\n\n**Object Hit Points (HP) - By Size**\n| Size | Fragile (e.g., window) | Resilient (e.g., thick door) |\n|---|---|---|\n| Tiny (Lock, vial) | 2 HP | 5 HP |\n| Small (Chest, Lute) | 3 HP | 10 HP |\n| Medium (Barrel, Door) | 4 HP | 18 HP |\n| Large (Cart, Statue) | 5 HP | 27 HP |\n\n**Damage Threshold (DT)**\nObjects may have a Damage Threshold (DT). If a single attack deals less damage than the DT, the object takes no damage.\n| Material | Common DT |\n|---|---|\n| Stone/Thick Wood | DT 10 |\n| Iron/Steel | DT 15 |\n| Reinforced Stone | DT 20 |` }, { title: "Breaking Objects", text: "When an object has Resistance/Vulnerability to damage, apply it after the DT is crossed. Once an object's HP is reduced to 0, it is destroyed." }, { title: "Common Door AC/HP", text: "Wooden Door: AC 15, HP 18 (DT 10).\nStone Door: AC 17, HP 27 (DT 15).\nIron Door: AC 19, HP 36 (DT 20).\nDC for forcing a door open (Athletics): Typically DC 15 to 20." } ] },
            { category: "Equipment & Services", items: [ { title: "General Store / Adventuring Gear", text: "Torch: 1 cp (1 hr light, 20ft bright/20ft dim)\nRope, Hempen (50ft): 1 gp\nRations (1 day): 5 sp\nWaterskin: 2 sp\nBedroll: 1 gp\nBackpack: 2 gp\nHealer's Kit: 5 gp (10 uses, stabilize without check)" }, { title: "Blacksmith: Weapons & Armor (Basic)", text: "--- Simple Melee ---\nDagger: 2 gp\nClub: 1 sp\nGreatclub: 2 sp\nHandaxe: 5 gp\nLight Hammer: 2 gp\nSpear: 1 gp\n\n--- Simple Ranged ---\nLight Crossbow: 25 gp\nShortbow: 25 gp\n\n--- Armor ---\nPadded Armor: 5 gp (AC 11 + Dex Mod (Max 0))\nLeather Armor: 10 gp (AC 11 + Dex Mod)\nChain Shirt: 50 gp (AC 13 + Dex Mod (Max 2))\nShield: 10 gp (+2 AC)" }, { title: "Herbalist / Alchemist (Poisons & Ingredients)", text: "Antitoxin (vial): 50 gp (Advantage on saves vs poison for 1 hour)\n\nBasic Poison (vial): 100 gp (Injury, DC 10 Con Save or 1d4 poison dmg)\n\nHealer's Kit: 5 gp (10 uses, stabilize without check)\n\nRare Herbs/Components: 5-50 gp (Requires proficiency check to locate/use)." }, { title: "Inn & Tavern", text: "--- Lodging (Per Night) ---\nSqualid: 7 cp / Poor: 1 sp / Modest: 5 sp / Comfortable: 8 sp / Wealthy: 2 gp / Aristocratic: 4 gp+\n\n--- Food & Drink ---\nMug of Ale: 4 cp / Gallon of Ale: 2 sp\nMeal - Modest: 3 sp (Stew & Bread)\nMeal - Comfortable: 5 sp (Roast & Sides)" }, { title: "Guild & Faction Services", text: "--- The Harpers (Spies & Secret Agents) ---\nServices: Information gathering (10-50 gp), Safehouse lodging.\n\n--- The Zhentarim (Mercenaries & Assassins) ---\nServices: Assassination (500 gp+), Smuggling (20% fee), Hired Muscle (2 gp/day).\n\n--- Order of the Gauntlet (Paladins & Clerics) ---\nServices: Armed Escort (10 gp/day), Divine Spellcasting (see Potions & Healing).\n\n--- Local Thieves' Guild ---\nServices: Fencing Stolen Goods (buys at 50% value), Forgery (15-50 gp), Lockpicking/Trap Disarming (20 gp)." } ] },
            { category: "DM Guidance & Tools", items: [ { title: "Social Encounter: Reaction", text: "Use DC 10 + (2/3/5 based on situation) for Persuasion/Deception checks. Remember Attitude: Hostile (needs convincing), Indifferent (neutral), Friendly (wants to help)." }, { title: "Running Travel", text: "Determine marching order, pace, and formation. Check for encounters every day (or every 4 hours in dangerous areas). Use group Wisdom (Perception) checks to detect threats/traps." }, { title: "Improvising DCs", text: "Easy: DC 10 (Minor hurdle). Medium: DC 15 (Standard difficulty). Hard: DC 20 (Major challenge). Reserve 25+ for heroic or impossible tasks." }, { title: "Handling Skill Checks", text: "Don't ask for a check if success is impossible or failure is irrelevant. Ask for a check only if failure creates a compelling consequence. Allow players to describe *how* before rolling." }, { title: "Initiative Tracker Setup", text: "Roll Initiative (d20 + Dex Modifier) for all PCs and monsters (group monsters of the same type together). Order from highest to lowest. Track HP/Conditions next to the order." }, { title: "Inspiration", text: "Reward players with Inspiration when they roleplay well, do something heroic, or make a clever plan. Inspiration grants advantage on one Attack roll, Saving Throw, or Ability Check." } ] }
        ];
        
        // --- DM TOOLS SPECIFIC MODALS/COMPONENTS ---
        const ConfirmationModal = ({ isOpen, title, message, onConfirm, onCancel, confirmText, cancelText }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[120] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
                    <div className="bg-gray-900 w-full max-w-sm rounded-xl border border-red-700 p-6 shadow-2xl">
                        <h2 className="text-xl font-bold text-red-400 mb-4">{title}</h2>
                        <p className="text-slate-300 mb-6 text-sm">{message}</p>
                        <div className="flex justify-end gap-3">
                            <button onClick={onCancel} className="px-4 py-2 text-slate-400 hover:text-white rounded text-sm font-medium border border-slate-700">{cancelText || 'Cancel'}</button>
                            <button onClick={onConfirm} className="px-4 py-2 bg-red-700 hover:bg-red-600 text-white rounded text-sm font-bold">{confirmText || 'Confirm'}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const HomebrewImportModal = ({ file, onConfirm, onClose }) => {
            if (!file) return null;
            return (
                <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
                    <div className="bg-gray-900 w-full max-w-md rounded-xl border border-slate-700 p-6 shadow-2xl">
                        <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2"><Upload className="text-amber-500"/> Restore Homebrew Bank</h2>
                        <p className="text-slate-300 mb-6 text-sm">You are restoring data from: <span className="font-mono text-amber-300">{file.name}</span></p>
                        <div className="space-y-4">
                            <button onClick={() => onConfirm('merge')} className="mt-3 w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 rounded text-sm">Smart Merge (Update Existing + Add New)</button>
                            <button onClick={() => onConfirm('overwrite')} className="mt-3 w-full bg-red-700 hover:bg-red-600 text-white font-bold py-2 rounded text-sm">Overwrite (Replace All)</button>
                        </div>
                        <div className="flex justify-end mt-4"><button onClick={onClose} className="px-4 py-2 text-slate-400 hover:text-white rounded text-sm">Cancel</button></div>
                    </div>
                </div>
            );
        };
        const MonsterStatBlockModal = ({ combatant, onClose }) => {
             if (!combatant?.statBlockSummary) return null;
             const escapeHtml = (unsafe) => { return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
             const renderSummary = (text) => {
                 return text.split('\n').map((line, index) => {
                     let cleanLine = escapeHtml(line);
                     let isHeader = false;
                     // Check for bold headers or known keyword headers
                     if (cleanLine.trim().startsWith('**') && cleanLine.trim().endsWith('**')) { isHeader = true; } else { const upperLine = cleanLine.trim().toUpperCase(); const knownHeaders = ["ACTIONS", "LEGENDARY ACTIONS", "REACTIONS", "SPECIAL TRAITS", "SPELLCASTING"]; if (knownHeaders.includes(upperLine)) { isHeader = true; cleanLine = cleanLine.trim(); } }
                     if (isHeader) { return <h3 key={index} className="!text-sm font-bold mt-3 mb-1 text-red-500">{cleanLine.replace(/\*\*/g, '')}</h3>; }
                     const formattedLine = cleanLine.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<strong>$1</strong>');
                     return <p key={index} dangerouslySetInnerHTML={{ __html: sanitizeHtml(formattedLine) }}></p>;
                 });
             };
             return (
                <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
                    <div className="bg-gray-900 text-gray-50 w-full max-w-2xl rounded-xl shadow-2xl border border-gray-700 flex flex-col max-h-[90vh]">
                        <div className="flex justify-between items-center p-4 border-b border-gray-700 bg-gray-800 rounded-t-xl"><h2 className="text-xl font-bold text-red-400 flex items-center gap-2"><BookOpen className="text-red-400"/> {combatant.name} - Full Stat Block</h2><button onClick={onClose}><X size={24} className="text-gray-400 hover:text-white"/></button></div>
                        <div className="p-6 overflow-y-auto flex-1 stat-block"><h3 className="!text-2xl text-white border-b-2 border-red-500 pb-2 mb-3">{combatant.name.toUpperCase()} <span className="text-xs font-normal text-slate-400 ml-2">({combatant.type || 'Unknown'})</span></h3><p className="text-sm font-mono text-gray-400">HP: {combatant.hp} | AC: {combatant.ac} | Init Mod: {combatant.initMod}</p><div className="mt-4 text-sm text-gray-200">{combatant.statBlockSummary.length > 0 ? renderSummary(combatant.statBlockSummary.replace(/\\n/g, '\n')) : <span className="flex items-center text-red-400"><AlertTriangle className="inline w-4 h-4 text-yellow-500 mr-2" /> Stat block details were not successfully retrieved by the AI.</span>}</div></div>
                        <div className="p-4 border-t border-gray-700 bg-gray-800 rounded-b-xl flex justify-end"><button onClick={onClose} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded text-sm font-medium">Close Stat Block</button></div>
                    </div>
                </div>
            );
        };
        const ChangelogModal = ({ onClose, currentVersion, lastAcknowledged }) => {
            // UPDATED CHANGELOG: Reflects the split from the main app at V1.1.0
            const CHANGELOG_DATA = [
                { 
                    version: currentVersion, 
                    date: "Official Launch", 
                    changes: [
                        "**CR Support:** Added Challenge Rating (CR) field to homebrew monsters. This enables accurate loot generation tiers in the Loot Tracker app.",
                        "**AI Upgrade:** The 'Brew Monster' AI now intelligently assigns a CR based on the monster's description and stats.",
                        "**Cloud Sync:** Homebrew monsters now sync their CR data to the cloud, ensuring full compatibility across the Akashic Suite.",
                        "**Stand Alone App (Integrated):** The Monster Workshop now operates as a dedicated, persistent application. It is fully decoupled from the Tracker logic but remains seamlessly integrated via the new Launch/Return navigation.",
                        "**DB Persistence:** Implemented a robust 'Bridge' system. Your Homebrew Bank is now backed by Firestore with an automatic LocalStorage failsafe. If your session ID rotates, the app detects your local backup and instantly restores your database.",
                        "**Smart Import:** The import system now performs a 'Smart Merge'. It detects monsters by name to update existing stats rather than creating duplicates, keeping your bank clean."
                    ] 
                }
            ];
            
            const needsAcknowledge = currentVersion > lastAcknowledged;

            return (
                <div className="fixed inset-0 z-[120] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
                    <div className="bg-gray-900 w-full max-w-lg rounded-xl shadow-2xl border border-gray-700 flex flex-col max-h-[80vh]">
                        <div className="flex justify-between items-center p-4 border-b border-gray-700 bg-gray-800 rounded-t-xl">
                            <h2 className="text-xl font-bold text-white flex items-center gap-2">
                                <Info className="text-amber-400" /> Changelog
                                {needsAcknowledge && <span className="text-xs bg-amber-600 text-white px-2 py-0.5 rounded-full ml-2">New!</span>}
                            </h2>
                            <button onClick={onClose}><X size={24} className="text-gray-400 hover:text-white"/></button>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            {CHANGELOG_DATA.map((log, index) => (<div key={index} className="mb-6 last:mb-0"><div className="flex justify-between items-center mb-2"><h3 className="text-lg font-bold text-amber-400">Version {log.version}</h3><span className="text-xs text-slate-500 bg-slate-800 px-2 py-1 rounded">{log.date}</span></div><ul className="space-y-2">{log.changes.map((change, i) => (<li key={i} className="text-sm text-slate-300 flex items-start gap-2"><span className="text-amber-500 mt-1">•</span><span dangerouslySetInnerHTML={{ __html: change.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') }}></span></li>))}</ul></div>))}
                        </div>
                        <div className="p-4 border-t border-gray-700 bg-gray-800 rounded-b-xl flex justify-between items-center">
                            {/* Removed Acknowledge Button - Now acknowledges on close */}
                            <span className="text-xs text-slate-500">Viewing version {currentVersion}.</span>
                            <button onClick={onClose} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded text-sm font-bold">Close</button>
                        </div>
                    </div>
                </div>
            );
        };
        const FilenameModal = ({ fileName, setFileName, onClose }) => {
            return (
                <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
                    <div className="bg-gray-900 w-full max-w-md rounded-xl border border-slate-700 p-6 shadow-2xl">
                        <h2 className="text-xl font-bold text-white mb-4">File Options</h2>
                        <div className="mb-4">
                            <label className="block text-xs font-bold text-slate-400 mb-1 uppercase">Export Filename Base</label>
                            {/* Uses localStorage for user preference, which is acceptable */}
                            <input className={INPUT_CLASS} value={fileName} onChange={(e) => setFileName(e.target.value)} onBlur={handleInputBlur} placeholder="homebrew_bank" />
                            <p className="text-xs text-slate-500 mt-1">Used for Homebrew Backup (e.g., `<span className="text-amber-500">{fileName}</span>_HB-Backup.json`).</p>
                        </div>
                        <div className="flex justify-end gap-2"><button onClick={onClose} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded text-sm font-bold">Done</button></div>
                    </div>
                </div>
            );
        };
        const FloatingSettingsButton = ({ apiKey, setModalVisible }) => {
            const isKeyNeeded = !apiKey;
            if (isKeyNeeded) { return (<button onClick={() => setModalVisible(true)} className="floating-button px-4 py-2 flex items-center gap-2 bg-red-700 text-white rounded-full font-bold uppercase text-sm border-2 border-red-500 hover:bg-red-600 transition-colors duration-300 animate-pulse" title="Gemini API Key Needed for AI Features"><AlertTriangle size={16} /> API Key Needed</button>); }
            return (<button onClick={() => setModalVisible(true)} className="floating-button w-10 h-10 flex items-center justify-center bg-slate-700 text-slate-400 hover:text-white rounded-full border border-slate-600 hover:bg-slate-600 transition-colors duration-300" title="AI Settings"><Settings size={20} /></button>);
        };
        
        // --- DM TOOLS SPECIFIC FUNCTIONS ---
        const inferTypeFromStatBlock = (summary) => {
            if (!summary) return 'Unknown';
            const lowerSummary = summary.toLowerCase();
            const match = lowerSummary.match(/\((.*?)\)/);
            if (match && match[1]) {
                const potentialTypes = match[1].split(',').map(s => s.trim());
                for (const potential of potentialTypes) {
                    const typeMatch = MONSTER_TYPES.find(type => potential.startsWith(type.toLowerCase()));
                    if (typeMatch) return typeMatch;
                }
            }
            for (const type of MONSTER_TYPES) { if (type !== 'Unknown' && lowerSummary.includes(type.toLowerCase())) { return type; } }
            return 'Unknown';
        };

        const callGemini = async (prompt, userApiKey) => {
            let attempt = 0;
            if (!userApiKey) return null;
            while (attempt < 3) {
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                    if (!res.ok) throw new Error("API Error");
                    const data = await res.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                } catch (e) { 
                    console.warn(`Gemini API attempt ${attempt + 1} failed. Retrying...`, e);
                    attempt++; 
                    await new Promise(r => setTimeout(r, Math.pow(2, attempt) * 1000)); 
                }
            }
            console.error("Gemini API failed after 3 attempts.");
            return null;
        };

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends React.Component {
            constructor(props) { 
                super(props); 
                this.state = { hasError: false, showResetConfirm: false }; 
            }
            static getDerivedStateFromError(error) { return { hasError: true, showResetConfirm: false }; }
            componentDidCatch(error, errorInfo) { console.error("Uncaught error:", error, errorInfo); }
            
            handleOpenReset = () => { this.setState({ showResetConfirm: true }); };

            handleReset = () => { 
                this.setState({ showResetConfirm: false });
                console.warn("Performing Ritual of Restoration: Clearing local storage (non-Firestore data only) and reloading.");
                // Clear only user preferences and API key stored in localStorage
                localStorage.removeItem('dm-tracker-api-key');
                localStorage.removeItem('dm-tracker-filename');
                window.location.reload(); 
            };

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen bg-slate-950 flex items-center justify-center p-4 text-center">
                            {this.state.showResetConfirm && (
                                <ConfirmationModal 
                                    isOpen={true}
                                    title="System Reset Warning"
                                    message="The application has crashed. A reset will clear local preferences (API key, filename) and reload the app. Your Homebrew monsters stored in Firestore will be preserved."
                                    onConfirm={this.handleReset}
                                    onCancel={() => this.setState({ showResetConfirm: false })}
                                    confirmText="Reset App"
                                />
                            )}
                            <div className="bg-slate-900 p-8 rounded-xl border border-red-900 shadow-2xl max-w-md">
                                <AlertTriangle size={48} className="text-red-500 mx-auto mb-4" />
                                <h1 className="text-2xl font-bold text-white mb-2">Magical Feedback Loop Detected</h1>
                                <p className="text-slate-400 mb-6">The Akashic Tome has encountered a critical error. The Weave is unstable.</p>
                                <button onClick={this.handleOpenReset} className="bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-6 rounded-lg w-full transition-colors">Perform Ritual of Restoration (Reset App)</button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- MAIN APP ---
        function App() {
            // Firestore/Auth state
            const [db, setDb] = useState(null);
            const [userId, setUserId] = useState(null);
            const [appId, setAppId] = useState(null);
            const [isInitialAuthCheckComplete, setIsInitialAuthCheckComplete] = useState(false);
            
            // App State
            const [homebrew, setHomebrew] = useState([]);
            
            // Changelog State
            const [lastAcknowledgedVersion, setLastAcknowledgedVersion] = useState(() => localStorage.getItem(LAST_ACKNOWLEDGED_VERSION_KEY) || '0.0.0');
            const isNewVersionAvailable = (current, acknowledged) => current > acknowledged; // Simple string comparison for X.Y.Z
            const showGlow = isNewVersionAvailable(CURRENT_VERSION, lastAcknowledgedVersion);

            // API Key and filename still use localStorage for *user preference/config*
            const [userApiKey, setUserApiKey] = useState(() => localStorage.getItem('dm-tracker-api-key') || HARDCODED_API_KEY);
            const [exportFileName, setExportFileName] = useState(() => localStorage.getItem('dm-tracker-filename') || 'homebrew_bank');
            const [notification, setNotification] = useState(null);
            const [viewStatBlockMonster, setViewStatBlockMonster] = useState(null);
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [showChangelogModal, setShowChangelogModal] = useState(false);
            const [showFilenameModal, setShowFilenameModal] = useState(false);
            const [showHomebrewImportModal, setShowHomebrewImportModal] = useState(null); 
            const homebrewFileInputRef = useRef(null); 
            
            const [viewMode, setViewMode] = useState('homebrew');
            
            // Homebrew Lab State
            const [labInput, setLabInput] = useState('');
            const [isBrewing, setIsBrewing] = useState(false);
            const [homebrewForm, setHomebrewForm] = useState({ name: '', hp: '', ac: '', initMod: '', type: 'Unknown', cr: '' }); // Added CR
            const [monsterDetails, setMonsterDetails] = useState(INITIAL_MONSTER_DETAILS);
            const [homebrewSearch, setHomebrewSearch] = useState('');
            const [homebrewSortBy, setHomebrewSortBy] = useState('name'); 

            // DM Screen State
            const [screenSearch, setScreenSearch] = useState('');
            const [selectedRule, setSelectedRule] = useState(null);
            const [expandedCategories, setExpandedCategories] = useState(() => {
                const initial = {};
                RULES_DATA.forEach(cat => initial[cat.category] = false);
                return initial;
            });

            // Authentication and Firestore Initialization Effect
            useEffect(() => {
                const handleAuthReady = () => {
                    if (window.isAuthReady && window.db && window.currentUserId) {
                        setDb(window.db);
                        setUserId(window.currentUserId);
                        // __app_id is a global variable from the environment
                        setAppId(typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'); 
                        setIsInitialAuthCheckComplete(true);
                    }
                };

                // Listen for custom event dispatch from module script after auth completes
                document.addEventListener('auth-ready', handleAuthReady);
                // Also call immediately in case the event fired before this component mounted
                handleAuthReady(); 

                return () => {
                    document.removeEventListener('auth-ready', handleAuthReady);
                };
            }, []);

            // Firestore Data Listener Effect
            useEffect(() => {
                // Check 1: Ensure fundamental DB/Auth details are present.
                if (!db || !userId || !appId || !isInitialAuthCheckComplete) {
                    console.log("Firestore data sync waiting for DB, UserId, or initial Auth Check.");
                    return;
                }

                const HOMEBREW_PATH = `artifacts/${appId}/users/${userId}/homebrew`;
                // Now accessing functions directly via window.firebase which is correctly set in the module script
                const q = window.firebase.query(window.firebase.collection(db, HOMEBREW_PATH));

                const unsubscribe = window.firebase.onSnapshot(q, (snapshot) => {
                    const loadedMonsters = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setHomebrew(loadedMonsters);
                }, (error) => {
                    // This error is the "Missing or insufficient permissions" error.
                    console.error("Firestore snapshot error: Missing or insufficient permissions. This usually indicates an issue with Security Rules in the backend.", error);
                    showNotification("Failed to load Homebrew Bank. Check database permissions.", "error");
                    // Important: Set homebrew to empty array to ensure UI loads even if data is unreachable.
                    setHomebrew([]); 
                });

                return () => unsubscribe();
            }, [db, userId, appId, isInitialAuthCheckComplete]); // Depend on all readiness flags

            // Local Storage Effects (for non-critical user preferences)
            useEffect(() => { 
                if (userApiKey && userApiKey !== localStorage.getItem('dm-tracker-api-key')) {
                    localStorage.setItem('dm-tracker-api-key', userApiKey);
                }
            }, [userApiKey]);
            useEffect(() => { 
                localStorage.setItem('dm-tracker-filename', exportFileName); 
            }, [exportFileName]);

            // Changelog Handlers
            const handleChangelogToggle = (shouldOpen) => {
                if (shouldOpen) {
                    setShowChangelogModal(true);
                } else {
                    // Acknowledge logic on close: Set acknowledged version to current version
                    if (isNewVersionAvailable(CURRENT_VERSION, lastAcknowledgedVersion)) {
                        localStorage.setItem(LAST_ACKNOWLEDGED_VERSION_KEY, CURRENT_VERSION);
                        setLastAcknowledgedVersion(CURRENT_VERSION);
                        // Optional notification for feedback
                        // showNotification(`Changelog acknowledged (V${CURRENT_VERSION})`, 'info'); 
                    }
                    setShowChangelogModal(false);
                }
            };
            // Note: The isNewVersionAvailable function remains outside the component logic flow for showGlow computation.

            // Handlers
            const showNotification = (message, type = 'info') => { setNotification({ message, type }); setTimeout(() => setNotification(null), 3000); };
            const openStatBlock = useCallback((monster) => { setViewStatBlockMonster(monster); }, []);
            const toggleCategory = (category) => { setExpandedCategories(prev => ({ ...prev, [category]: !prev[category] })); };
            const clearHomebrewForm = () => { setHomebrewForm({ name: '', hp: '', ac: '', initMod: '', type: 'Unknown', cr: '' }); setMonsterDetails(INITIAL_MONSTER_DETAILS); showNotification("Homebrew form cleared", "info"); };
            
            // Populate form for editing
            const loadMonsterIntoForm = (monster) => {
                setHomebrewForm({
                    name: monster.name,
                    hp: monster.hp,
                    ac: monster.ac,
                    initMod: monster.initMod,
                    type: monster.type || 'Unknown',
                    cr: monster.cr !== undefined ? monster.cr : '' // Keep empty if undefined so user notices
                });
                setMonsterDetails({
                    resistances: monster.resistances || '',
                    vulnerabilities: monster.vulnerabilities || '',
                    actions: monster.actions || '',
                    statBlockSummary: monster.statBlockSummary || ''
                });
                window.scrollTo({ top: 0, behavior: 'smooth' });
                showNotification(`Loaded ${monster.name} for editing.`, "info");
            };

            // Firestore Operations
            const deleteHomebrew = async (id) => {
                if (!db || !userId || !appId) { showNotification("Database not ready.", "error"); return; }
                const HOMEBREW_PATH = `artifacts/${appId}/users/${userId}/homebrew`;
                try {
                    await window.firebase.deleteDoc(window.firebase.doc(db, HOMEBREW_PATH, id));
                    showNotification("Monster deleted.", "info");
                } catch (e) {
                    console.error("Error deleting document:", e);
                    showNotification("Failed to delete monster. Permission denied.", "error");
                }
            };
            
            const saveHomebrewMonster = async (e) => {
                e.preventDefault();
                if (!db || !userId || !appId) { showNotification("Database not ready.", "error"); return; }
                if (!homebrewForm.name || !homebrewForm.hp) { showNotification("Name/HP required", "error"); return; }
                
                const HOMEBREW_PATH = `artifacts/${appId}/users/${userId}/homebrew`;
                const newMonsterData = { 
                    name: homebrewForm.name, 
                    hp: parseInt(homebrewForm.hp), 
                    ac: parseInt(homebrewForm.ac)||10, 
                    initMod: parseInt(homebrewForm.initMod)||0, 
                    cr: parseFloat(homebrewForm.cr) || 0, // ADDED CR
                    type: homebrewForm.type || 'Unknown', 
                    ...monsterDetails,
                    createdAt: window.firebase.serverTimestamp() // Add timestamp for sorting/tracking
                };

                const existing = homebrew.find(h => h.name.toLowerCase() === homebrewForm.name.toLowerCase());
                
                try {
                    if (existing) {
                        // Update existing monster
                        const docRef = window.firebase.doc(db, HOMEBREW_PATH, existing.id);
                        await window.firebase.setDoc(docRef, newMonsterData, { merge: true });
                        showNotification(`Updated existing monster: ${homebrewForm.name}`, "info");
                    } else {
                        // Add new monster
                        // Now accessing functions directly via window.firebase
                        const docRef = window.firebase.doc(window.firebase.collection(db, HOMEBREW_PATH));
                        await window.firebase.setDoc(docRef, newMonsterData);
                        showNotification("Saved to Bank", "success");
                    }
                    clearHomebrewForm();
                } catch (e) {
                    console.error("Error saving document:", e);
                    showNotification("Failed to save monster. Permission denied.", "error");
                }
            };

            const handleBrewMonster = async () => {
                if (!labInput.trim()) { showNotification("Describe your monster first!", "error"); return; }
                if (!userApiKey) { showNotification("Missing API Key", "error"); setShowSettingsModal(true); return; }
                setIsBrewing(true);
                // Updated Prompt to request CR
                const prompt = `You are a D&D 5e Rules Expert. Create a BALANCED, COMPLETE monster stat block based on this concept: "${labInput}". Return a JSON object with: 'name' (string), 'hp' (integer), 'ac' (integer), 'initMod' (integer), 'cr' (number, e.g. 0.25, 2, 15), 'resistances' (string), 'vulnerabilities' (string), 'actions' (string: concise list of action names and damage dice), 'statBlockSummary' (string: A full markdown text block including: Ability Scores, Saving Throws, Skills, Senses, Languages, Challenge, Special Traits, Actions, and Legendary Actions if applicable. Use strict markdown headers like **Actions**.) 'type' (string: e.g. "Aberration", "Beast", "Celestial") Return ONLY valid JSON.`;

                const txt = await callGemini(prompt, userApiKey);
                if (txt) {
                     try {
                        const json = JSON.parse(txt.replace(/```json|```/g, '').trim());
                        let monsterType = json.type || 'Unknown';
                        if (monsterType === 'Unknown' && json.statBlockSummary) { monsterType = inferTypeFromStatBlock(json.statBlockSummary); }
                        // Populate CR here
                        setHomebrewForm({ 
                            name: json.name || "Unknown Beast", 
                            hp: json.hp || 10, 
                            ac: json.ac || 10, 
                            initMod: parseInt(json.initMod) || 0, 
                            cr: parseFloat(json.cr) || 0, // Set CR from AI
                            type: monsterType 
                        });
                        setMonsterDetails({ resistances: json.resistances || '', vulnerabilities: json.vulnerabilities || '', actions: json.actions || '', statBlockSummary: json.statBlockSummary || '', type: monsterType });
                        showNotification("Monster brewed! Review and Save below.", "success");
                     } catch (e) { console.error(e); showNotification("Failed to brew monster. Try again. Check console for details.", "error"); }
                } else {
                    showNotification("AI failed to generate stat block.", "error");
                }
                setIsBrewing(false);
            };

            const handleExportHomebrew = () => {
                // Export the current state of homebrew loaded from Firestore
                const blob = new Blob([JSON.stringify(homebrew, null, 2)], { type: "application/json" });
                const href = URL.createObjectURL(blob);
                const baseName = exportFileName.trim().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '') || `homebrew_bank`;
                const fileName = `${baseName}_HB-Backup.json`;
                const link = document.createElement('a');
                link.href = href; link.download = fileName; document.body.appendChild(link); link.click(); document.body.removeChild(link);
                showNotification(`Homebrew Bank saved as ${fileName}`, "success");
            };

            const handleHomebrewImportClick = () => { if (homebrewFileInputRef.current) { homebrewFileInputRef.current.click(); } };
            const handleHomebrewFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (!Array.isArray(importedData)) throw new Error("File content is not a list of monsters.");
                        setShowHomebrewImportModal({ data: importedData, name: file.name });
                    } catch (err) { showNotification("Failed to parse Homebrew file: " + err.message, "error"); }
                    e.target.value = null; 
                };
                reader.readAsText(file);
            };

            const handleHomebrewConfirm = async (strategy) => {
                if (!db || !userId || !appId) { showNotification("Database not ready.", "error"); setShowHomebrewImportModal(null); return; }

                const { data: importedMonsters } = showHomebrewImportModal;
                const HOMEBREW_PATH = `artifacts/${appId}/users/${userId}/homebrew`;
                const processedImports = importedMonsters.map(m => { 
                    // Clean up/re-ID monsters from the imported file
                    const cleanedMonster = { ...m };
                    delete cleanedMonster.id; 
                    delete cleanedMonster.createdAt;
                    if ((!cleanedMonster.type || cleanedMonster.type === 'Unknown') && cleanedMonster.statBlockSummary) { 
                        cleanedMonster.type = inferTypeFromStatBlock(cleanedMonster.statBlockSummary); 
                    } 
                    return cleanedMonster;
                }).filter(m => m.name && m.hp);

                let monstersToWrite = [];
                let existingMonsters = homebrew;

                if (strategy === 'overwrite') {
                    // 1. Delete all existing documents first
                    const deletePromises = existingMonsters.map(m => 
                        window.firebase.deleteDoc(window.firebase.doc(db, HOMEBREW_PATH, m.id))
                    );
                    await Promise.all(deletePromises);
                    monstersToWrite = processedImports;
                    showNotification(`Overwrote Homebrew Bank with ${monstersToWrite.length} entries.`, "success");

                } else if (strategy === 'merge') {
                    const existingNames = new Set(existingMonsters.map(m => m.name.toLowerCase()));
                    monstersToWrite = processedImports.filter(m => !existingNames.has(m.name.toLowerCase()));
                    showNotification(`Merged: Added ${monstersToWrite.length} new entries to Homebrew Bank.`, "success");
                }
                
                // 2. Write new/merged documents
                const writePromises = monstersToWrite.map(m => {
                    const docRef = window.firebase.doc(window.firebase.collection(db, HOMEBREW_PATH));
                    return window.firebase.setDoc(docRef, { ...m, createdAt: window.firebase.serverTimestamp() });
                });
                await Promise.all(writePromises);

                setShowHomebrewImportModal(null);
            };


            const getProcessedHomebrew = () => {
                let filtered = homebrew.filter(h => h.name.toLowerCase().includes(homebrewSearch.toLowerCase()) || (h.type && h.type.toLowerCase().includes(homebrewSearch.toLowerCase())));
                if (homebrewSortBy === 'name') { return { type: 'flat', data: filtered.sort((a, b) => a.name.localeCompare(b.name)) }; } 
                else {
                    const grouped = {};
                    filtered.forEach(h => { const t = h.type || "Unknown"; if (!grouped[t]) grouped[t] = []; grouped[t].push(h); });
                    const sortedKeys = Object.keys(grouped).sort();
                    return { type: 'grouped', data: grouped, keys: sortedKeys };
                }
            };
            const processedHomebrew = getProcessedHomebrew();

            // Navigation and Tool items
            const NAV_ITEMS = [{ mode: 'homebrew', label: 'Homebrew', icon: FlaskConical }, { mode: 'screen', label: 'DM Information', icon: Grid }];


            return (
                <div className="min-h-screen pb-20 font-serif">
                    {notification && <div className={`fixed top-4 right-4 z-[120] px-4 py-3 rounded shadow-xl flex items-center gap-2 animate-fade-in ${notification.type==='error'?'bg-red-600 text-white':'bg-green-600 text-white'}`}>{notification.type==='error'?<AlertTriangle size={18}/>:<CheckCircle size={18}/>}<span>{notification.message}</span></div>}
                    
                    {viewStatBlockMonster && <MonsterStatBlockModal combatant={viewStatBlockMonster} onClose={() => setViewStatBlockMonster(null)} />}
                    {showFilenameModal && <FilenameModal fileName={exportFileName} setFileName={setExportFileName} onClose={() => setShowFilenameModal(false)} />}
                    {/* The next two modals are placeholders and don't need implementation yet */}
                    {/* {showDiceModal && <DiceRollerModal onClose={() => setShowDiceModal(false)} addToLog={addToLog} />} */}
                    {/* {showLogModal && <BattleLogModal logs={battleLogs} onClose={() => setBattleLogs(false)} onClear={() => setBattleLogs([])} />} */}
                    {showHomebrewImportModal && <HomebrewImportModal file={showHomebrewImportModal} onConfirm={handleHomebrewConfirm} onClose={() => setShowHomebrewImportModal(null)} />}
                    
                    {showChangelogModal && (
                        <ChangelogModal 
                            onClose={() => handleChangelogToggle(false)}
                            currentVersion={CURRENT_VERSION}
                            lastAcknowledged={lastAcknowledgedVersion}
                        />
                    )}

                    <FloatingSettingsButton apiKey={userApiKey} setModalVisible={setShowSettingsModal} />

                    <div className="astral-container relative z-10 p-2 sm:p-4">
                        <header className="bg-slate-800 border-b border-slate-700 sticky top-0 z-50 shadow-md -mx-2 sm:-mx-4 -mt-2 sm:-mt-4 px-4 py-3 mb-4">
                            <div className="max-w-6xl mx-auto">
                                <div className="flex justify-between items-center mb-3">
                                    <div className="flex items-center gap-3"><FlaskConical className="text-amber-500 w-6 h-6 sm:w-8 sm:h-8" /><h1 className="text-lg sm:text-2xl font-bold tracking-tight text-white">Monster Workshop</h1></div>
                                    
                                    <div className="flex flex-col items-end gap-2">
                                        <div className="flex gap-2">
                                             <a href="./loot.html" className="flex items-center gap-2 bg-yellow-600 hover:bg-yellow-500 text-white border-2 border-yellow-700 hover:border-yellow-400 px-3 py-1.5 rounded-full text-xs font-bold transition-all no-underline shadow-[0_0_15px_rgba(234,179,8,0.5)] hover:shadow-[0_0_25px_rgba(234,179,8,0.8)] hover:scale-105" title="Open Loot Records">
                                                <div className="bg-black/30 rounded-full p-0.5"><Gem size={14} className="text-white" /></div>
                                                <span className="hidden sm:inline">Loot!</span>
                                            </a>
                                             <a href="./tome.html" className="flex items-center gap-2 bg-purple-900 hover:bg-purple-800 text-white px-3 py-1.5 rounded-full text-xs font-bold transition-all shadow-[0_0_15px_rgba(147,51,234,0.5)] border border-purple-700 hover:border-purple-500 hover:shadow-[0_0_25px_rgba(147,51,234,0.8)] hover:scale-105 active:scale-95 no-underline">
                                                <CastleGate size={16} />
                                                <span>Tracker</span>
                                            </a>
                                        </div>
                                        {userId && <div className="text-[10px] text-slate-500 font-mono break-all leading-tight"><span className="text-amber-400">User ID:</span> {userId}</div>}
                                    </div>
                                </div>
                                <div className="flex flex-col sm:flex-row justify-between items-center gap-3">
                                    <div className="flex bg-slate-900 p-1 rounded-lg border border-slate-700 w-full sm:w-auto overflow-x-auto no-scrollbar">
                                        {NAV_ITEMS.map(item => (
                                            <button key={item.mode} onClick={() => setViewMode(item.mode)} className={`flex-1 px-3 py-2 text-xs sm:text-sm font-bold rounded capitalize transition-colors whitespace-nowrap flex items-center justify-center gap-2 ${viewMode === item.mode ? (item.mode==='homebrew'?'bg-amber-700 text-white':'bg-indigo-600 text-white') : 'text-slate-400 hover:text-white'}`}>
                                                <item.icon size={16} />
                                                <span>{item.label}</span>
                                            </button>
                                        ))}
                                    </div>
                                    <div className="flex w-full sm:w-auto gap-2 justify-end">
                                        <div className="flex bg-slate-900 rounded-lg p-1 border border-slate-700 flex-1 sm:flex-none justify-center">
                                            <button onClick={() => setShowFilenameModal(true)} className="p-2 hover:bg-slate-700 rounded text-slate-400 hover:text-white flex items-center justify-center" title="Set File Name">...</button>
                                            <div className="w-px bg-slate-700 mx-1"></div>
                                            <button onClick={handleHomebrewImportClick} className="p-2 hover:bg-slate-700 rounded text-slate-400 hover:text-white flex items-center justify-center" title="Import Homebrew"><Upload size={18}/></button> 
                                            <input type="file" ref={homebrewFileInputRef} onChange={handleHomebrewFileChange} className="hidden" accept=".json" />
                                            <button onClick={handleExportHomebrew} className="p-2 hover:bg-slate-700 rounded text-slate-400 hover:text-white flex items-center justify-center" title="Export Homebrew Bank"><Download size={18}/></button>
                                        </div>
                                        {/* GLOW LOGIC APPLIED HERE */}
                                        <button onClick={() => handleChangelogToggle(true)} 
                                            className={`p-2 bg-slate-900 hover:bg-slate-700 rounded text-slate-400 hover:text-white border border-slate-700 relative transition-all flex items-center justify-center
                                            ${showGlow ? 'ring-2 ring-amber-500 ring-offset-2 ring-offset-slate-800 shadow-lg shadow-amber-500/50' : ''}`} 
                                            title="Help/Guide (Changelog)">
                                            <CircleHelp size={20}/>
                                            {showGlow && <span className="absolute top-0 right-0 w-2 h-2 bg-amber-500 rounded-full animate-pulse"></span>}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </header>

                        <main className="max-w-6xl mx-auto">
                            {/* Removed Setup and Battlefield views for brevity in this response */}

                            {viewMode === 'homebrew' && (
                                <div className="animate-fade-in">
                                    <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 mb-6">
                                        <h2 className="text-lg font-bold text-white mb-4 flex items-center gap-2 text-amber-500"><FlaskConical size={20}/> Monster Homebrew Lab</h2>
                                        <div className="mb-4"><textarea className="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:outline-none focus:border-amber-500 h-24 resize-none" placeholder="Describe your monster concept (e.g., 'A clockwork dragon made of rusty gears that breathes steam')" value={labInput} onChange={(e) => setLabInput(e.target.value)} onBlur={handleInputBlur}></textarea></div>
                                        <button onClick={handleBrewMonster} disabled={isBrewing} className="w-full bg-amber-700 hover:bg-amber-600 text-white font-bold py-2 rounded flex justify-center items-center gap-2">{isBrewing ? <Loader2 size={18} className="animate-spin"/> : <Ghost size={20}/>} {isBrewing ? "Brewing..." : "Brew Monster"}</button>
                                    </div>

                                    <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                                            <h2 className="text-lg font-bold text-white flex items-center gap-2"><Database className="text-amber-500"/> Homebrew Bank</h2>
                                            
                                            {/* SEARCH & SORT TOOLBAR */}
                                            <div className="flex w-full sm:w-auto gap-2">
                                                <div className="relative flex-1 sm:flex-none">
                                                    <input 
                                                        className="bg-slate-900 border border-slate-600 rounded pl-8 pr-3 py-1.5 text-xs text-white focus:border-indigo-500 w-full"
                                                        placeholder="Search bank..."
                                                        value={homebrewSearch}
                                                        onChange={(e) => setHomebrewSearch(e.target.value)}
                                                    />
                                                    <Search size={14} className="absolute left-2.5 top-2 text-slate-500"/>
                                                </div>
                                                <button 
                                                    onClick={() => setHomebrewSortBy(homebrewSortBy === 'name' ? 'type' : 'name')}
                                                    className="flex items-center gap-1.5 px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-slate-300 hover:text-white rounded text-xs font-bold border border-slate-600 transition-colors"
                                                    title={`Sorted by ${homebrewSortBy}`}
                                                >
                                                    <Filter size={14} className={homebrewSortBy === 'type' ? 'text-amber-400' : 'text-slate-400'}/>
                                                    {homebrewSortBy === 'name' ? 'A-Z' : 'Type'}
                                                </button>
                                            </div>
                                        </div>
                                        
                                        {/* NEW: Backup/Restore Buttons */}
                                        <div className="flex gap-2 mb-6">
                                            <button onClick={handleHomebrewImportClick} className="flex-1 flex items-center justify-center gap-2 bg-slate-900 hover:bg-slate-700 text-slate-400 hover:text-white font-bold py-2 px-3 rounded text-sm border border-slate-700">
                                                <Upload size={18}/> Restore
                                            </button>
                                            <input 
                                                type="file" 
                                                ref={homebrewFileInputRef} 
                                                onChange={handleHomebrewFileChange} 
                                                className="hidden" 
                                                accept=".json" 
                                            />
                                            <button onClick={handleExportHomebrew} className="flex-1 flex items-center justify-center gap-2 bg-slate-900 hover:bg-slate-700 text-slate-400 hover:text-white font-bold py-2 px-3 rounded text-sm border border-slate-700">
                                                <Download size={18}/> Backup
                                            </button>
                                        </div>

                                        <form onSubmit={saveHomebrewMonster} className="mb-6 grid grid-cols-2 md:grid-cols-12 gap-3 items-end p-3 bg-slate-700/50 rounded-lg border border-slate-600">
                                            <div className="col-span-2 md:col-span-3"><label className="text-xs text-slate-400 block mb-1">Name</label><input className={INPUT_CLASS} value={homebrewForm.name} onChange={e=>setHomebrewForm({...homebrewForm,name:e.target.value})} onBlur={handleInputBlur} /></div>
                                            <div className="col-span-1 md:col-span-2"><label className="text-xs text-slate-400 block mb-1">Type</label>
                                                <select className={INPUT_CLASS} value={homebrewForm.type} onChange={e=>setHomebrewForm({...homebrewForm,type:e.target.value})}>
                                                    {MONSTER_TYPES.map(t => <option key={t} value={t}>{t}</option>)}
                                                </select>
                                            </div>
                                            <div className="col-span-1 md:col-span-2"><label className="text-xs text-slate-400 block mb-1">HP</label><input type="number" className={INPUT_CLASS} value={homebrewForm.hp} onChange={e=>setHomebrewForm({...homebrewForm,hp:e.target.value})} onBlur={handleInputBlur} /></div>
                                            <div className="col-span-1 md:col-span-2"><label className="text-xs text-slate-400 block mb-1">AC</label><input type="number" className={INPUT_CLASS} value={homebrewForm.ac} onChange={e=>setHomebrewForm({...homebrewForm,ac:e.target.value})} onBlur={handleInputBlur} /></div>
                                            <div className="col-span-1 md:col-span-2"><label className="text-xs text-slate-400 block mb-1">Init Mod</label><input type="number" className={INPUT_CLASS} value={homebrewForm.initMod} onChange={e=>setHomebrewForm({...homebrewForm,initMod:e.target.value})} onBlur={handleInputBlur} /></div>
                                            {/* ADDED CR INPUT FIELD */}
                                            <div className="col-span-1 md:col-span-1"><label className="text-xs text-slate-400 block mb-1 text-amber-500 font-bold">CR</label><input type="number" step="0.125" className={`${INPUT_CLASS} border-amber-900/50 focus:border-amber-500`} value={homebrewForm.cr} onChange={e=>setHomebrewForm({...homebrewForm,cr:e.target.value})} onBlur={handleInputBlur} placeholder="0" /></div>
                                            
                                            <div className="col-span-2 md:col-span-1 flex gap-1">
                                                <button type="button" onClick={clearHomebrewForm} className="bg-slate-800 hover:bg-slate-600 text-slate-400 hover:text-white p-1.5 rounded flex justify-center items-center transition-colors" title="Clear Form"><RotateCcw size={18}/></button>
                                                <button className="flex-1 bg-amber-700 hover:bg-amber-600 text-white py-1.5 rounded flex justify-center items-center" title="Save Monster or Update Existing"><Save size={18}/></button>
                                            </div>
                                        </form>
                                        
                                        {/* DISPLAY LIST */}
                                        <div className="space-y-2">
                                            {processedHomebrew.type === 'flat' ? (
                                                processedHomebrew.data.length > 0 ? (
                                                    processedHomebrew.data.map(h => (
                                                        <div key={h.id} className="flex justify-between items-center bg-slate-900/50 p-3 rounded border border-slate-700">
                                                            <div>
                                                                <div className="font-bold text-white flex items-center gap-2">{h.name} <span className="text-[10px] text-slate-500 font-normal uppercase border border-slate-700 px-1 rounded">{h.type||'Unknown'}</span></div>
                                                                <div className="text-xs text-slate-400">HP: {h.hp} | AC: {h.ac} | Init: {h.initMod >= 0 ? '+' : ''}{h.initMod} | <span className={h.cr === undefined ? "text-amber-500 font-bold animate-pulse" : "text-amber-500 font-bold"}>CR {h.cr !== undefined ? h.cr : '?'}</span></div>
                                                            </div>
                                                            <div className="flex gap-2">
                                                                <button onClick={() => loadMonsterIntoForm(h)} className="text-slate-400 hover:text-indigo-400 p-1 flex items-center justify-center" title="Edit Monster"><Pencil size={16}/></button>
                                                                {h.statBlockSummary && <button onClick={() => openStatBlock(h)} className="text-slate-400 hover:text-white p-1 flex items-center justify-center" title="View Stat Block"><CircleHelp size={16}/></button>}
                                                                <button onClick={()=>deleteHomebrew(h.id)} className="text-slate-500 hover:text-red-500 flex items-center justify-center"><Trash2 size={16}/></button>
                                                            </div>
                                                        </div>
                                                    ))
                                                ) : <div className="text-center text-slate-500 italic py-4">No matching monsters found.</div>
                                            ) : (
                                                /* GROUPED DISPLAY */
                                                processedHomebrew.keys.length > 0 ? (
                                                    processedHomebrew.keys.map(typeKey => (
                                                        <div key={typeKey} className="mb-4">
                                                            <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest border-b border-slate-700 mb-2 pb-1">{typeKey}</h3>
                                                            <div className="space-y-2">
                                                                {processedHomebrew.data[typeKey].map(h => (
                                                                    <div key={h.id} className="flex justify-between items-center bg-slate-900/50 p-3 rounded border border-slate-700">
                                                                        <div>
                                                                            <div className="font-bold text-white">{h.name}</div>
                                                                            <div className="text-xs text-slate-400">HP: {h.hp} | AC: {h.ac} | Init: {h.initMod >= 0 ? '+' : ''}{h.initMod} | <span className={h.cr === undefined ? "text-amber-500 font-bold animate-pulse" : "text-amber-500 font-bold"}>CR {h.cr !== undefined ? h.cr : '?'}</span></div>
                                                                        </div>
                                                                        <div className="flex gap-2">
                                                                            <button onClick={() => loadMonsterIntoForm(h)} className="text-slate-400 hover:text-indigo-400 p-1 flex items-center justify-center" title="Edit Monster"><Pencil size={16}/></button>
                                                                            {h.statBlockSummary && <button onClick={() => openStatBlock(h)} className="text-slate-400 hover:text-white p-1 flex items-center justify-center" title="View Stat Block"><CircleHelp size={16}/></button>}
                                                                            <button onClick={()=>deleteHomebrew(h.id)} className="text-slate-500 hover:text-red-500 flex items-center justify-center"><Trash2 size={16}/></button>
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    ))
                                                ) : <div className="text-center text-slate-500 italic py-4">No matching monsters found.</div>
                                            )}
                                            
                                            {homebrew.length === 0 && <div className="text-center text-slate-500 italic py-4">No homebrew monsters saved.</div>}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {viewMode === 'screen' && (
                                <div className="animate-fade-in flex flex-col md:flex-row gap-4 h-[calc(100vh-140px)] md:h-[75vh]">
                                    <div className={`w-full md:w-1/3 lg:w-1/4 bg-slate-900/50 border border-slate-700 rounded-xl overflow-hidden flex-col ${selectedRule ? 'hidden md:flex' : 'flex'}`}>
                                        <div className="p-3 border-b border-slate-700 bg-slate-900 sticky top-0 z-10"><div className="relative"><input type="text" placeholder="Search rules..." className="w-full bg-slate-800 border border-slate-600 rounded pl-8 pr-8 py-3 text-sm text-white focus:outline-none focus:border-indigo-500" value={screenSearch} onChange={(e) => setScreenSearch(e.target.value)} /><div className="absolute left-2.5 top-3.5 text-slate-400"><Search size={14}/></div>{screenSearch && <button onClick={() => setScreenSearch('')} className="absolute right-2 top-3.5 text-slate-400 hover:text-white"><X size={14}/></button>}</div></div>
                                        <div className="flex-1 overflow-y-auto p-2 space-y-1">
                                            {RULES_DATA.map((category, idx) => {
                                                const matchesSearch = !screenSearch || category.items.some(item => item.title.toLowerCase().includes(screenSearch.toLowerCase()));
                                                if (!matchesSearch) return null;
                                                const isExpanded = expandedCategories[category.category] || screenSearch.length > 0;
                                                return (<div key={idx} className="mb-1">
                                                    {/* UPDATED: Styling the Category Button */}
                                                    <button onClick={() => toggleCategory(category.category)} 
                                                            className={`w-full flex items-center justify-between p-3 md:p-2 text-left text-sm font-bold rounded transition-colors border border-slate-700 mb-1 ${isExpanded ? 'bg-slate-700 text-white' : 'bg-slate-800/50 text-slate-300 hover:bg-slate-700/80'}`}>
                                                        <span className="uppercase tracking-wider text-[10px] sm:text-xs text-indigo-300">{category.category}</span>
                                                        {isExpanded ? <ChevronDown size={14} /> : <ChevronRight size={14} />}
                                                    </button>
                                                    {isExpanded && (
                                                        <div className="ml-2 mt-1 space-y-0.5 border-l border-slate-700 pl-2">
                                                            {category.items.filter(item => !screenSearch || item.title.toLowerCase().includes(screenSearch.toLowerCase())).map((item, i) => (
                                                                <button key={i} 
                                                                    onClick={() => setSelectedRule(item)} 
                                                                    className={`w-full text-left px-3 py-2 md:px-2 md:py-1.5 text-sm md:text-xs rounded transition-colors 
                                                                                ${selectedRule === item ? 'bg-indigo-600 text-white font-bold shadow-md' : 'bg-slate-900/50 text-slate-400 hover:bg-slate-700'}`}>
                                                                    {item.title}
                                                                </button>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>);
                                            })}
                                        </div>
                                    </div>
                                    <div class={`flex-1 bg-slate-800/50 border border-slate-700 rounded-xl p-4 md:p-6 overflow-y-auto flex-col items-start shadow-inner ${selectedRule ? 'flex' : 'hidden md:flex'}`}>
                                        {selectedRule ? (<div class="w-full animate-fade-in"><button onClick={() => setSelectedRule(null)} class="md:hidden mb-4 flex items-center gap-2 text-xs font-bold text-indigo-300 bg-slate-900/80 px-3 py-2 rounded-lg border border-slate-700 w-full justify-center">Back to Index</button><div class="inline-block px-3 py-1 bg-indigo-900/50 text-indigo-300 text-[10px] font-bold uppercase tracking-widest rounded-full mb-3 border border-indigo-500/30">Rule Details</div><h2 class="text-2xl md:text-3xl font-bold text-white mb-4 border-b border-slate-700 pb-4">{selectedRule.title}</h2><div class="prose prose-invert max-w-none text-slate-300 leading-loose text-base md:text-lg whitespace-pre-wrap">{selectedRule.text}</div></div>) : (<div class="w-full h-full flex flex-col items-center justify-center text-slate-600 opacity-50 select-none"><Grid size={64} strokeWidth={1} class="mb-4 text-slate-700"/><p class="text-xl font-serif italic text-center">Select a rule from the index<br/>to view details.</p></div>)}
                                    </div>
                                </div>
                            )}
                        </main>
                    </div>

                    {/* MODALS (Settings & Help) */}
                    {showSettingsModal && (<div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm"><div className="bg-gray-900 w-full max-w-md rounded-xl shadow-2xl border border-gray-700 flex flex-col"><div className="flex justify-between items-center p-4 border-b border-gray-700"><h2 className="text-xl font-bold text-white flex items-center gap-2"><Settings className="text-slate-400" /> Settings</h2><button onClick={() => setShowSettingsModal(false)} className="text-slate-400 hover:text-white"><X size={24} /></button></div><div className="p-6"><label className="block text-sm font-bold text-white mb-2 flex items-center gap-2"><Key size={16} className="text-yellow-500" /> Gemini API Key</label><input type="password" placeholder="Paste your key here..." className="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none mb-2" value={userApiKey} onChange={(e) => setUserApiKey(e.target.value)} /><p className="text-xs text-slate-400 mb-4">The AI features require a Google Gemini API Key. Stored locally.<br/><br/><a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noreferrer" className="text-indigo-400 underline hover:text-indigo-300">Get a free API Key here</a></p><div className="flex justify-end"><button onClick={() => {setShowSettingsModal(false); showNotification("Settings saved!", "success");}} className="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded font-bold">Save & Close</button></div></div></div></div>)}
                </div>
            );
        }
        
        // --- Global Root variable for the one-time root creation ---
        let reactRoot = null;

        window.onload = function() {
            const renderApp = () => {
                try {
                    const rootElement = document.getElementById('root');
                    if (rootElement) {
                         // Check if window.firebase is available before rendering App
                         if (window.db && window.firebase && window.firebase.collection) {
                             if (!reactRoot) {
                                 // Create root only once
                                 reactRoot = ReactDOM.createRoot(rootElement);
                             }
                             // Render/update the app on the existing root
                             reactRoot.render(<ErrorBoundary><App /></ErrorBoundary>);
                         } else {
                             // This path indicates Firebase setup failed or the module script didn't run properly.
                             console.error("Firebase functions not exposed to window.firebase object. Cannot initialize App.");
                             rootElement.innerHTML = `<div class="p-8 text-center"><h2 class="text-xl font-bold text-red-500">Initialization Error</h2><p class="text-slate-400 mt-2">The database connection failed to start. Please check the console for details.</p></div>`;
                         }
                    } else { throw new Error("Root element not found."); }
                } catch (e) { console.error("React Mounting Failed:", e); document.getElementById('root').innerHTML = `<div class="text-white text-center mt-20">Failed to load app. Check console.</div>`; }
            };
            
            // Wait for the DOM and then start the rendering process
            document.addEventListener('auth-ready', () => {
                // Ensure rendering logic runs after the Firebase/Auth setup is complete
                renderApp();
            });

            // Initial render call in case 'auth-ready' fires too quickly, 
            // but rely on 'auth-ready' for subsequent state updates.
            // A small timeout helps ensure Firebase script has executed initially.
            setTimeout(() => {
                if (window.isAuthReady) {
                    renderApp();
                }
            }, 100);
        };
    </script>
</body>

</html>